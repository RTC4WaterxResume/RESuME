!function(e,t){"function"==typeof define&&define.amd?define(e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e():t.rangy=e()}(function(){function e(e,t){var n=typeof e[t];return n==N||!(n!=C||!e[t])||"unknown"==n}function t(e,t){return!(typeof e[t]!=C||!e[t])}function n(e,t){return typeof e[t]!=E}function r(e){return function(t,n){for(var r=n.length;r--;)if(!e(t,n[r]))return!1;return!0}}function i(e){return e&&A(e,w)&&x(e,S)}function o(e){return t(e,"body")?e.body:e.getElementsByTagName("body")[0]}function a(t){typeof console!=E&&e(console,"log")&&console.log(t)}function s(e,t){D&&t?alert(e):a(e)}function c(e){P.initialized=!0,P.supported=!1,s("Rangy is not supported in this environment. Reason: "+e,P.config.alertOnFail)}function l(e){s("Rangy warning: "+e,P.config.alertOnWarn)}function u(e){return e.message||e.description||String(e)}function f(){if(D&&!P.initialized){var t,n=!1,r=!1;e(document,"createRange")&&(t=document.createRange(),A(t,T)&&x(t,y)&&(n=!0));var s=o(document);if(!s||"body"!=s.nodeName.toLowerCase())return void c("No body element found");if(s&&e(s,"createTextRange")&&(t=s.createTextRange(),i(t)&&(r=!0)),!n&&!r)return void c("Neither Range nor TextRange are available");P.initialized=!0,P.features={implementsDomRange:n,implementsTextRange:r};var l,f;for(var d in _)(l=_[d])instanceof p&&l.init(l,P);for(var h=0,g=B.length;h<g;++h)try{B[h](P)}catch(m){f="Rangy init listener threw an exception. Continuing. Detail: "+u(m),a(f)}}}function d(e,t,n){n&&(e+=" in module "+n.name),P.warn("DEPRECATED: "+e+" is deprecated. Please use "+t+" instead.")}function h(e,t,n,r){e[t]=function(){return d(t,n,r),e[n].apply(e,I.toArray(arguments))}}function g(e){e=e||window,f();for(var t=0,n=W.length;t<n;++t)W[t](e)}function p(e,t,n){this.name=e,this.dependencies=t,this.initialized=!1,this.supported=!1,this.initializer=n}function m(e,t,n){var r=new p(e,t,function(t){if(!t.initialized){t.initialized=!0;try{n(P,t),t.supported=!0}catch(r){var i="Module '"+e+"' failed to load: "+u(r);a(i),r.stack&&a(r.stack)}}});return _[e]=r,r}function v(){}function R(){}var C="object",N="function",E="undefined",y=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],T=["setStart","setStartBefore","setStartAfter","setEnd","setEndBefore","setEndAfter","collapse","selectNode","selectNodeContents","compareBoundaryPoints","deleteContents","extractContents","cloneContents","insertNode","surroundContents","cloneRange","toString","detach"],S=["boundingHeight","boundingLeft","boundingTop","boundingWidth","htmlText","text"],w=["collapse","compareEndPoints","duplicate","moveToElementText","parentElement","select","setEndPoint","getBoundingClientRect"],A=r(e),O=r(t),x=r(n),b=[].forEach?function(e,t){e.forEach(t)}:function(e,t){for(var n=0,r=e.length;n<r;++n)t(e[n],n)},_={},D=typeof window!=E&&typeof document!=E,I={isHostMethod:e,isHostObject:t,isHostProperty:n,areHostMethods:A,areHostObjects:O,areHostProperties:x,isTextRange:i,getBody:o,forEach:b},P={version:"1.3.0",initialized:!1,isBrowser:D,supported:!0,util:I,features:{},modules:_,config:{alertOnFail:!1,alertOnWarn:!1,preferTextRange:!1,autoInitialize:typeof rangyAutoInitialize==E||rangyAutoInitialize}};P.fail=c,P.warn=l;var H;({}).hasOwnProperty?(I.extend=H=function(e,t,n){var r,i;for(var o in t)t.hasOwnProperty(o)&&(r=e[o],i=t[o],n&&null!==r&&"object"==typeof r&&null!==i&&"object"==typeof i&&H(r,i,!0),e[o]=i);return t.hasOwnProperty("toString")&&(e.toString=t.toString),e},I.createOptions=function(e,t){var n={};return H(n,t),e&&H(n,e),n}):c("hasOwnProperty not supported"),D||c("Rangy can only run in a browser"),function(){var e;if(D){var t=document.createElement("div");t.appendChild(document.createElement("span"));var n=[].slice;try{1==n.call(t.childNodes,0)[0].nodeType&&(e=function(e){return n.call(e,0)})}catch(r){}}e||(e=function(e){for(var t=[],n=0,r=e.length;n<r;++n)t[n]=e[n];return t}),I.toArray=e}();var M;D&&(e(document,"addEventListener")?M=function(e,t,n){e.addEventListener(t,n,!1)}:e(document,"attachEvent")?M=function(e,t,n){e.attachEvent("on"+t,n)}:c("Document does not have required addEventListener or attachEvent method"),I.addListener=M);var B=[];I.deprecationNotice=d,I.createAliasForDeprecatedMethod=h,P.init=f,P.addInitListener=function(e){P.initialized?e(P):B.push(e)};var W=[];P.addShimListener=function(e){W.push(e)},D&&(P.shim=P.createMissingNativeApi=g,h(P,"createMissingNativeApi","shim")),p.prototype={init:function(){for(var e,t,n=this.dependencies||[],r=0,i=n.length;r<i;++r){if(t=n[r],e=_[t],!(e&&e instanceof p))throw new Error("required module '"+t+"' not found");if(e.init(),!e.supported)throw new Error("required module '"+t+"' not supported")}this.initializer(this)},fail:function(e){throw this.initialized=!0,this.supported=!1,new Error(e)},warn:function(e){P.warn("Module "+this.name+": "+e)},deprecationNotice:function(e,t){P.warn("DEPRECATED: "+e+" in module "+this.name+" is deprecated. Please use "+t+" instead")},createError:function(e){return new Error("Error in Rangy "+this.name+" module: "+e)}},P.createModule=function(e){var t,n;2==arguments.length?(t=arguments[1],n=[]):(t=arguments[2],n=arguments[1]);var r=m(e,n,t);P.initialized&&P.supported&&r.init()},P.createCoreModule=function(e,t,n){m(e,t,n)},P.RangePrototype=v,P.rangePrototype=new v,P.selectionPrototype=new R,P.createCoreModule("DomUtil",[],function(e,t){function n(e){var t;return typeof e.namespaceURI==D||null===(t=e.namespaceURI)||"http://www.w3.org/1999/xhtml"==t}function r(e){var t=e.parentNode;return 1==t.nodeType?t:null}function i(e){for(var t=0;e=e.previousSibling;)++t;return t}function o(e){switch(e.nodeType){case 7:case 10:return 0;case 3:case 8:return e.length;default:return e.childNodes.length}}function a(e,t){var n,r=[];for(n=e;n;n=n.parentNode)r.push(n);for(n=t;n;n=n.parentNode)if(B(r,n))return n;return null}function s(e,t,n){for(var r=n?t:t.parentNode;r;){if(r===e)return!0;r=r.parentNode}return!1}function c(e,t){return s(e,t,!0)}function l(e,t,n){for(var r,i=n?e:e.parentNode;i;){if(r=i.parentNode,r===t)return i;i=r}return null}function u(e){var t=e.nodeType;return 3==t||4==t||8==t}function f(e){if(!e)return!1;var t=e.nodeType;return 3==t||8==t}function d(e,t){var n=t.nextSibling,r=t.parentNode;return n?r.insertBefore(e,n):r.appendChild(e),e}function h(e,t,n){var r=e.cloneNode(!1);if(r.deleteData(0,t),e.deleteData(t,e.length-t),d(r,e),n)for(var o,a=0;o=n[a++];)o.node==e&&o.offset>t?(o.node=r,o.offset-=t):o.node==e.parentNode&&o.offset>i(e)&&++o.offset;return r}function g(e){if(9==e.nodeType)return e;if(typeof e.ownerDocument!=D)return e.ownerDocument;if(typeof e.document!=D)return e.document;if(e.parentNode)return g(e.parentNode);throw t.createError("getDocument: no document found for node")}function p(e){var n=g(e);if(typeof n.defaultView!=D)return n.defaultView;if(typeof n.parentWindow!=D)return n.parentWindow;throw t.createError("Cannot get a window object for node")}function m(e){if(typeof e.contentDocument!=D)return e.contentDocument;if(typeof e.contentWindow!=D)return e.contentWindow.document;throw t.createError("getIframeDocument: No Document object found for iframe element")}function v(e){if(typeof e.contentWindow!=D)return e.contentWindow;if(typeof e.contentDocument!=D)return e.contentDocument.defaultView;throw t.createError("getIframeWindow: No Window object found for iframe element")}function R(e){return e&&I.isHostMethod(e,"setTimeout")&&I.isHostObject(e,"document")}function C(e,t,n){var r;if(e?I.isHostProperty(e,"nodeType")?r=1==e.nodeType&&"iframe"==e.tagName.toLowerCase()?m(e):g(e):R(e)&&(r=e.document):r=document,!r)throw t.createError(n+"(): Parameter must be a Window object or DOM node");return r}function N(e){for(var t;t=e.parentNode;)e=t;return e}function E(e,n,r,o){var s,c,u,f,d;if(e==r)return n===o?0:n<o?-1:1;if(s=l(r,e,!0))return n<=i(s)?-1:1;if(s=l(e,r,!0))return i(s)<o?-1:1;if(c=a(e,r),!c)throw new Error("comparePoints error: nodes have no common ancestor");if(u=e===c?c:l(e,c,!0),f=r===c?c:l(r,c,!0),u===f)throw t.createError("comparePoints got to case 4 and childA and childB are the same!");for(d=c.firstChild;d;){if(d===u)return-1;if(d===f)return 1;d=d.nextSibling}}function y(e){var t;try{return t=e.parentNode,!1}catch(n){return!0}}function T(e){if(!e)return"[No node]";if(W&&y(e))return"[Broken node]";if(u(e))return'"'+e.data+'"';if(1==e.nodeType){var t=e.id?' id="'+e.id+'"':"";return"<"+e.nodeName+t+">[index:"+i(e)+",length:"+e.childNodes.length+"]["+(e.innerHTML||"[innerHTML not supported]").slice(0,25)+"]"}return e.nodeName}function S(e){for(var t,n=g(e).createDocumentFragment();t=e.firstChild;)n.appendChild(t);return n}function w(e,t,n){var r=P(e),i=e.createElement("div");i.contentEditable=""+!!n,t&&(i.innerHTML=t);var o=r.firstChild;return o?r.insertBefore(i,o):r.appendChild(i),i}function A(e){return e.parentNode.removeChild(e)}function O(e){this.root=e,this._next=e}function x(e){return new O(e)}function b(e,t){this.node=e,this.offset=t}function _(e){this.code=this[e],this.codeName=e,this.message="DOMException: "+this.codeName}var D="undefined",I=e.util,P=I.getBody;I.areHostMethods(document,["createDocumentFragment","createElement","createTextNode"])||t.fail("document missing a Node creation method"),I.isHostMethod(document,"getElementsByTagName")||t.fail("document missing getElementsByTagName method");var H=document.createElement("div");I.areHostMethods(H,["insertBefore","appendChild","cloneNode"]||!I.areHostObjects(H,["previousSibling","nextSibling","childNodes","parentNode"]))||t.fail("Incomplete Element implementation"),I.isHostProperty(H,"innerHTML")||t.fail("Element is missing innerHTML property");var M=document.createTextNode("test");I.areHostMethods(M,["splitText","deleteData","insertData","appendData","cloneNode"]||!I.areHostObjects(H,["previousSibling","nextSibling","childNodes","parentNode"])||!I.areHostProperties(M,["data"]))||t.fail("Incomplete Text Node implementation");var B=function(e,t){for(var n=e.length;n--;)if(e[n]===t)return!0;return!1},W=!1;!function(){var t=document.createElement("b");t.innerHTML="1";var n=t.firstChild;t.innerHTML="<br />",W=y(n),e.features.crashyTextNodes=W}();var L;typeof window.getComputedStyle!=D?L=function(e,t){return p(e).getComputedStyle(e,null)[t]}:typeof document.documentElement.currentStyle!=D?L=function(e,t){return e.currentStyle?e.currentStyle[t]:""}:t.fail("No means of obtaining computed style properties found"),O.prototype={_current:null,hasNext:function(){return!!this._next},next:function(){var e,t,n=this._current=this._next;if(this._current)if(e=n.firstChild)this._next=e;else{for(t=null;n!==this.root&&!(t=n.nextSibling);)n=n.parentNode;this._next=t}return this._current},detach:function(){this._current=this._next=this.root=null}},b.prototype={equals:function(e){return!!e&&this.node===e.node&&this.offset==e.offset},inspect:function(){return"[DomPosition("+T(this.node)+":"+this.offset+")]"},toString:function(){return this.inspect()}},_.prototype={INDEX_SIZE_ERR:1,HIERARCHY_REQUEST_ERR:3,WRONG_DOCUMENT_ERR:4,NO_MODIFICATION_ALLOWED_ERR:7,NOT_FOUND_ERR:8,NOT_SUPPORTED_ERR:9,INVALID_STATE_ERR:11,INVALID_NODE_TYPE_ERR:24},_.prototype.toString=function(){return this.message},e.dom={arrayContains:B,isHtmlNamespace:n,parentElement:r,getNodeIndex:i,getNodeLength:o,getCommonAncestor:a,isAncestorOf:s,isOrIsAncestorOf:c,getClosestAncestorIn:l,isCharacterDataNode:u,isTextOrCommentNode:f,insertAfter:d,splitDataNode:h,getDocument:g,getWindow:p,getIframeWindow:v,getIframeDocument:m,getBody:P,isWindow:R,getContentDocument:C,getRootContainer:N,comparePoints:E,isBrokenNode:y,inspectNode:T,getComputedStyleProperty:L,createTestElement:w,removeNode:A,fragmentFromNodeChildren:S,createIterator:x,DomPosition:b},e.DOMException=_}),P.createCoreModule("DomRange",["DomUtil"],function(e,t){function n(e,t){return 3!=e.nodeType&&(j(e,t.startContainer)||j(e,t.endContainer))}function r(e){return e.document||z(e.startContainer)}function i(e){return Q(e.startContainer)}function o(e){return new W(e.parentNode,F(e))}function a(e){return new W(e.parentNode,F(e)+1)}function s(e,t,n){var r=11==e.nodeType?e.firstChild:e;return k(t)?n==t.length?M.insertAfter(e,t):t.parentNode.insertBefore(e,0==n?t:V(t,n)):n>=t.childNodes.length?t.appendChild(e):t.insertBefore(e,t.childNodes[n]),r}function c(e,t,n){if(w(e),w(t),r(t)!=r(e))throw new L("WRONG_DOCUMENT_ERR");var i=U(e.startContainer,e.startOffset,t.endContainer,t.endOffset),o=U(e.endContainer,e.endOffset,t.startContainer,t.startOffset);return n?i<=0&&o>=0:i<0&&o>0}function l(e){for(var t,n,i,o=r(e.range).createDocumentFragment();n=e.next();){if(t=e.isPartiallySelectedSubtree(),n=n.cloneNode(!t),t&&(i=e.getSubtreeIterator(),n.appendChild(l(i)),i.detach()),10==n.nodeType)throw new L("HIERARCHY_REQUEST_ERR");o.appendChild(n)}return o}function u(e,t,n){var r,i;n=n||{stop:!1};for(var o,a;o=e.next();)if(e.isPartiallySelectedSubtree()){if(t(o)===!1)return void(n.stop=!0);if(a=e.getSubtreeIterator(),u(a,t,n),a.detach(),n.stop)return}else for(r=M.createIterator(o);i=r.next();)if(t(i)===!1)return void(n.stop=!0)}function f(e){for(var t;e.next();)e.isPartiallySelectedSubtree()?(t=e.getSubtreeIterator(),f(t),t.detach()):e.remove()}function d(e){for(var t,n,i=r(e.range).createDocumentFragment();t=e.next();){if(e.isPartiallySelectedSubtree()?(t=t.cloneNode(!1),n=e.getSubtreeIterator(),t.appendChild(d(n)),n.detach()):e.remove(),10==t.nodeType)throw new L("HIERARCHY_REQUEST_ERR");i.appendChild(t)}return i}function h(e,t,n){var r,i=!(!t||!t.length),o=!!n;i&&(r=new RegExp("^("+t.join("|")+")$"));var a=[];return u(new p(e,(!1)),function(t){if((!i||r.test(t.nodeType))&&(!o||n(t))){var s=e.startContainer;if(t!=s||!k(s)||e.startOffset!=s.length){var c=e.endContainer;t==c&&k(c)&&0==e.endOffset||a.push(t)}}}),a}function g(e){var t="undefined"==typeof e.getName?"Range":e.getName();return"["+t+"("+M.inspectNode(e.startContainer)+":"+e.startOffset+", "+M.inspectNode(e.endContainer)+":"+e.endOffset+")]"}function p(e,t){if(this.range=e,this.clonePartiallySelectedTextNodes=t,!e.collapsed){this.sc=e.startContainer,this.so=e.startOffset,this.ec=e.endContainer,this.eo=e.endOffset;var n=e.commonAncestorContainer;this.sc===this.ec&&k(this.sc)?(this.isSingleCharacterDataNode=!0,this._first=this._last=this._next=this.sc):(this._first=this._next=this.sc!==n||k(this.sc)?q(this.sc,n,!0):this.sc.childNodes[this.so],this._last=this.ec!==n||k(this.ec)?q(this.ec,n,!0):this.ec.childNodes[this.eo-1])}}function m(e){return function(t,n){for(var r,i=n?t:t.parentNode;i;){if(r=i.nodeType,Y(e,r))return i;i=i.parentNode}return null}}function v(e,t){if(ie(e,t))throw new L("INVALID_NODE_TYPE_ERR")}function R(e,t){if(!Y(t,e.nodeType))throw new L("INVALID_NODE_TYPE_ERR")}function C(e,t){if(t<0||t>(k(e)?e.length:e.childNodes.length))throw new L("INDEX_SIZE_ERR")}function N(e,t){if(ne(e,!0)!==ne(t,!0))throw new L("WRONG_DOCUMENT_ERR")}function E(e){if(re(e,!0))throw new L("NO_MODIFICATION_ALLOWED_ERR")}function y(e,t){if(!e)throw new L(t)}function T(e,t){return t<=(k(e)?e.length:e.childNodes.length)}function S(e){return!!e.startContainer&&!!e.endContainer&&!(G&&(M.isBrokenNode(e.startContainer)||M.isBrokenNode(e.endContainer)))&&Q(e.startContainer)==Q(e.endContainer)&&T(e.startContainer,e.startOffset)&&T(e.endContainer,e.endOffset)}function w(e){if(!S(e))throw new Error("Range error: Range is not valid. This usually happens after DOM mutation. Range: ("+e.inspect()+")")}function A(e,t){w(e);var n=e.startContainer,r=e.startOffset,i=e.endContainer,o=e.endOffset,a=n===i;k(i)&&o>0&&o<i.length&&V(i,o,t),k(n)&&r>0&&r<n.length&&(n=V(n,r,t),a?(o-=r,i=n):i==n.parentNode&&o>=F(n)&&o++,r=0),e.setStartAndEnd(n,r,i,o)}function O(e){w(e);var t=e.commonAncestorContainer.parentNode.cloneNode(!1);return t.appendChild(e.cloneContents()),t.innerHTML}function x(e){e.START_TO_START=ue,e.START_TO_END=fe,e.END_TO_END=de,e.END_TO_START=he,e.NODE_BEFORE=ge,e.NODE_AFTER=pe,e.NODE_BEFORE_AND_AFTER=me,e.NODE_INSIDE=ve}function b(e){x(e),x(e.prototype)}function _(e,t){return function(){w(this);var n,r,i=this.startContainer,o=this.startOffset,s=this.commonAncestorContainer,c=new p(this,(!0));i!==s&&(n=q(i,s,!0),r=a(n),i=r.node,o=r.offset),u(c,E),c.reset();var l=e(c);return c.detach(),t(this,i,o,i,o),l}}function D(t,r){function i(e,t){return function(n){R(n,Z),R(Q(n),J);var r=(e?o:a)(n);(t?s:c)(this,r.node,r.offset)}}function s(e,t,n){var i=e.endContainer,o=e.endOffset;t===e.startContainer&&n===e.startOffset||(Q(t)==Q(i)&&1!=U(t,n,i,o)||(i=t,o=n),r(e,t,n,i,o))}function c(e,t,n){var i=e.startContainer,o=e.startOffset;t===e.endContainer&&n===e.endOffset||(Q(t)==Q(i)&&U(t,n,i,o)!=-1||(i=t,o=n),r(e,i,o,t,n))}var l=function(){};l.prototype=e.rangePrototype,t.prototype=new l,B.extend(t.prototype,{setStart:function(e,t){v(e,!0),C(e,t),s(this,e,t)},setEnd:function(e,t){v(e,!0),C(e,t),c(this,e,t)},setStartAndEnd:function(){var e=arguments,t=e[0],n=e[1],i=t,o=n;switch(e.length){case 3:o=e[2];break;case 4:i=e[2],o=e[3]}r(this,t,n,i,o)},setBoundary:function(e,t,n){this["set"+(n?"Start":"End")](e,t)},setStartBefore:i(!0,!0),setStartAfter:i(!1,!0),setEndBefore:i(!0,!1),setEndAfter:i(!1,!1),collapse:function(e){w(this),e?r(this,this.startContainer,this.startOffset,this.startContainer,this.startOffset):r(this,this.endContainer,this.endOffset,this.endContainer,this.endOffset)},selectNodeContents:function(e){v(e,!0),r(this,e,0,e,$(e))},selectNode:function(e){v(e,!1),R(e,Z);var t=o(e),n=a(e);r(this,t.node,t.offset,n.node,n.offset)},extractContents:_(d,r),deleteContents:_(f,r),canSurroundContents:function(){w(this),E(this.startContainer),E(this.endContainer);var e=new p(this,(!0)),t=e._first&&n(e._first,this)||e._last&&n(e._last,this);return e.detach(),!t},splitBoundaries:function(){A(this)},splitBoundariesPreservingPositions:function(e){A(this,e)},normalizeBoundaries:function(){w(this);var e,t=this.startContainer,n=this.startOffset,i=this.endContainer,o=this.endOffset,a=function(e){var t=e.nextSibling;t&&t.nodeType==e.nodeType&&(i=e,o=e.length,e.appendData(t.data),X(t))},s=function(e){var r=e.previousSibling;if(r&&r.nodeType==e.nodeType){t=e;var a=e.length;if(n=r.length,e.insertData(0,r.data),X(r),t==i)o+=n,i=t;else if(i==e.parentNode){var s=F(e);o==s?(i=e,o=a):o>s&&o--}}},c=!0;if(k(i))o==i.length?a(i):0==o&&(e=i.previousSibling,e&&e.nodeType==i.nodeType&&(o=e.length,t==i&&(c=!1),e.appendData(i.data),X(i),i=e));else{if(o>0){var l=i.childNodes[o-1];l&&k(l)&&a(l)}c=!this.collapsed}if(c){if(k(t))0==n?s(t):n==t.length&&(e=t.nextSibling,e&&e.nodeType==t.nodeType&&(i==e&&(i=t,o+=t.length),t.appendData(e.data),X(e)));else if(n<t.childNodes.length){var u=t.childNodes[n];u&&k(u)&&s(u)}}else t=i,n=o;r(this,t,n,i,o)},collapseToPoint:function(e,t){v(e,!0),C(e,t),this.setStartAndEnd(e,t)}}),b(t)}function I(e){e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset,e.commonAncestorContainer=e.collapsed?e.startContainer:M.getCommonAncestor(e.startContainer,e.endContainer)}function P(e,t,n,r,i){e.startContainer=t,e.startOffset=n,e.endContainer=r,e.endOffset=i,e.document=M.getDocument(t),I(e)}function H(e){this.startContainer=e,this.startOffset=0,this.endContainer=e,this.endOffset=0,this.document=e,I(this)}var M=e.dom,B=e.util,W=M.DomPosition,L=e.DOMException,k=M.isCharacterDataNode,F=M.getNodeIndex,j=M.isOrIsAncestorOf,z=M.getDocument,U=M.comparePoints,V=M.splitDataNode,q=M.getClosestAncestorIn,$=M.getNodeLength,Y=M.arrayContains,Q=M.getRootContainer,G=e.features.crashyTextNodes,X=M.removeNode;p.prototype={_current:null,_next:null,_first:null,_last:null,isSingleCharacterDataNode:!1,reset:function(){this._current=null,this._next=this._first},hasNext:function(){return!!this._next},next:function(){var e=this._current=this._next;return e&&(this._next=e!==this._last?e.nextSibling:null,k(e)&&this.clonePartiallySelectedTextNodes&&(e===this.ec&&(e=e.cloneNode(!0)).deleteData(this.eo,e.length-this.eo),this._current===this.sc&&(e=e.cloneNode(!0)).deleteData(0,this.so))),e},remove:function(){var e,t,n=this._current;!k(n)||n!==this.sc&&n!==this.ec?n.parentNode&&X(n):(e=n===this.sc?this.so:0,t=n===this.ec?this.eo:n.length,e!=t&&n.deleteData(e,t-e))},isPartiallySelectedSubtree:function(){var e=this._current;return n(e,this.range)},getSubtreeIterator:function(){var e;if(this.isSingleCharacterDataNode)e=this.range.cloneRange(),e.collapse(!1);else{e=new H(r(this.range));var t=this._current,n=t,i=0,o=t,a=$(t);j(t,this.sc)&&(n=this.sc,i=this.so),j(t,this.ec)&&(o=this.ec,a=this.eo),P(e,n,i,o,a)}return new p(e,this.clonePartiallySelectedTextNodes)},detach:function(){this.range=this._current=this._next=this._first=this._last=this.sc=this.so=this.ec=this.eo=null}};var Z=[1,3,4,5,7,8,10],J=[2,9,11],K=[5,6,10,12],ee=[1,3,4,5,7,8,10,11],te=[1,3,4,5,7,8],ne=m([9,11]),re=m(K),ie=m([6,10,12]),oe=document.createElement("style"),ae=!1;try{oe.innerHTML="<b>x</b>",ae=3==oe.firstChild.nodeType}catch(se){}e.features.htmlParsingConforms=ae;var ce=ae?function(e){var t=this.startContainer,n=z(t);if(!t)throw new L("INVALID_STATE_ERR");var r=null;return 1==t.nodeType?r=t:k(t)&&(r=M.parentElement(t)),r=null===r||"HTML"==r.nodeName&&M.isHtmlNamespace(z(r).documentElement)&&M.isHtmlNamespace(r)?n.createElement("body"):r.cloneNode(!1),r.innerHTML=e,M.fragmentFromNodeChildren(r)}:function(e){var t=r(this),n=t.createElement("body");return n.innerHTML=e,M.fragmentFromNodeChildren(n)},le=["startContainer","startOffset","endContainer","endOffset","collapsed","commonAncestorContainer"],ue=0,fe=1,de=2,he=3,ge=0,pe=1,me=2,ve=3;B.extend(e.rangePrototype,{compareBoundaryPoints:function(e,t){w(this),N(this.startContainer,t.startContainer);var n,r,i,o,a=e==he||e==ue?"start":"end",s=e==fe||e==ue?"start":"end";return n=this[a+"Container"],r=this[a+"Offset"],i=t[s+"Container"],o=t[s+"Offset"],U(n,r,i,o)},insertNode:function(e){if(w(this),R(e,ee),E(this.startContainer),j(e,this.startContainer))throw new L("HIERARCHY_REQUEST_ERR");var t=s(e,this.startContainer,this.startOffset);this.setStartBefore(t)},cloneContents:function(){w(this);var e,t;if(this.collapsed)return r(this).createDocumentFragment();if(this.startContainer===this.endContainer&&k(this.startContainer))return e=this.startContainer.cloneNode(!0),e.data=e.data.slice(this.startOffset,this.endOffset),t=r(this).createDocumentFragment(),t.appendChild(e),t;var n=new p(this,(!0));return e=l(n),n.detach(),e},canSurroundContents:function(){w(this),E(this.startContainer),E(this.endContainer);var e=new p(this,(!0)),t=e._first&&n(e._first,this)||e._last&&n(e._last,this);return e.detach(),!t},surroundContents:function(e){if(R(e,te),!this.canSurroundContents())throw new L("INVALID_STATE_ERR");var t=this.extractContents();if(e.hasChildNodes())for(;e.lastChild;)e.removeChild(e.lastChild);s(e,this.startContainer,this.startOffset),e.appendChild(t),this.selectNode(e)},cloneRange:function(){w(this);for(var e,t=new H(r(this)),n=le.length;n--;)e=le[n],t[e]=this[e];return t},toString:function(){w(this);var e=this.startContainer;if(e===this.endContainer&&k(e))return 3==e.nodeType||4==e.nodeType?e.data.slice(this.startOffset,this.endOffset):"";var t=[],n=new p(this,(!0));return u(n,function(e){3!=e.nodeType&&4!=e.nodeType||t.push(e.data)}),n.detach(),t.join("")},compareNode:function(e){w(this);var t=e.parentNode,n=F(e);if(!t)throw new L("NOT_FOUND_ERR");var r=this.comparePoint(t,n),i=this.comparePoint(t,n+1);return r<0?i>0?me:ge:i>0?pe:ve},comparePoint:function(e,t){return w(this),y(e,"HIERARCHY_REQUEST_ERR"),N(e,this.startContainer),U(e,t,this.startContainer,this.startOffset)<0?-1:U(e,t,this.endContainer,this.endOffset)>0?1:0},createContextualFragment:ce,toHtml:function(){return O(this)},intersectsNode:function(e,t){if(w(this),Q(e)!=i(this))return!1;var n=e.parentNode,r=F(e);if(!n)return!0;var o=U(n,r,this.endContainer,this.endOffset),a=U(n,r+1,this.startContainer,this.startOffset);return t?o<=0&&a>=0:o<0&&a>0},isPointInRange:function(e,t){return w(this),y(e,"HIERARCHY_REQUEST_ERR"),N(e,this.startContainer),U(e,t,this.startContainer,this.startOffset)>=0&&U(e,t,this.endContainer,this.endOffset)<=0},intersectsRange:function(e){return c(this,e,!1)},intersectsOrTouchesRange:function(e){return c(this,e,!0)},intersection:function(e){if(this.intersectsRange(e)){var t=U(this.startContainer,this.startOffset,e.startContainer,e.startOffset),n=U(this.endContainer,this.endOffset,e.endContainer,e.endOffset),r=this.cloneRange();return t==-1&&r.setStart(e.startContainer,e.startOffset),1==n&&r.setEnd(e.endContainer,e.endOffset),r}return null},union:function(e){if(this.intersectsOrTouchesRange(e)){var t=this.cloneRange();return U(e.startContainer,e.startOffset,this.startContainer,this.startOffset)==-1&&t.setStart(e.startContainer,e.startOffset),1==U(e.endContainer,e.endOffset,this.endContainer,this.endOffset)&&t.setEnd(e.endContainer,e.endOffset),t}throw new L("Ranges do not intersect")},containsNode:function(e,t){return t?this.intersectsNode(e,!1):this.compareNode(e)==ve},containsNodeContents:function(e){return this.comparePoint(e,0)>=0&&this.comparePoint(e,$(e))<=0},containsRange:function(e){var t=this.intersection(e);return null!==t&&e.equals(t)},containsNodeText:function(e){var t=this.cloneRange();t.selectNode(e);var n=t.getNodes([3]);if(n.length>0){t.setStart(n[0],0);var r=n.pop();return t.setEnd(r,r.length),this.containsRange(t)}return this.containsNodeContents(e)},getNodes:function(e,t){return w(this),h(this,e,t)},getDocument:function(){return r(this)},collapseBefore:function(e){this.setEndBefore(e),this.collapse(!1)},collapseAfter:function(e){this.setStartAfter(e),this.collapse(!0)},getBookmark:function(t){var n=r(this),i=e.createRange(n);t=t||M.getBody(n),i.selectNodeContents(t);var o=this.intersection(i),a=0,s=0;return o&&(i.setEnd(o.startContainer,o.startOffset),a=i.toString().length,s=a+o.toString().length),{start:a,end:s,containerNode:t}},moveToBookmark:function(e){var t=e.containerNode,n=0;this.setStart(t,0),this.collapse(!0);for(var r,i,o,a,s=[t],c=!1,l=!1;!l&&(r=s.pop());)if(3==r.nodeType)i=n+r.length,!c&&e.start>=n&&e.start<=i&&(this.setStart(r,e.start-n),c=!0),c&&e.end>=n&&e.end<=i&&(this.setEnd(r,e.end-n),l=!0),n=i;else for(a=r.childNodes,o=a.length;o--;)s.push(a[o])},getName:function(){return"DomRange"},equals:function(e){return H.rangesEqual(this,e)},isValid:function(){return S(this)},inspect:function(){return g(this)},detach:function(){}}),D(H,P),B.extend(H,{rangeProperties:le,RangeIterator:p,copyComparisonConstants:b,createPrototypeRange:D,inspect:g,toHtml:O,getRangeDocument:r,rangesEqual:function(e,t){return e.startContainer===t.startContainer&&e.startOffset===t.startOffset&&e.endContainer===t.endContainer&&e.endOffset===t.endOffset}}),e.DomRange=H}),P.createCoreModule("WrappedRange",["DomRange"],function(e,t){var n,r,i=e.dom,o=e.util,a=i.DomPosition,s=e.DomRange,c=i.getBody,l=i.getContentDocument,u=i.isCharacterDataNode;if(e.features.implementsDomRange&&!function(){function r(e){for(var t,n=d.length;n--;)t=d[n],e[t]=e.nativeRange[t];e.collapsed=e.startContainer===e.endContainer&&e.startOffset===e.endOffset}function a(e,t,n,r,i){var o=e.startContainer!==t||e.startOffset!=n,a=e.endContainer!==r||e.endOffset!=i,s=!e.equals(e.nativeRange);(o||a||s)&&(e.setEnd(r,i),e.setStart(t,n))}var u,f,d=s.rangeProperties;n=function(e){if(!e)throw t.createError("WrappedRange: Range must be specified");this.nativeRange=e,r(this)},s.createPrototypeRange(n,a),u=n.prototype,u.selectNode=function(e){this.nativeRange.selectNode(e),r(this)},u.cloneContents=function(){return this.nativeRange.cloneContents()},u.surroundContents=function(e){this.nativeRange.surroundContents(e),r(this)},u.collapse=function(e){this.nativeRange.collapse(e),r(this)},u.cloneRange=function(){return new n(this.nativeRange.cloneRange())},u.refresh=function(){r(this)},u.toString=function(){return this.nativeRange.toString()};var h=document.createTextNode("test");c(document).appendChild(h);var g=document.createRange();g.setStart(h,0),g.setEnd(h,0);try{g.setStart(h,1),u.setStart=function(e,t){this.nativeRange.setStart(e,t),r(this)},u.setEnd=function(e,t){this.nativeRange.setEnd(e,t),r(this)},f=function(e){return function(t){this.nativeRange[e](t),r(this)}}}catch(p){u.setStart=function(e,t){try{this.nativeRange.setStart(e,t)}catch(n){this.nativeRange.setEnd(e,t),this.nativeRange.setStart(e,t)}r(this)},u.setEnd=function(e,t){try{this.nativeRange.setEnd(e,t)}catch(n){this.nativeRange.setStart(e,t),this.nativeRange.setEnd(e,t)}r(this)},f=function(e,t){return function(n){try{this.nativeRange[e](n)}catch(i){this.nativeRange[t](n),this.nativeRange[e](n)}r(this)}}}u.setStartBefore=f("setStartBefore","setEndBefore"),u.setStartAfter=f("setStartAfter","setEndAfter"),u.setEndBefore=f("setEndBefore","setStartBefore"),u.setEndAfter=f("setEndAfter","setStartAfter"),u.selectNodeContents=function(e){this.setStartAndEnd(e,0,i.getNodeLength(e))},g.selectNodeContents(h),g.setEnd(h,3);var m=document.createRange();m.selectNodeContents(h),m.setEnd(h,4),m.setStart(h,2),g.compareBoundaryPoints(g.START_TO_END,m)==-1&&1==g.compareBoundaryPoints(g.END_TO_START,m)?u.compareBoundaryPoints=function(e,t){return t=t.nativeRange||t,e==t.START_TO_END?e=t.END_TO_START:e==t.END_TO_START&&(e=t.START_TO_END),this.nativeRange.compareBoundaryPoints(e,t)}:u.compareBoundaryPoints=function(e,t){return this.nativeRange.compareBoundaryPoints(e,t.nativeRange||t)};var v=document.createElement("div");v.innerHTML="123";var R=v.firstChild,C=c(document);C.appendChild(v),g.setStart(R,1),g.setEnd(R,2),g.deleteContents(),"13"==R.data&&(u.deleteContents=function(){this.nativeRange.deleteContents(),r(this)},u.extractContents=function(){var e=this.nativeRange.extractContents();return r(this),e}),C.removeChild(v),C=null,o.isHostMethod(g,"createContextualFragment")&&(u.createContextualFragment=function(e){return this.nativeRange.createContextualFragment(e)}),c(document).removeChild(h),u.getName=function(){return"WrappedRange"},e.WrappedRange=n,e.createNativeRange=function(e){return e=l(e,t,"createNativeRange"),e.createRange()}}(),e.features.implementsTextRange){var f=function(e){var t=e.parentElement(),n=e.duplicate();n.collapse(!0);var r=n.parentElement();n=e.duplicate(),n.collapse(!1);var o=n.parentElement(),a=r==o?r:i.getCommonAncestor(r,o);return a==t?a:i.getCommonAncestor(t,a)},d=function(e){return 0==e.compareEndPoints("StartToEnd",e)},h=function(e,t,n,r,o){var s=e.duplicate();s.collapse(n);var c=s.parentElement();if(i.isOrIsAncestorOf(t,c)||(c=t),!c.canHaveHTML){var l=new a(c.parentNode,i.getNodeIndex(c));return{boundaryPosition:l,nodeInfo:{nodeIndex:l.offset,containerElement:l.node}}}var f=i.getDocument(c).createElement("span");f.parentNode&&i.removeNode(f);for(var d,h,g,p,m,v=n?"StartToStart":"StartToEnd",R=o&&o.containerElement==c?o.nodeIndex:0,C=c.childNodes.length,N=C,E=N;;){if(E==C?c.appendChild(f):c.insertBefore(f,c.childNodes[E]),s.moveToElementText(f),d=s.compareEndPoints(v,e),0==d||R==N)break;if(d==-1){if(N==R+1)break;R=E}else N=N==R+1?R:E;E=Math.floor((R+N)/2),c.removeChild(f)}if(m=f.nextSibling,d==-1&&m&&u(m)){s.setEndPoint(n?"EndToStart":"EndToEnd",e);var y;if(/[\r\n]/.test(m.data)){var T=s.duplicate(),S=T.text.replace(/\r\n/g,"\r").length;for(y=T.moveStart("character",S);(d=T.compareEndPoints("StartToEnd",T))==-1;)y++,T.moveStart("character",1)}else y=s.text.length;p=new a(m,y)}else h=(r||!n)&&f.previousSibling,g=(r||n)&&f.nextSibling,p=g&&u(g)?new a(g,0):h&&u(h)?new a(h,h.data.length):new a(c,i.getNodeIndex(f));return i.removeNode(f),{boundaryPosition:p,nodeInfo:{nodeIndex:E,containerElement:c}}},g=function(e,t){var n,r,o,a,s=e.offset,l=i.getDocument(e.node),f=c(l).createTextRange(),d=u(e.node);return d?(n=e.node,r=n.parentNode):(a=e.node.childNodes,n=s<a.length?a[s]:null,r=e.node),o=l.createElement("span"),o.innerHTML="&#feff;",n?r.insertBefore(o,n):r.appendChild(o),f.moveToElementText(o),f.collapse(!t),r.removeChild(o),d&&f[t?"moveStart":"moveEnd"]("character",s),f};r=function(e){this.textRange=e,this.refresh()},r.prototype=new s(document),
r.prototype.refresh=function(){var e,t,n,r=f(this.textRange);d(this.textRange)?t=e=h(this.textRange,r,!0,!0).boundaryPosition:(n=h(this.textRange,r,!0,!1),e=n.boundaryPosition,t=h(this.textRange,r,!1,!1,n.nodeInfo).boundaryPosition),this.setStart(e.node,e.offset),this.setEnd(t.node,t.offset)},r.prototype.getName=function(){return"WrappedTextRange"},s.copyComparisonConstants(r);var p=function(e){if(e.collapsed)return g(new a(e.startContainer,e.startOffset),!0);var t=g(new a(e.startContainer,e.startOffset),!0),n=g(new a(e.endContainer,e.endOffset),!1),r=c(s.getRangeDocument(e)).createTextRange();return r.setEndPoint("StartToStart",t),r.setEndPoint("EndToEnd",n),r};if(r.rangeToTextRange=p,r.prototype.toTextRange=function(){return p(this)},e.WrappedTextRange=r,!e.features.implementsDomRange||e.config.preferTextRange){var m=function(e){return e("return this;")()}(Function);"undefined"==typeof m.Range&&(m.Range=r),e.createNativeRange=function(e){return e=l(e,t,"createNativeRange"),c(e).createTextRange()},e.WrappedRange=r}}e.createRange=function(n){return n=l(n,t,"createRange"),new e.WrappedRange(e.createNativeRange(n))},e.createRangyRange=function(e){return e=l(e,t,"createRangyRange"),new s(e)},o.createAliasForDeprecatedMethod(e,"createIframeRange","createRange"),o.createAliasForDeprecatedMethod(e,"createIframeRangyRange","createRangyRange"),e.addShimListener(function(t){var n=t.document;"undefined"==typeof n.createRange&&(n.createRange=function(){return e.createRange(n)}),n=t=null})}),P.createCoreModule("WrappedSelection",["DomRange","WrappedRange"],function(e,t){function n(e){return"string"==typeof e?/^backward(s)?$/i.test(e):!!e}function r(e,n){if(e){if(x.isWindow(e))return e;if(e instanceof v)return e.win;var r=x.getContentDocument(e,t,n);return x.getWindow(r)}return window}function i(e){return r(e,"getWinSelection").getSelection()}function o(e){return r(e,"getDocSelection").document.selection}function a(e){var t=!1;return e.anchorNode&&(t=1==x.comparePoints(e.anchorNode,e.anchorOffset,e.focusNode,e.focusOffset)),t}function s(e,t,n){var r=n?"end":"start",i=n?"start":"end";e.anchorNode=t[r+"Container"],e.anchorOffset=t[r+"Offset"],e.focusNode=t[i+"Container"],e.focusOffset=t[i+"Offset"]}function c(e){var t=e.nativeSelection;e.anchorNode=t.anchorNode,e.anchorOffset=t.anchorOffset,e.focusNode=t.focusNode,e.focusOffset=t.focusOffset}function l(e){e.anchorNode=e.focusNode=null,e.anchorOffset=e.focusOffset=0,e.rangeCount=0,e.isCollapsed=!0,e._ranges.length=0}function u(t){var n;return t instanceof D?(n=e.createNativeRange(t.getDocument()),n.setEnd(t.endContainer,t.endOffset),n.setStart(t.startContainer,t.startOffset)):t instanceof I?n=t.nativeRange:M.implementsDomRange&&t instanceof x.getWindow(t.startContainer).Range&&(n=t),n}function f(e){if(!e.length||1!=e[0].nodeType)return!1;for(var t=1,n=e.length;t<n;++t)if(!x.isAncestorOf(e[0],e[t]))return!1;return!0}function d(e){var n=e.getNodes();if(!f(n))throw t.createError("getSingleElementFromRange: range "+e.inspect()+" did not consist of a single element");return n[0]}function h(e){return!!e&&"undefined"!=typeof e.text}function g(e,t){var n=new I(t);e._ranges=[n],s(e,n,!1),e.rangeCount=1,e.isCollapsed=n.collapsed}function p(t){if(t._ranges.length=0,"None"==t.docSelection.type)l(t);else{var n=t.docSelection.createRange();if(h(n))g(t,n);else{t.rangeCount=n.length;for(var r,i=W(n.item(0)),o=0;o<t.rangeCount;++o)r=e.createRange(i),r.selectNode(n.item(o)),t._ranges.push(r);t.isCollapsed=1==t.rangeCount&&t._ranges[0].collapsed,s(t,t._ranges[t.rangeCount-1],!1)}}}function m(e,n){for(var r=e.docSelection.createRange(),i=d(n),o=W(r.item(0)),a=L(o).createControlRange(),s=0,c=r.length;s<c;++s)a.add(r.item(s));try{a.add(i)}catch(l){throw t.createError("addRange(): Element within the specified Range could not be added to control selection (does it have layout?)")}a.select(),p(e)}function v(e,t,n){this.nativeSelection=e,this.docSelection=t,this._ranges=[],this.win=n,this.refresh()}function R(e){e.win=e.anchorNode=e.focusNode=e._ranges=null,e.rangeCount=e.anchorOffset=e.focusOffset=0,e.detached=!0}function C(e,t){for(var n,r,i=te.length;i--;)if(n=te[i],r=n.selection,"deleteAll"==t)R(r);else if(n.win==e)return"delete"==t?(te.splice(i,1),!0):r;return"deleteAll"==t&&(te.length=0),null}function N(e,n){for(var r,i=W(n[0].startContainer),o=L(i).createControlRange(),a=0,s=n.length;a<s;++a){r=d(n[a]);try{o.add(r)}catch(c){throw t.createError("setRanges(): Element within one of the specified Ranges could not be added to control selection (does it have layout?)")}}o.select(),p(e)}function E(e,t){if(e.win.document!=W(t))throw new P("WRONG_DOCUMENT_ERR")}function y(t){return function(n,r){var i;this.rangeCount?(i=this.getRangeAt(0),i["set"+(t?"Start":"End")](n,r)):(i=e.createRange(this.win.document),i.setStartAndEnd(n,r)),this.setSingleRange(i,this.isBackward())}}function T(e){var t=[],n=new H(e.anchorNode,e.anchorOffset),r=new H(e.focusNode,e.focusOffset),i="function"==typeof e.getName?e.getName():"Selection";if("undefined"!=typeof e.rangeCount)for(var o=0,a=e.rangeCount;o<a;++o)t[o]=D.inspect(e.getRangeAt(o));return"["+i+"(Ranges: "+t.join(", ")+")(anchor: "+n.inspect()+", focus: "+r.inspect()+"]"}e.config.checkSelectionRanges=!0;var S,w,A="boolean",O="number",x=e.dom,b=e.util,_=b.isHostMethod,D=e.DomRange,I=e.WrappedRange,P=e.DOMException,H=x.DomPosition,M=e.features,B="Control",W=x.getDocument,L=x.getBody,k=D.rangesEqual,F=_(window,"getSelection"),j=b.isHostObject(document,"selection");M.implementsWinGetSelection=F,M.implementsDocSelection=j;var z=j&&(!F||e.config.preferTextRange);if(z)S=o,e.isSelectionValid=function(e){var t=r(e,"isSelectionValid").document,n=t.selection;return"None"!=n.type||W(n.createRange().parentElement())==t};else{if(!F)return t.fail("Neither document.selection or window.getSelection() detected."),!1;S=i,e.isSelectionValid=function(){return!0}}e.getNativeSelection=S;var U=S();if(!U)return t.fail("Native selection was null (possibly issue 138?)"),!1;var V=e.createNativeRange(document),q=L(document),$=b.areHostProperties(U,["anchorNode","focusNode","anchorOffset","focusOffset"]);M.selectionHasAnchorAndFocus=$;var Y=_(U,"extend");M.selectionHasExtend=Y;var Q=typeof U.rangeCount==O;M.selectionHasRangeCount=Q;var G=!1,X=!0,Z=Y?function(t,n){var r=D.getRangeDocument(n),i=e.createRange(r);i.collapseToPoint(n.endContainer,n.endOffset),t.addRange(u(i)),t.extend(n.startContainer,n.startOffset)}:null;b.areHostMethods(U,["addRange","getRangeAt","removeAllRanges"])&&typeof U.rangeCount==O&&M.implementsDomRange&&!function(){var t=window.getSelection();if(t){for(var n=t.rangeCount,r=n>1,i=[],o=a(t),s=0;s<n;++s)i[s]=t.getRangeAt(s);var c=x.createTestElement(document,"",!1),l=c.appendChild(document.createTextNode("   ")),u=document.createRange();if(u.setStart(l,1),u.collapse(!0),t.removeAllRanges(),t.addRange(u),X=1==t.rangeCount,t.removeAllRanges(),!r){var f=window.navigator.appVersion.match(/Chrome\/(.*?) /);if(f&&parseInt(f[1])>=36)G=!1;else{var d=u.cloneRange();u.setStart(l,0),d.setEnd(l,3),d.setStart(l,2),t.addRange(u),t.addRange(d),G=2==t.rangeCount}}for(x.removeNode(c),t.removeAllRanges(),s=0;s<n;++s)0==s&&o?Z?Z(t,i[s]):(e.warn("Rangy initialization: original selection was backwards but selection has been restored forwards because the browser does not support Selection.extend"),t.addRange(i[s])):t.addRange(i[s])}}(),M.selectionSupportsMultipleRanges=G,M.collapsedNonEditableSelectionsSupported=X;var J,K=!1;q&&_(q,"createControlRange")&&(J=q.createControlRange(),b.areHostProperties(J,["item","add"])&&(K=!0)),M.implementsControlRange=K,w=$?function(e){return e.anchorNode===e.focusNode&&e.anchorOffset===e.focusOffset}:function(e){return!!e.rangeCount&&e.getRangeAt(e.rangeCount-1).collapsed};var ee;_(U,"getRangeAt")?ee=function(e,t){try{return e.getRangeAt(t)}catch(n){return null}}:$&&(ee=function(t){var n=W(t.anchorNode),r=e.createRange(n);return r.setStartAndEnd(t.anchorNode,t.anchorOffset,t.focusNode,t.focusOffset),r.collapsed!==this.isCollapsed&&r.setStartAndEnd(t.focusNode,t.focusOffset,t.anchorNode,t.anchorOffset),r}),v.prototype=e.selectionPrototype;var te=[],ne=function(e){if(e&&e instanceof v)return e.refresh(),e;e=r(e,"getNativeSelection");var t=C(e),n=S(e),i=j?o(e):null;return t?(t.nativeSelection=n,t.docSelection=i,t.refresh()):(t=new v(n,i,e),te.push({win:e,selection:t})),t};e.getSelection=ne,b.createAliasForDeprecatedMethod(e,"getIframeSelection","getSelection");var re=v.prototype;if(!z&&$&&b.areHostMethods(U,["removeAllRanges","addRange"])){re.removeAllRanges=function(){this.nativeSelection.removeAllRanges(),l(this)};var ie=function(e,t){Z(e.nativeSelection,t),e.refresh()};Q?re.addRange=function(t,r){if(K&&j&&this.docSelection.type==B)m(this,t);else if(n(r)&&Y)ie(this,t);else{var i;G?i=this.rangeCount:(this.removeAllRanges(),i=0);var o=u(t).cloneRange();try{this.nativeSelection.addRange(o)}catch(a){}if(this.rangeCount=this.nativeSelection.rangeCount,this.rangeCount==i+1){if(e.config.checkSelectionRanges){var c=ee(this.nativeSelection,this.rangeCount-1);c&&!k(c,t)&&(t=new I(c))}this._ranges[this.rangeCount-1]=t,s(this,t,se(this.nativeSelection)),this.isCollapsed=w(this)}else this.refresh()}}:re.addRange=function(e,t){n(t)&&Y?ie(this,e):(this.nativeSelection.addRange(u(e)),this.refresh())},re.setRanges=function(e){if(K&&j&&e.length>1)N(this,e);else{this.removeAllRanges();for(var t=0,n=e.length;t<n;++t)this.addRange(e[t])}}}else{if(!(_(U,"empty")&&_(V,"select")&&K&&z))return t.fail("No means of selecting a Range or TextRange was found"),!1;re.removeAllRanges=function(){try{if(this.docSelection.empty(),"None"!=this.docSelection.type){var e;if(this.anchorNode)e=W(this.anchorNode);else if(this.docSelection.type==B){var t=this.docSelection.createRange();t.length&&(e=W(t.item(0)))}if(e){var n=L(e).createTextRange();n.select(),this.docSelection.empty()}}}catch(r){}l(this)},re.addRange=function(t){this.docSelection.type==B?m(this,t):(e.WrappedTextRange.rangeToTextRange(t).select(),this._ranges[0]=t,this.rangeCount=1,this.isCollapsed=this._ranges[0].collapsed,s(this,t,!1))},re.setRanges=function(e){this.removeAllRanges();var t=e.length;t>1?N(this,e):t&&this.addRange(e[0])}}re.getRangeAt=function(e){if(e<0||e>=this.rangeCount)throw new P("INDEX_SIZE_ERR");return this._ranges[e].cloneRange()};var oe;if(z)oe=function(t){var n;e.isSelectionValid(t.win)?n=t.docSelection.createRange():(n=L(t.win.document).createTextRange(),n.collapse(!0)),t.docSelection.type==B?p(t):h(n)?g(t,n):l(t)};else if(_(U,"getRangeAt")&&typeof U.rangeCount==O)oe=function(t){if(K&&j&&t.docSelection.type==B)p(t);else if(t._ranges.length=t.rangeCount=t.nativeSelection.rangeCount,t.rangeCount){for(var n=0,r=t.rangeCount;n<r;++n)t._ranges[n]=new e.WrappedRange(t.nativeSelection.getRangeAt(n));s(t,t._ranges[t.rangeCount-1],se(t.nativeSelection)),t.isCollapsed=w(t)}else l(t)};else{if(!$||typeof U.isCollapsed!=A||typeof V.collapsed!=A||!M.implementsDomRange)return t.fail("No means of obtaining a Range or TextRange from the user's selection was found"),!1;oe=function(e){var t,n=e.nativeSelection;n.anchorNode?(t=ee(n,0),e._ranges=[t],e.rangeCount=1,c(e),e.isCollapsed=w(e)):l(e)}}re.refresh=function(e){var t=e?this._ranges.slice(0):null,n=this.anchorNode,r=this.anchorOffset;if(oe(this),e){var i=t.length;if(i!=this._ranges.length)return!0;if(this.anchorNode!=n||this.anchorOffset!=r)return!0;for(;i--;)if(!k(t[i],this._ranges[i]))return!0;return!1}};var ae=function(e,t){var n=e.getAllRanges();e.removeAllRanges();for(var r=0,i=n.length;r<i;++r)k(t,n[r])||e.addRange(n[r]);e.rangeCount||l(e)};K&&j?re.removeRange=function(e){if(this.docSelection.type==B){for(var t,n=this.docSelection.createRange(),r=d(e),i=W(n.item(0)),o=L(i).createControlRange(),a=!1,s=0,c=n.length;s<c;++s)t=n.item(s),t!==r||a?o.add(n.item(s)):a=!0;o.select(),p(this)}else ae(this,e)}:re.removeRange=function(e){ae(this,e)};var se;!z&&$&&M.implementsDomRange?(se=a,re.isBackward=function(){return se(this)}):se=re.isBackward=function(){return!1},re.isBackwards=re.isBackward,re.toString=function(){for(var e=[],t=0,n=this.rangeCount;t<n;++t)e[t]=""+this._ranges[t];return e.join("")},re.collapse=function(t,n){E(this,t);var r=e.createRange(t);r.collapseToPoint(t,n),this.setSingleRange(r),this.isCollapsed=!0},re.collapseToStart=function(){if(!this.rangeCount)throw new P("INVALID_STATE_ERR");var e=this._ranges[0];this.collapse(e.startContainer,e.startOffset)},re.collapseToEnd=function(){if(!this.rangeCount)throw new P("INVALID_STATE_ERR");var e=this._ranges[this.rangeCount-1];this.collapse(e.endContainer,e.endOffset)},re.selectAllChildren=function(t){E(this,t);var n=e.createRange(t);n.selectNodeContents(t),this.setSingleRange(n)},re.deleteFromDocument=function(){if(K&&j&&this.docSelection.type==B){for(var e,t=this.docSelection.createRange();t.length;)e=t.item(0),t.remove(e),x.removeNode(e);this.refresh()}else if(this.rangeCount){var n=this.getAllRanges();if(n.length){this.removeAllRanges();for(var r=0,i=n.length;r<i;++r)n[r].deleteContents();this.addRange(n[i-1])}}},re.eachRange=function(e,t){for(var n=0,r=this._ranges.length;n<r;++n)if(e(this.getRangeAt(n)))return t},re.getAllRanges=function(){var e=[];return this.eachRange(function(t){e.push(t)}),e},re.setSingleRange=function(e,t){this.removeAllRanges(),this.addRange(e,t)},re.callMethodOnEachRange=function(e,t){var n=[];return this.eachRange(function(r){n.push(r[e].apply(r,t||[]))}),n},re.setStart=y(!0),re.setEnd=y(!1),e.rangePrototype.select=function(e){ne(this.getDocument()).setSingleRange(this,e)},re.changeEachRange=function(e){var t=[],n=this.isBackward();this.eachRange(function(n){e(n),t.push(n)}),this.removeAllRanges(),n&&1==t.length?this.addRange(t[0],"backward"):this.setRanges(t)},re.containsNode=function(e,t){return this.eachRange(function(n){return n.containsNode(e,t)},!0)||!1},re.getBookmark=function(e){return{backward:this.isBackward(),rangeBookmarks:this.callMethodOnEachRange("getBookmark",[e])}},re.moveToBookmark=function(t){for(var n,r,i=[],o=0;n=t.rangeBookmarks[o++];)r=e.createRange(this.win),r.moveToBookmark(n),i.push(r);t.backward?this.setSingleRange(i[0],"backward"):this.setRanges(i)},re.saveRanges=function(){return{backward:this.isBackward(),ranges:this.callMethodOnEachRange("cloneRange")}},re.restoreRanges=function(e){this.removeAllRanges();for(var t,n=0;t=e.ranges[n];++n)this.addRange(t,e.backward&&0==n)},re.toHtml=function(){var e=[];return this.eachRange(function(t){e.push(D.toHtml(t))}),e.join("")},M.implementsTextRange&&(re.getNativeTextRange=function(){var n;if(n=this.docSelection){var r=n.createRange();if(h(r))return r;throw t.createError("getNativeTextRange: selection is a control selection")}if(this.rangeCount>0)return e.WrappedTextRange.rangeToTextRange(this.getRangeAt(0));throw t.createError("getNativeTextRange: selection contains no range")}),re.getName=function(){return"WrappedSelection"},re.inspect=function(){return T(this)},re.detach=function(){C(this.win,"delete"),R(this)},v.detachAll=function(){C(null,"deleteAll")},v.inspect=T,v.isDirectionBackward=n,e.Selection=v,e.selectionPrototype=re,e.addShimListener(function(e){"undefined"==typeof e.getSelection&&(e.getSelection=function(){return ne(e)}),e=null})});var L=!1,k=function(e){L||(L=!0,!P.initialized&&P.config.autoInitialize&&f())};return D&&("complete"==document.readyState?k():(e(document,"addEventListener")&&document.addEventListener("DOMContentLoaded",k,!1),M(window,"load",k))),P},this),function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("ClassApplier",["WrappedSelection"],function(e,t){function n(e,t){for(var n in e)if(e.hasOwnProperty(n)&&t(n,e[n])===!1)return!1;return!0}function r(e){return e.replace(/^\s\s*/,"").replace(/\s\s*$/,"")}function o(e,t){return!!e&&new RegExp("(?:^|\\s)"+t+"(?:\\s|$)").test(e)}function a(e,t){if("object"==typeof e.classList)return e.classList.contains(t);var n="string"==typeof e.className,r=n?e.className:e.getAttribute("class");return o(r,t)}function s(e,t){if("object"==typeof e.classList)e.classList.add(t);else{var n="string"==typeof e.className,r=n?e.className:e.getAttribute("class");r?o(r,t)||(r+=" "+t):r=t,n?e.className=r:e.setAttribute("class",r)}}function c(e){var t="string"==typeof e.className;return t?e.className:e.getAttribute("class")}function l(e){return e&&e.split(/\s+/).sort().join(" ")}function u(e){return l(c(e))}function f(e,t){return u(e)==u(t)}function d(e,t){for(var n=t.split(/\s+/),i=0,o=n.length;i<o;++i)if(!a(e,r(n[i])))return!1;return!0}function h(e){var t=e.parentNode;return t&&1==t.nodeType&&!/^(textarea|style|script|select|iframe)$/i.test(t.nodeName)}function g(e,t,n,r,i){var o=e.node,a=e.offset,s=o,c=a;o==r&&a>i&&++c,o!=t||a!=n&&a!=n+1||(s=r,c+=i-n),o==t&&a>n+1&&--c,e.node=s,e.offset=c}function p(e,t,n){e.node==t&&e.offset>n&&--e.offset}function m(e,t,n,r){n==-1&&(n=t.childNodes.length);var i=e.parentNode,o=W.getNodeIndex(e);j(r,function(e){g(e,i,o,t,n)}),t.childNodes.length==n?t.appendChild(e):t.insertBefore(e,t.childNodes[n])}function v(e,t){var n=e.parentNode,r=W.getNodeIndex(e);j(t,function(e){p(e,n,r)}),W.removeNode(e)}function R(e,t,n,r,i){for(var o,a=[];o=e.firstChild;)m(o,t,n++,i),a.push(o);return r&&v(e,i),a}function C(e,t){return R(e,e.parentNode,W.getNodeIndex(e),!0,t)}function N(e,t){var n=e.cloneRange();n.selectNodeContents(t);var r=n.intersection(e),i=r?r.toString():"";return""!=i}function E(e){for(var t,n=e.getNodes([3]),r=0;(t=n[r])&&!N(e,t);)++r;for(var i=n.length-1;(t=n[i])&&!N(e,t);)--i;return n.slice(r,i+1)}function y(e,t){if(e.attributes.length!=t.attributes.length)return!1;for(var n,r,i,o=0,a=e.attributes.length;o<a;++o)if(n=e.attributes[o],i=n.name,"class"!=i){if(r=t.attributes.getNamedItem(i),null===n!=(null===r))return!1;if(n.specified!=r.specified)return!1;if(n.specified&&n.nodeValue!==r.nodeValue)return!1}return!0}function T(e,t){for(var n,r=0,i=e.attributes.length;r<i;++r)if(n=e.attributes[r].name,(!t||!k(t,n))&&e.attributes[r].specified&&"class"!=n)return!0;return!1}function S(e){var t;return e&&1==e.nodeType&&((t=e.parentNode)&&9==t.nodeType&&"on"==t.designMode||$(e)&&!$(e.parentNode))}function w(e){return($(e)||1!=e.nodeType&&$(e.parentNode))&&!S(e)}function A(e){return e&&1==e.nodeType&&!Y.test(q(e,"display"))}function O(e){if(0==e.data.length)return!0;if(Q.test(e.data))return!1;var t=q(e.parentNode,"whiteSpace");switch(t){case"pre":case"pre-wrap":case"-moz-pre-wrap":return!1;case"pre-line":if(/[\r\n]/.test(e.data))return!1}return A(e.previousSibling)||A(e.nextSibling)}function x(e){var t,n,r=[];for(t=0;n=e[t++];)r.push(new L(n.startContainer,n.startOffset),new L(n.endContainer,n.endOffset));return r}function b(e,t){for(var n,r,i,o=0,a=e.length;o<a;++o)n=e[o],r=t[2*o],i=t[2*o+1],n.setStartAndEnd(r.node,r.offset,i.node,i.offset)}function _(e,t){return W.isCharacterDataNode(e)?0==t?!!e.previousSibling:t!=e.length||!!e.nextSibling:t>0&&t<e.childNodes.length}function D(e,n,r,i){var o,a,s=0==r;if(W.isAncestorOf(n,e))return e;if(W.isCharacterDataNode(n)){var c=W.getNodeIndex(n);if(0==r)r=c;else{if(r!=n.length)throw t.createError("splitNodeAt() should not be called with offset in the middle of a data node ("+r+" in "+n.data);r=c+1}n=n.parentNode}if(_(n,r)){o=n.cloneNode(!1),a=n.parentNode,o.id&&o.removeAttribute("id");for(var l,u=0;l=n.childNodes[r];)m(l,o,u++,i);return m(o,a,W.getNodeIndex(n)+1,i),n==e?o:D(e,a,W.getNodeIndex(o),i)}if(e!=n){o=n.parentNode;var f=W.getNodeIndex(n);return s||f++,D(e,o,f,i)}return e}function I(e,t){return e.namespaceURI==t.namespaceURI&&e.tagName.toLowerCase()==t.tagName.toLowerCase()&&f(e,t)&&y(e,t)&&"inline"==q(e,"display")&&"inline"==q(t,"display")}function P(e){var t=e?"nextSibling":"previousSibling";return function(n,r){var i=n.parentNode,o=n[t];if(o){if(o&&3==o.nodeType)return o}else if(r&&(o=i[t],o&&1==o.nodeType&&I(i,o))){var a=o[e?"firstChild":"lastChild"];if(a&&3==a.nodeType)return a}return null}}function H(e){this.isElementMerge=1==e.nodeType,this.textNodes=[];var t=this.isElementMerge?e.lastChild:e;t&&(this.textNodes[0]=t)}function M(e,t,i){var o,a,s,c,u=this;u.cssClass=u.className=e;var f=null,d={};if("object"==typeof t&&null!==t){for("undefined"!=typeof t.elementTagName&&(t.elementTagName=t.elementTagName.toLowerCase()),i=t.tagNames,f=t.elementProperties,d=t.elementAttributes,a=0;c=Z[a++];)t.hasOwnProperty(c)&&(u[c]=t[c]);o=t.normalize}else o=t;u.normalize="undefined"==typeof o||o,u.attrExceptions=[];var h=document.createElement(u.elementTagName);u.elementProperties=u.copyPropertiesToElement(f,h,!0),n(d,function(e,t){u.attrExceptions.push(e),d[e]=""+t}),u.elementAttributes=d,u.elementSortedClassName=u.elementProperties.hasOwnProperty("className")?l(u.elementProperties.className+" "+e):e,u.applyToAnyTagName=!1;var g=typeof i;if("string"==g)"*"==i?u.applyToAnyTagName=!0:u.tagNames=r(i.toLowerCase()).split(/\s*,\s*/);else if("object"==g&&"number"==typeof i.length)for(u.tagNames=[],a=0,s=i.length;a<s;++a)"*"==i[a]?u.applyToAnyTagName=!0:u.tagNames.push(i[a].toLowerCase());else u.tagNames=[u.elementTagName]}function B(e,t,n){return new M(e,t,n)}var W=e.dom,L=W.DomPosition,k=W.arrayContains,F=e.util,j=F.forEach,z="span",U=F.isHostMethod(document,"createElementNS"),V=function(){function e(e,t,n){return t&&n?" ":""}return function(t,n){if("object"==typeof t.classList)t.classList.remove(n);else{var r="string"==typeof t.className,i=r?t.className:t.getAttribute("class");i=i.replace(new RegExp("(^|\\s)"+n+"(\\s|$)"),e),r?t.className=i:t.setAttribute("class",i)}}}(),q=W.getComputedStyleProperty,$=function(){var e=document.createElement("div");return"boolean"==typeof e.isContentEditable?function(e){return e&&1==e.nodeType&&e.isContentEditable}:function(e){return!(!e||1!=e.nodeType||"false"==e.contentEditable)&&("true"==e.contentEditable||$(e.parentNode))}}(),Y=/^inline(-block|-table)?$/i,Q=/[^\r\n\t\f \u200B]/,G=P(!1),X=P(!0);H.prototype={doMerge:function(e){var t=this.textNodes,n=t[0];if(t.length>1){var r,i=W.getNodeIndex(n),o=[],a=0;j(t,function(t,s){r=t.parentNode,s>0&&(r.removeChild(t),r.hasChildNodes()||W.removeNode(r),e&&j(e,function(e){e.node==t&&(e.node=n,e.offset+=a),e.node==r&&e.offset>i&&(--e.offset,e.offset==i+1&&s<len-1&&(e.node=n,e.offset=a))})),o[s]=t.data,a+=t.data.length}),n.data=o.join("")}return n.data},getLength:function(){for(var e=this.textNodes.length,t=0;e--;)t+=this.textNodes[e].length;return t},toString:function(){var e=[];return j(this.textNodes,function(t,n){e[n]="'"+t.data+"'"}),"[Merge("+e.join(",")+")]"}};var Z=["elementTagName","ignoreWhiteSpace","applyToEditableOnly","useExistingElements","removeEmptyElements","onElementCreate"],J={};M.prototype={elementTagName:z,elementProperties:{},elementAttributes:{},ignoreWhiteSpace:!0,applyToEditableOnly:!1,useExistingElements:!0,removeEmptyElements:!0,onElementCreate:null,copyPropertiesToElement:function(e,t,n){var r,i,o,a,c,u,f={};for(var d in e)if(e.hasOwnProperty(d))if(a=e[d],c=t[d],"className"==d)s(t,a),s(t,this.className),t[d]=l(t[d]),n&&(f[d]=a);else if("style"==d){i=c,n&&(f[d]=o={});for(r in e[d])e[d].hasOwnProperty(r)&&(i[r]=a[r],n&&(o[r]=i[r]));this.attrExceptions.push(d)}else t[d]=a,n&&(f[d]=t[d],u=J.hasOwnProperty(d)?J[d]:d,this.attrExceptions.push(u));return n?f:""},copyAttributesToElement:function(e,t){for(var n in e)e.hasOwnProperty(n)&&!/^class(?:Name)?$/i.test(n)&&t.setAttribute(n,e[n])},appliesToElement:function(e){return k(this.tagNames,e.tagName.toLowerCase())},getEmptyElements:function(e){var t=this;return e.getNodes([1],function(e){return t.appliesToElement(e)&&!e.hasChildNodes()})},hasClass:function(e){return 1==e.nodeType&&(this.applyToAnyTagName||this.appliesToElement(e))&&a(e,this.className)},getSelfOrAncestorWithClass:function(e){for(;e;){if(this.hasClass(e))return e;e=e.parentNode}return null},isModifiable:function(e){return!this.applyToEditableOnly||w(e)},isIgnorableWhiteSpaceNode:function(e){return this.ignoreWhiteSpace&&e&&3==e.nodeType&&O(e)},postApply:function(e,t,n,r){var o,a,s=e[0],c=e[e.length-1],l=[],u=s,f=c,d=0,h=c.length;j(e,function(e){a=G(e,!r),a?(o||(o=new H(a),l.push(o)),o.textNodes.push(e),e===s&&(u=o.textNodes[0],d=u.length),e===c&&(f=o.textNodes[0],h=o.getLength())):o=null});var g=X(c,!r);if(g&&(o||(o=new H(c),l.push(o)),o.textNodes.push(g)),l.length){for(i=0,len=l.length;i<len;++i)l[i].doMerge(n);t.setStartAndEnd(u,d,f,h)}},createContainer:function(e){var t,n=W.getDocument(e),r=U&&!W.isHtmlNamespace(e)&&(t=e.namespaceURI)?n.createElementNS(e.namespaceURI,this.elementTagName):n.createElement(this.elementTagName);return this.copyPropertiesToElement(this.elementProperties,r,!1),this.copyAttributesToElement(this.elementAttributes,r),s(r,this.className),this.onElementCreate&&this.onElementCreate(r,this),r},elementHasProperties:function(e,t){var r=this;return n(t,function(t,n){if("className"==t)return d(e,n);if("object"==typeof n){if(!r.elementHasProperties(e[t],n))return!1}else if(e[t]!==n)return!1})},elementHasAttributes:function(e,t){return n(t,function(t,n){if(e.getAttribute(t)!==n)return!1})},applyToTextNode:function(e,t){if(h(e)){var n=e.parentNode;if(1==n.childNodes.length&&this.useExistingElements&&this.appliesToElement(n)&&this.elementHasProperties(n,this.elementProperties)&&this.elementHasAttributes(n,this.elementAttributes))s(n,this.className);else{var r=e.parentNode,i=this.createContainer(r);r.insertBefore(i,e),i.appendChild(e)}}},isRemovable:function(e){return e.tagName.toLowerCase()==this.elementTagName&&u(e)==this.elementSortedClassName&&this.elementHasProperties(e,this.elementProperties)&&!T(e,this.attrExceptions)&&this.elementHasAttributes(e,this.elementAttributes)&&this.isModifiable(e)},isEmptyContainer:function(e){var t=e.childNodes.length;return 1==e.nodeType&&this.isRemovable(e)&&(0==t||1==t&&this.isEmptyContainer(e.firstChild))},removeEmptyContainers:function(e){var t=this,n=e.getNodes([1],function(e){return t.isEmptyContainer(e)}),r=[e],i=x(r);j(n,function(e){v(e,i)}),b(r,i)},undoToTextNode:function(e,t,n,r){if(!t.containsNode(n)){var i=t.cloneRange();i.selectNode(n),i.isPointInRange(t.endContainer,t.endOffset)&&(D(n,t.endContainer,t.endOffset,r),t.setEndAfter(n)),i.isPointInRange(t.startContainer,t.startOffset)&&(n=D(n,t.startContainer,t.startOffset,r))}this.isRemovable(n)?C(n,r):V(n,this.className)},splitAncestorWithClass:function(e,t,n){var r=this.getSelfOrAncestorWithClass(e);r&&D(r,e,t,n)},undoToAncestor:function(e,t){this.isRemovable(e)?C(e,t):V(e,this.className)},applyToRange:function(e,t){var n=this;t=t||[];var r=x(t||[]);e.splitBoundariesPreservingPositions(r),n.removeEmptyElements&&n.removeEmptyContainers(e);var i=E(e);if(i.length){j(i,function(e){n.isIgnorableWhiteSpaceNode(e)||n.getSelfOrAncestorWithClass(e)||!n.isModifiable(e)||n.applyToTextNode(e,r)});var o=i[i.length-1];e.setStartAndEnd(i[0],0,o,o.length),n.normalize&&n.postApply(i,e,r,!1),b(t,r)}var a=n.getEmptyElements(e);j(a,function(e){s(e,n.className)})},applyToRanges:function(e){for(var t=e.length;t--;)this.applyToRange(e[t],e);return e},applyToSelection:function(t){var n=e.getSelection(t);n.setRanges(this.applyToRanges(n.getAllRanges()))},undoToRange:function(e,t){var n=this;t=t||[];var r=x(t);e.splitBoundariesPreservingPositions(r),n.removeEmptyElements&&n.removeEmptyContainers(e,r);var i,o,a=E(e),s=a[a.length-1];if(a.length){n.splitAncestorWithClass(e.endContainer,e.endOffset,r),n.splitAncestorWithClass(e.startContainer,e.startOffset,r);for(var c=0,l=a.length;c<l;++c)i=a[c],o=n.getSelfOrAncestorWithClass(i),o&&n.isModifiable(i)&&n.undoToAncestor(o,r);e.setStartAndEnd(a[0],0,s,s.length),n.normalize&&n.postApply(a,e,r,!0),b(t,r)}var u=n.getEmptyElements(e);j(u,function(e){V(e,n.className)})},undoToRanges:function(e){for(var t=e.length;t--;)this.undoToRange(e[t],e);return e},undoToSelection:function(t){var n=e.getSelection(t),r=e.getSelection(t).getAllRanges();this.undoToRanges(r),n.setRanges(r)},isAppliedToRange:function(e){if(e.collapsed||""==e.toString())return!!this.getSelfOrAncestorWithClass(e.commonAncestorContainer);var t=e.getNodes([3]);if(t.length)for(var n,r=0;n=t[r++];)if(!this.isIgnorableWhiteSpaceNode(n)&&N(e,n)&&this.isModifiable(n)&&!this.getSelfOrAncestorWithClass(n))return!1;return!0},isAppliedToRanges:function(e){var t=e.length;if(0==t)return!1;for(;t--;)if(!this.isAppliedToRange(e[t]))return!1;return!0},isAppliedToSelection:function(t){var n=e.getSelection(t);return this.isAppliedToRanges(n.getAllRanges())},toggleRange:function(e){this.isAppliedToRange(e)?this.undoToRange(e):this.applyToRange(e)},toggleSelection:function(e){this.isAppliedToSelection(e)?this.undoToSelection(e):this.applyToSelection(e)},getElementsWithClassIntersectingRange:function(e){var t=[],n=this;return e.getNodes([3],function(e){var r=n.getSelfOrAncestorWithClass(e);r&&!k(t,r)&&t.push(r)}),t},detach:function(){}},M.util={hasClass:a,addClass:s,removeClass:V,getClass:c,hasSameClasses:f,hasAllClasses:d,replaceWithOwnChildren:C,elementsHaveSameNonClassAttributes:y,elementHasNonClassAttributes:T,splitNodeAt:D,isEditableElement:$,isEditingHost:S,isEditable:w},e.CssClassApplier=e.ClassApplier=M,e.createClassApplier=B,F.createAliasForDeprecatedMethod(e,"createCssClassApplier","createClassApplier",t)}),e},this),function(e,t){"function"==typeof define&&define.amd?define(["./rangy-core"],e):"undefined"!=typeof module&&"object"==typeof exports?module.exports=e(require("rangy")):e(t.rangy)}(function(e){return e.createModule("Highlighter",["ClassApplier"],function(e,t){function n(e,t){return e.characterRange.start-t.characterRange.start}function r(e,t){return t?e.getElementById(t):d(e)}function i(e,t){this.type=e,this.converterCreator=t}function o(e,t){m[e]=new i(e,t)}function a(e){var t=m[e];if(t instanceof i)return t.create();throw new Error("Highlighter type '"+e+"' is not valid")}function s(e,t){this.start=e,this.end=t}function c(e,t,n,r,i,o){i?(this.id=i,p=Math.max(p,i+1)):this.id=p++,this.characterRange=t,this.doc=e,this.classApplier=n,this.converter=r,this.containerElementId=o||null,this.applied=!1}function l(e,t){t=t||"textContent",this.doc=e||document,this.classAppliers={},this.highlights=[],this.converter=a(t)}var u=e.dom,f=u.arrayContains,d=u.getBody,h=e.util.createOptions,g=e.util.forEach,p=1,m={};i.prototype.create=function(){var e=this.converterCreator();return e.type=this.type,e},e.registerHighlighterType=o,s.prototype={intersects:function(e){return this.start<e.end&&this.end>e.start},isContiguousWith:function(e){return this.start==e.end||this.end==e.start},union:function(e){return new s(Math.min(this.start,e.start),Math.max(this.end,e.end))},intersection:function(e){return new s(Math.max(this.start,e.start),Math.min(this.end,e.end))},getComplements:function(e){var t=[];if(this.start>=e.start){if(this.end<=e.end)return[];t.push(new s(e.end,this.end))}else t.push(new s(this.start,Math.min(this.end,e.start))),this.end>e.end&&t.push(new s(e.end,this.end));return t},toString:function(){return"[CharacterRange("+this.start+", "+this.end+")]"}},s.fromCharacterRange=function(e){return new s(e.start,e.end)};var v={rangeToCharacterRange:function(e,t){var n=e.getBookmark(t);return new s(n.start,n.end)},characterRangeToRange:function(t,n,r){var i=e.createRange(t);return i.moveToBookmark({start:n.start,end:n.end,containerNode:r}),i},serializeSelection:function(e,t){for(var n=e.getAllRanges(),r=n.length,i=[],o=1==r&&e.isBackward(),a=0,s=n.length;a<s;++a)i[a]={characterRange:this.rangeToCharacterRange(n[a],t),backward:o};return i},restoreSelection:function(e,t,n){e.removeAllRanges();for(var r,i,o,a=e.win.document,s=0,c=t.length;s<c;++s)i=t[s],o=i.characterRange,r=this.characterRangeToRange(a,i.characterRange,n),e.addRange(r,i.backward)}};o("textContent",function(){return v}),o("TextRange",function(){var t;return function(){if(!t){var n=e.modules.TextRange;if(!n)throw new Error("TextRange module is missing.");if(!n.supported)throw new Error("TextRange module is present but not supported.");
t={rangeToCharacterRange:function(e,t){return s.fromCharacterRange(e.toCharacterRange(t))},characterRangeToRange:function(t,n,r){var i=e.createRange(t);return i.selectCharacters(r,n.start,n.end),i},serializeSelection:function(e,t){return e.saveCharacterRanges(t)},restoreSelection:function(e,t,n){e.restoreCharacterRanges(n,t)}}}return t}}()),c.prototype={getContainerElement:function(){return r(this.doc,this.containerElementId)},getRange:function(){return this.converter.characterRangeToRange(this.doc,this.characterRange,this.getContainerElement())},fromRange:function(e){this.characterRange=this.converter.rangeToCharacterRange(e,this.getContainerElement())},getText:function(){return this.getRange().toString()},containsElement:function(e){return this.getRange().containsNodeContents(e.firstChild)},unapply:function(){this.classApplier.undoToRange(this.getRange()),this.applied=!1},apply:function(){this.classApplier.applyToRange(this.getRange()),this.applied=!0},getHighlightElements:function(){return this.classApplier.getElementsWithClassIntersectingRange(this.getRange())},toString:function(){return"[Highlight(ID: "+this.id+", class: "+this.classApplier.className+", character range: "+this.characterRange.start+" - "+this.characterRange.end+")]"}},l.prototype={addClassApplier:function(e){this.classAppliers[e.className]=e},getHighlightForElement:function(e){for(var t=this.highlights,n=0,r=t.length;n<r;++n)if(t[n].containsElement(e))return t[n];return null},removeHighlights:function(e){for(var t,n=0,r=this.highlights.length;n<r;++n)t=this.highlights[n],f(e,t)&&(t.unapply(),this.highlights.splice(n--,1))},removeAllHighlights:function(){this.removeHighlights(this.highlights)},getIntersectingHighlights:function(e){var t=[],n=this.highlights;return g(e,function(e){g(n,function(n){e.intersectsRange(n.getRange())&&!f(t,n)&&t.push(n)})}),t},highlightCharacterRanges:function(t,n,r){var i,o,a,l=this.highlights,u=this.converter,f=this.doc,d=[],p=t?this.classAppliers[t]:null;r=h(r,{containerElementId:null,exclusive:!0});var m,v,R,C=r.containerElementId,N=r.exclusive;C&&(m=this.doc.getElementById(C),m&&(v=e.createRange(this.doc),v.selectNodeContents(m),R=new s(0,v.toString().length)));var E,y,T,S,w,A;for(i=0,o=n.length;i<o;++i)if(E=n[i],w=[],R&&(E=E.intersection(R)),E.start!=E.end){for(a=0;a<l.length;++a)T=!1,C==l[a].containerElementId&&(y=l[a].characterRange,S=p==l[a].classApplier,A=!S&&N,(y.intersects(E)||y.isContiguousWith(E))&&(S||A)&&(A&&g(y.getComplements(E),function(e){w.push(new c(f,e,l[a].classApplier,u,null,C))}),T=!0,S&&(E=y.union(E)))),T?(d.push(l[a]),l[a]=new c(f,y.union(E),p,u,null,C)):w.push(l[a]);p&&w.push(new c(f,E,p,u,null,C)),this.highlights=l=w}g(d,function(e){e.unapply()});var O=[];return g(l,function(e){e.applied||(e.apply(),O.push(e))}),O},highlightRanges:function(t,n,r){var i=[],o=this.converter;r=h(r,{containerElement:null,exclusive:!0});var a,s=r.containerElement,c=s?s.id:null;return s&&(a=e.createRange(s),a.selectNodeContents(s)),g(n,function(e){var t=s?a.intersection(e):e;i.push(o.rangeToCharacterRange(t,s||d(e.getDocument())))}),this.highlightCharacterRanges(t,i,{containerElementId:c,exclusive:r.exclusive})},highlightSelection:function(t,n){var i=this.converter,o=!!t&&this.classAppliers[t];n=h(n,{containerElementId:null,selection:e.getSelection(this.doc),exclusive:!0});var a=n.containerElementId,c=n.exclusive,l=n.selection,u=l.win.document,f=r(u,a);if(!o&&t!==!1)throw new Error("No class applier found for class '"+t+"'");var d=i.serializeSelection(l,f),p=[];g(d,function(e){p.push(s.fromCharacterRange(e.characterRange))});var m=this.highlightCharacterRanges(t,p,{containerElementId:a,exclusive:c});return i.restoreSelection(l,d,f),m},unhighlightSelection:function(t){t=t||e.getSelection(this.doc);var n=this.getIntersectingHighlights(t.getAllRanges());return this.removeHighlights(n),t.removeAllRanges(),n},getHighlightsInSelection:function(t){return t=t||e.getSelection(this.doc),this.getIntersectingHighlights(t.getAllRanges())},selectionOverlapsHighlight:function(e){return this.getHighlightsInSelection(e).length>0},serialize:function(e){var t,r,i,o,s=this,c=s.highlights;return c.sort(n),e=h(e,{serializeHighlightText:!1,type:s.converter.type}),t=e.type,i=t!=s.converter.type,i&&(o=a(t)),r=["type:"+t],g(c,function(t){var n,a=t.characterRange;i&&(n=t.getContainerElement(),a=o.rangeToCharacterRange(s.converter.characterRangeToRange(s.doc,a,n),n));var c=[a.start,a.end,t.id,t.classApplier.className,t.containerElementId];e.serializeHighlightText&&c.push(t.getText()),r.push(c.join("$"))}),r.join("|")},deserialize:function(e){var t,n,i,o=e.split("|"),l=[],u=o[0],f=!1;if(!u||!(t=/^type:(\w+)$/.exec(u)))throw new Error("Serialized highlights are invalid.");n=t[1],n!=this.converter.type&&(i=a(n),f=!0),o.shift();for(var d,h,g,p,m,v,R=o.length;R-- >0;){if(v=o[R].split("$"),g=new s((+v[0]),(+v[1])),p=v[4]||null,f&&(m=r(this.doc,p),g=this.converter.rangeToCharacterRange(i.characterRangeToRange(this.doc,g,m),m)),d=this.classAppliers[v[3]],!d)throw new Error("No class applier found for class '"+v[3]+"'");h=new c(this.doc,g,d,this.converter,parseInt(v[2]),p),h.apply(),l.push(h)}this.highlights=l}},e.Highlighter=l,e.createHighlighter=function(e,t){return new l(e,t)}}),e},this);