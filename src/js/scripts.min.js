angular.module("miller",["ui.router","ngResource","ngSanitize","ngCookies","ngTagsInput","mgcrea.ngStrap","monospaced.elastic","LocalStorageModule","pascalprecht.translate","angular-embed","angular-embed.handlers","angularLoad","angularLazyImg","ngFileUpload","720kb.socialshare"]).constant("LOCALES",{locales:{en_US:"English"},preferredLocale:"en_US"}).constant("EVENTS",{SAVE:"save",DOWNLOAD:"download",MESSAGE:"message",BAD_REQUEST:"bad_request",PERMISSION_DENIED:"permission_denied",RESIZED:"resized",MARKDOWNIT_FULLSIZE:"markdownit_fullsize",MARKDOWNIT_RESOLVE:"markdownit_resolve",MARKDOWNIT_FOCUS:"markdownit_focus"}).config(function($locationProvider){$locationProvider.hashPrefix("!")}).config(function(tagsInputConfigProvider,RUNTIME){tagsInputConfigProvider.setDefaults("tagsInput",{replaceSpacesWithDashes:!1,template:RUNTIME["static"]+"templates/partials/tag.input.html"}).setDefaults("autoComplete",{loadOnDownArrow:!0})}).config(function(lazyImgConfigProvider){lazyImgConfigProvider.setOptions({offset:200,errorClass:"error",successClass:"loaded"})}).config(function($translateProvider,RUNTIME){$translateProvider.useSanitizeValueStrategy("sanitize"),$translateProvider.useStaticFilesLoader({prefix:RUNTIME["static"]+"locale/locale-",suffix:".json"}),$translateProvider.preferredLanguage("en_US")}).config(function(localStorageServiceProvider){localStorageServiceProvider.setPrefix("miller")}).config(function($resourceProvider){$resourceProvider.defaults.stripTrailingSlashes=!1}).config(function($httpProvider){$httpProvider.defaults.xsrfCookieName="Miller",$httpProvider.defaults.xsrfHeaderName="X-CSRFToken",$httpProvider.interceptors.push(function($q,$rootScope,EVENTS){return{responseError:function(rejection){return 400==rejection.status?$rootScope.$emit(EVENTS.BAD_REQUEST,rejection):403==rejection.status&&$rootScope.$emit(EVENTS.PERMISSION_DENIED,rejection),$q.reject(rejection)}}})}).config(function($locationProvider){$locationProvider.html5Mode({enabled:!0,requireBase:!1,rewriteLinks:!1})}).config(function(embedlyServiceProvider,RUNTIME){RUNTIME.oembeds.EMBEDLY_API_KEY&&embedlyServiceProvider.setKey(RUNTIME.oembeds.EMBEDLY_API_KEY)}).config(function($stateProvider,$urlRouterProvider,RUNTIME){$urlRouterProvider.otherwise("/"),$stateProvider.state("notfound",{url:"/not-found",controller:function($log){$log.warn("requested page not found.")},templateUrl:RUNTIME["static"]+"templates/index.html"}),$stateProvider.state("index",{url:"/",reloadOnSearch:!1,controller:"IndexCtrl",templateUrl:RUNTIME["static"]+"templates/index.html",resolve:{writings:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__slug:"highlights",status:"public"}),limit:7,ordering:"-date"}).$promise},news:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",status:"public"}),ordering:"-date"}).$promise}}}).state("index.signup",{url:"/",reloadOnSearch:!1,controller:"SignupCtrl",templateUrl:RUNTIME["static"]+"templates/signup.html"}).state("authors",{url:"/authors",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/authors.html",resolve:{items:function(ProfileFactory,$stateParams){return ProfileFactory.get({}).$promise},model:function(){return"profile"},factory:function(ProfileFactory){return ProfileFactory.get}}}).state("draft",{url:"/create",reloadOnSearch:!1,controller:"DraftCtrl",templateUrl:RUNTIME["static"]+"templates/draft.html"}).state("upload",{url:"/upload",reloadOnSearch:!1,controller:"UploadCtrl",templateUrl:RUNTIME["static"]+"templates/upload.html"}).state("uploaded",{url:"/uploaded/:storyId",reloadOnSearch:!1,controller:"UploadedCtrl",templateUrl:RUNTIME["static"]+"templates/uploaded.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}).state("writing",{url:"/writing/:storyId",reloadOnSearch:!1,controller:"WritingCtrl",templateUrl:RUNTIME["static"]+"templates/writings.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}),$stateProvider.state("author",{"abstract":!0,reloadOnSearch:!1,url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}",controller:"AuthorCtrl",templateUrl:RUNTIME["static"]+"templates/author.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}).state("author.publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope){$scope.urls=RUNTIME.stories.writing},templateUrl:RUNTIME["static"]+"templates/author.publications.html"}).state("author.publications.drafts",{url:"/drafts",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,author){return StoryFactory.get({filters:JSON.stringify({status:"draft",authors__slug:author.slug}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("author.publications.bin",{url:"/bin",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,author){return StoryFactory.get({filters:JSON.stringify({status:"deleted",authors__slug:author.slug}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("author.publications.all",{url:"/",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,author){return StoryFactory.get({filters:JSON.stringify({authors__slug:author.slug}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("author.publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams,author){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category__in:["writing","blog"],tags__slug:d.slug,authors__slug:author.slug}):JSON.stringify({tags__category__in:["writing","blog"],authors__slug:author.slug}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}})}),$stateProvider.state("modifyauthor",{url:"/author/{slug:[0-9a-zA-Z\\.\\-_]+}/edit",controller:"AuthorEditCtrl",templateUrl:RUNTIME["static"]+"templates/author.edit.html",resolve:{author:function(AuthorFactory,$stateParams){return AuthorFactory.get({slug:$stateParams.slug}).$promise}}}),$stateProvider.state("profile",{url:"/profile/{username:[0-9a-zA-Z\\.\\-_]+}",controller:"ProfileCtrl",templateUrl:RUNTIME["static"]+"templates/profile.html",reloadOnSearch:!1,resolve:{profile:function(ProfileFactory,$stateParams){return ProfileFactory.get({username:$stateParams.username}).$promise},authors:function(ProfileFactory,$stateParams){return ProfileFactory.authors({username:$stateParams.username}).$promise}}}).state("profile.publications",{url:"/publications",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,profile,$location){$location.search();return StoryFactory.get({filters:JSON.stringify({authors__user__username:profile.username}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),$stateProvider.state("reviews",{"abstract":!0,url:"/reviews",controller:function(){},templateUrl:RUNTIME["static"]+"templates/reviews.html",reloadOnSearch:!1}).state("reviews.all",{url:"",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(ReviewFactory,$stateParams){return ReviewFactory.get().$promise},model:function(){return"review"},factory:function(ReviewFactory){return ReviewFactory.get}}}).state("reviews.pending",{url:"/pending",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(ReviewFactory,$stateParams){return ReviewFactory.get({filters:JSON.stringify({status__in:["initial","draft"]})}).$promise},model:function(){return"review"},factory:function(ReviewFactory){return ReviewFactory.get}}}).state("reviews.reports",{url:"/reports",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(ReviewFactory,$stateParams){return ReviewFactory.reports().$promise},model:function(){return"report"},factory:function(ReviewFactory){return ReviewFactory.reports}}}),$stateProvider.state("review",{url:"/review/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.get({id:$stateParams.id}).$promise}}}).state("review.story",{url:"/story",controller:"StoryCtrl",templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(review){return review.story}}}),$stateProvider.state("report",{url:"/report/{id:[0-9]+}",controller:"ReviewCtrl",templateUrl:RUNTIME["static"]+"templates/review.html",resolve:{review:function(ReviewFactory,$stateParams){return ReviewFactory.report({id:$stateParams.id}).$promise}}}),$stateProvider.state("blog",{url:"/blog",reloadOnSearch:!1,"abstract":!0,controller:"BlogCtrl",templateUrl:RUNTIME["static"]+"templates/blog.html"}).state("blog.event",{url:"/events",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",tags__slug:"event"}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("blog.news",{url:"/news",reloadOnSearch:!1,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__category:"blog",tags__slug:"news"}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("publications",{url:"/publications","abstract":!0,reloadOnSearch:!1,controller:function($scope,$state){$scope.urls=RUNTIME.stories.writing,$state.params.slug&&($scope.slug=$state.params.slug)},templateUrl:RUNTIME["static"]+"templates/publications.html"}).state("publications.all",{url:"",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory){return StoryFactory.get({filters:JSON.stringify({tags__category:"writing"}),exclude:JSON.stringify({tags__slug:"chapter"}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}).state("publications.tags",{url:"/tags/:slug",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:JSON.stringify({tags__slug:$stateParams.slug}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}}),_.each(RUNTIME.stories.writing,function(d){$stateProvider.state("publications."+d.slug,{url:d.url,controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(StoryFactory,$stateParams){return StoryFactory.get({filters:d.slug?JSON.stringify({tags__category:"writing",tags__slug:d.slug}):JSON.stringify({tags__category:"writing"}),ordering:"-date,-date_last_modified"}).$promise},model:function(){return"story"},factory:function(StoryFactory){return StoryFactory.get}}})}),$stateProvider.state("search",{url:"/search?q&tags&authors",controller:"SearchCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/search.html",resolve:{items:function(StoryFactory,$location){var qs=$location.search();return StoryFactory.search(qs).$promise}}}),$stateProvider.state("story",{url:"/story/:postId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.postId}).$promise}}}),$stateProvider.state("collection",{url:"/collection/:collectionId",controller:"CollectionCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/collection.html",resolve:{collection:function(CollectionFactory,$stateParams){return CollectionFactory.get({id:$stateParams.collectionId}).$promise}}}).state("collection.story",{url:"/:storyId",controller:"StoryCtrl",reloadOnSearch:!1,templateUrl:RUNTIME["static"]+"templates/collection.story.html",resolve:{story:function(StoryFactory,$stateParams){return StoryFactory.get({id:$stateParams.storyId}).$promise}}}),$stateProvider.state("notifications",{"abstract":!0,url:"/notifications",controller:"NotificationsCtrl",templateUrl:RUNTIME["static"]+"templates/notifications.html"}).state("notifications.activities",{url:"/activities",controller:"ItemsCtrl",templateUrl:RUNTIME["static"]+"templates/items.html",resolve:{items:function(PulseFactory){return PulseFactory.activities().$promise},model:function(){return"action"},factory:function(PulseFactory){return PulseFactory.get}}}),$stateProvider.state("page",{url:"/:name",controller:"PageCtrl",templateUrl:RUNTIME["static"]+"templates/md.html",resolve:{page:function(PageFactory,$stateParams){return PageFactory.get({name:$stateParams.name})}}})}).run(function($window,$log,RUNTIME){$log.log("☕ app run, version: Happy Crocodile; analytics:",RUNTIME.settings.analytics?"enabled":"disabled"),RUNTIME.settings.analytics&&$window.ga("create",RUNTIME.settings.analytics||"UA-XXXXXXXX-X","auto")}),angular.module("miller").filter("prefixTemplate",function(RUNTIME){return function(input){return RUNTIME["static"]+input}}).filter("bibtex",function(){return function(text){return text?text.replace(/[\{\}]/g,""):""}}).filter("smartUrl",function(){return function(text){return(text||"").replace(/^https?:\/\/(www)?\.?([^\/]*)\/(.*)$/,function(m,www,domain,path){return domain+"/..."+path.substr(-25)})}}).filter("multilanguage",function($rootScope){return function(obj){return"object"!=typeof obj?obj:obj[$rootScope.language]}}).filter("tokenize",function(){return function(text,maxwords){if(!text)return"";var words=text.split(/(?!=\.\s)\s/),sentence=_.take(words,maxwords).join(" ");return sentence.length<text.length&&(sentence.match(/\?\!\.$/)||(sentence+=" "),sentence+="..."),sentence}}).filter("coverage",function(){return function(cover,hifi){var url,_hifi="hifi"==hifi;return"object"!=typeof cover?"":url=cover.metadata?_hifi?_.get(cover,"metadata.urls.Publishable")||cover.metadata.thumbnail_url||cover.metadata.preview||cover.metadata.url||cover.attachment||cover.snapshot:cover.metadata.thumbnail_url||cover.metadata.preview||_.get(cover,"metadata.urls.Preview")||cover.snapshot||cover.attachment||cover.metadata.url:_hifi?cover.attachment||cover.snapshot:cover.snapshot||cover.attachment}}).filter("substr",function(){return function(text,start,end){return text.substr(start,end)}}).filter("statetoclass",function(){return function(text){return(text||"").replace("."," ")}}).filter("quotes",function(){return function(text,language){var st={lq:{en_US:{"«":"“",'"':"“"},fr_FR:{"“":"«",'"':"«"}},rq:{en_US:{"»":"”",'"':"”"},fr_FR:{"”":"»",'"':"»"}}};return(text||"").replace(/([\s,;\?\.\!\[\]\(\)])(["«“])([^"»”]*)(["»”])([\s,;\?\.\!\[\]\(\)])/g,function(m,left,lq,quote,rq,right){return[left,st.lq[language][lq]||lq,quote,st.rq[language][rq]||rq,right].join("")})}}).filter("slugify",function(){return function(text){for(var strip=/[^\w\s-]/g,hyphen=/[-\s]+/g,slug=text.toLowerCase(),map={from:"àáäãâèéëêìíïîòóöôõùúüûñç·/_,:;",to:"aaaaaeeeeiiiiooooouuuunc------"},i=0,j=map.from.length;i<j;i++)slug=slug.replace(new RegExp(map.from.charAt(i),"g"),map.to.charAt(i));return slug.replace(strip,"").trim().replace(hyphen,"-")}}),angular.module("miller").service("parseHeaderFilename",function(){return function(headers){var header=headers("content-disposition"),result=header.split(";")[1].trim().split("=")[1];return result.replace(/"/g,"")}}).factory("AuthFactory",function($resource){return $resource("/auth/:fn/",{},{login:{method:"POST",params:{fn:"login"}},register:{method:"POST",fn:"register"}})}).factory("StoryFactory",function($resource,parseHeaderFilename){return $resource("/api/story/:id/:fn",{},{update:{method:"PUT"},search:{method:"GET",params:{fn:"search/"}},patch:{method:"PATCH"},download:{params:{fn:"download"},method:"GET",responseType:"arraybuffer",transformResponse:function(data,headers){return{data:data,filename:parseHeaderFilename(headers)}}}})}).factory("StoryTagsFactory",function($resource){return $resource("/api/story/:id/tags/",{},{update:{method:"PUT"}})}).factory("StoryDocumentsFactory",function($resource){return $resource("/api/story/:id/documents/",{},{update:{method:"PUT"}})}).factory("ProfileFactory",function($resource){return $resource("/api/profile/:username/:related",{},{authors:{method:"GET",params:{related:"authors/"}},update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("PulseFactory",function($resource){return $resource("/api/pulse/:fn/",{},{activities:{method:"GET"},reset:{method:"POST",params:{fn:"reset"}}})}).factory("CollectionFactory",function($resource){return $resource("/api/collection/:id/",{},{})}).factory("AuthorFactory",function($resource){return $resource("/api/author/:slug/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("DocumentFactory",function($resource){return $resource("/api/document/:id/",{},{update:{method:"PUT"}})}).factory("MentionFactory",function($resource){return $resource("/api/mention/:id/")}).factory("CaptionFactory",function($resource){return $resource("/api/caption/:id/",{},{update:{method:"PUT"},patch:{method:"PATCH"}})}).factory("CommentFactory",function($resource){return $resource("/api/comment/:id/",{},{})}).factory("ReviewFactory",function($resource){return $resource("/api/review/:id/:fn",{},{patch:{method:"PATCH"},report:{method:"GET",params:{fn:"report/"}},reports:{method:"GET",params:{fn:"reports/"}}})}).factory("TagFactory",function($resource){return $resource("/api/tag/:id/",{},{update:{method:"PUT"}})}).factory("PageFactory",function($http,RUNTIME){return{get:function(params){return $http.get(RUNTIME["static"]+"pages/"+params.name+".md")}}}).service("QueryParamsService",function($filter){return function(queryparams){var params={};return queryparams.replace(/[?&]+([^=&]+)=([^&]*)/gi,function(str,key,value){params[key]=decodeURIComponent(value)}),params}}).service("bibtexService",function($filter){return function(json){}}).service("markdownItLanguageService",function($filter){return function(value,language){var candidate;return candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value(),candidate["lang:"+language]?candidate["lang:"+language]:value}}).service("markdownItChaptersService",function($filter,markdownItLanguageService){return function(value,language){var links=[],linkIndex=0,md=new window.markdownit;return md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim();0===url.indexOf("voc/")&&(linkIndex++,links.push({_index:linkIndex,citation:tokens[idx+1].content,slug:url.replace("voc/","").split(",")[0],type:"chapter"}))},md.render(markdownItLanguageService(value,language)),links}}).service("markdownItService",function($filter){return function(value,language){var results,md=new window.markdownit({}),linkIndex=0;if(results={md:value,html:"",ToC:[],docs:[],paragraphs:0,footnotes:{}},md.use(window.markdownitFootnote).use(window.markdownitContainer,"profile").use(window.markdownitContainer,"profile-committee").use(window.markdownitContainer,"profile-others").use(window.markdownitContainer,"abstract").use(window.markdownItAttrs),md.renderer.rules.link_open=function(tokens,idx){var url=tokens[idx].attrGet("href").trim(),klass=tokens[idx].attrGet("class")||"";if(0===url.indexOf("doc/")){var doc=url.trim().replace("doc/","").replace(/\//g,"-").split(",")[0];return linkIndex++,results.docs.push({_index:linkIndex,_type:tokens[idx+1].content.length?"doc":"block-doc",citation:tokens[idx+1].content,slug:doc}),tokens[idx+1].content.length?'<a id="item-'+linkIndex+'" class="special-link" name="'+doc+'" ng-click="focus(\''+linkIndex+"','"+url+"', 'doc')\"><span hold slug=\""+doc+'" type="doc"  class="anchor-wrapper"></span><span class="icon icon-eye"></span>':'<span id="item-'+linkIndex+'" class="lazy-placeholder '+klass+'" type="doc" lazy-placeholder="'+doc+'"></span>'}if(0===url.trim().indexOf("voc/")){var terms=url.trim().replace("voc/","").split(",");for(var ind in terms)linkIndex++,results.docs.push({_index:linkIndex,_type:"voc",citation:tokens[idx+1].content,slug:terms[ind],type:"glossary"});return tokens[idx+1].content.length?(tokens[idx].attrSet("class","glossary"),'<a id="item-'+linkIndex+'" class="special-link glossary"  ng-click="focus(\''+linkIndex+'\')"><span hold slug="'+terms[0]+'" type="voc" class="anchor-wrapper"></span><span class="icon icon-arrow-right-circle"></span>'):'<span type="voc" lazy-placeholder="'+terms[0]+'">'+terms[0]}return'<a href="'+url+'" target="_blank">'},md.renderer.rules.table_open=function(tokens,idx){return'<table class="table">'},md.renderer.rules.link_close=function(tokens,idx){return tokens[idx-1].attrGet("href")?"</span>":"</a>"},md.renderer.rules.heading_open=function(tokens,idx){var text=tokens[idx+1].content,h={text:text,level:tokens[idx].tag.replace(/[^\d]/g,""),slug:$filter("slugify")(text)};return results.ToC.push(h),"<"+tokens[idx].tag+'><a name="'+h.slug+'" class="anchor" href="#'+h.slug+'"><span class="header-link"></span></a>'},console.log("rules",md.renderer.rules),md.renderer.rules.image=function(tokens,idx){var src=tokens[idx].attrGet("src"),title=tokens[idx].attrGet("title"),alt=tokens[idx].content;return 0===alt.indexOf("profile/")?'<div class="profile-thumb" style="background-image:url('+src+')"></div>':'<img src="'+src+'" title="'+title+'" alt="'+alt+'"/>'},md.renderer.rules.footnote_anchor=function(tokens,idx,options,env,slf){var caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return'<span class="footnote-anchor">'+caption.replace(/[\[\]]/g,"")+"</span>"},md.renderer.rules.footnote_ref=function(tokens,idx,options,env,slf){var id=slf.rules.footnote_anchor_name(tokens,idx,options,env,slf),caption=slf.rules.footnote_caption(tokens,idx,options,env,slf);return linkIndex++,results.docs.push({_index:linkIndex,_type:"footnote",id:id,caption:caption}),"<span  ng-click=\"focus('"+linkIndex+'\')" id="item-'+linkIndex+'" class="footnote-ref"><span class="footnote"><a>'+caption+"</a></span></span>"},value.replace(/[\n\s\r]*---[\n\r]((.|[\n\r])+)\.{3}[\n\s\r]*/m,function(d,m){return results.meta=m,""}),language){var candidate=_(value.split(/<!--\s*(lang:[a-zA-Z_]{2,5})\s*-->/)).compact().chunk(2).fromPairs().value();candidate["lang:"+language]&&(value=candidate["lang:"+language]),value=$filter("quotes")(value,language)}return results.html=md.render(value),results}}).factory("metadataFactory",function($log){return{parse:function(story){$log.info("[service] metadata.parse")},create:function(story){}}}),angular.module("miller").controller("AuthorCtrl",function($scope,$log,author){$scope.isMe=!!author.profile&&$scope.user.username==author.profile.username,$log.log("AuthorCtrl ready, author:",author.fullname),$scope.author=author}).controller("AuthorEditCtrl",function($scope,$state,$log,AuthorFactory,author,EVENTS){$log.log("AuthorEditCtrl ready, author:",author,$scope.previousState),$scope.author=author,$scope.isSaving=!1,$scope.save=function(){return $log.log("AuthorEditCtrl -> save()",$scope.author),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,void AuthorFactory.patch({slug:$scope.author.id},{fullname:[$scope.author.metadata.firstname,$scope.author.metadata.lastname].join(" "),metadata:JSON.stringify($scope.author.metadata),affiliation:$scope.author.affiliation},function(res){$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.isSaving=!1,$scope.previousState.from&&$scope.previousState.from.name&&$scope.previousState.from.name.length?$state.go($scope.previousState.from.name,$scope.previousState.fromParams):$state.go("author.publications.all",{slug:$scope.author.slug})},function(err){$log.error("error:",err.data),$scope.isSaving=!1}))}}),angular.module("miller").controller("BlogCtrl",function($scope,$log){$log.log("BlogCtrl ready")}),angular.module("miller").controller("CollectionCtrl",function($scope,$rootScope,$log,collection,EVENTS,StoryFactory,markdownItChaptersService){$log.log("CollectionCtrl ready",$scope.user.username,$scope.language),$scope.collection=collection,$scope.collection.isWritable=$scope.hasWritingPermission($scope.user,$scope.collection),collection.covers.length&&($scope.collection.cover=_.first(collection.covers)),$scope.setStatus=function(status){$log.debug("CollectionCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.collection.id},{title:$scope.collection.title,status:status},function(res){$scope.collection.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))};var links=markdownItChaptersService(collection.contents,$scope.language),stories=_.keyBy(collection.stories,"slug");$scope.chapters=_(links).map(function(d){return stories[d.slug]?stories[d.slug]:void $log.warn("chapter with slug: ",d.slug,"was not found in related stories!!!")}).compact().value()}),angular.module("miller").controller("CoreCtrl",function($rootScope,$scope,$log,$location,$window,$anchorScroll,$state,$modal,$alert,localStorageService,$translate,$timeout,StoryFactory,DocumentFactory,TagFactory,RUNTIME,EVENTS){$log.log("CoreCtrl ready, user:",RUNTIME.user.username,RUNTIME),$scope.user=$rootScope.user=RUNTIME.user,$scope.user.is_reviewer=_.map(RUNTIME.user.profile.groups,"name").indexOf("reviewers")!=-1,$scope.settings=RUNTIME.settings,$rootScope.page="index",$scope.hasToC=!1,$scope.ToCEnabled=!1,$scope.stopStateChangeStart=!1,$scope.toggleTableOfContents=function(){$scope.hasToC=!$scope.hasToC},$scope.locationPath="",$scope.toggleStopStateChangeStart=function(value){$log.debug("CoreCtrl > toggleStopStateChangeStart value:",value,"- current:",$scope.stopStateChangeStart),$scope.stopStateChangeStart="boolean"==typeof value?value:!$scope.stopStateChangeStart},$scope.setToC=function(ToC){$log.log("CoreCtrl > setToC data:",ToC),$scope.ToC=ToC},$scope.disableToC=function(){$scope.ToCDisabled=!0},$scope.search=function(searchquery){$log.log("CoreCtrl > search() searchquery:",searchquery),$state.go("search",{q:searchquery})},$scope.setDocuments=function(documents){if($log.log("CoreCtrl > setDocuments items n.:",documents.length,documents),$scope.documents=_.uniq(documents,"id"),$scope.qs.view)for(var i=0,j=$scope.documents.length;i<j;i++)if($scope.qs.view==$scope.documents[i].short_url){$scope.fullsized=$scope.documents[i],fullsizeModal.$promise.then(fullsizeModal.show);break}},$rootScope.resolve=function(slug,type,callback){if("voc"==type)$log.log("CoreCtrl > $scope.resolve [requesting] voc slug:",slug),StoryFactory.get({id:slug},callback);else{var matching=$scope.documents.filter(function(d){return d.slug==slug});matching.length?($log.log("CoreCtrl > $scope.resolve [cached] doc slug:",slug),callback(matching[0])):($log.log("CoreCtrl > $scope.resolve [requesting] doc slug:",slug),DocumentFactory.get({id:slug},callback))}},$scope.save=function(){$log.log("CoreCtrl > @SAVE ..."),$scope.$broadcast(EVENTS.SAVE)},$scope.download=function(){$log.log("CoreCtrl > @DOWNLOAD ..."),$scope.$broadcast(EVENTS.DOWNLOAD)},$scope.update=function(key,value){$log.log("CoreCtrl > @UPDATE ",key,":",value," ...");var _d={};_d[key]=value,$scope.$broadcast(EVENTS.UPDATE,_d)},$scope.lock=function(){$log.log("CoreCtrl > lock .............")},$scope.unlock=function(){$log.log("CoreCtrl > unlock .............")},$scope.suggestTags=function(query,options){$log.log("CoreCtrl -> suggestTags",query,options);var filters=options||{};return filters.name__icontains=query,TagFactory.get({filters:JSON.stringify(filters)}).$promise.then(function(response){return response.results})},$scope.breakingNews=[],$scope.setBreakingNews=function(breakingNews){$scope.breakingNews=breakingNews.slice(0,2).map(function(d){if(d.covers&&d.covers.length){var cover=d.covers[0];d.cover_url=_.get(cover,"metadata.thumbnail_url")||_.get(cover,"metadata.urls.Preview")||_.get(cover,"snapshot")||cover.url}return d.isCollection=_.filter(d.tags,{slug:"collection"}).length>0,d})},$rootScope.$on("$stateChangeStart",function(e,state){if($log.log("CoreCtrl @stateChangeStart new:",state.name,"- previous:",$scope.state),"login"==state.name&&$scope.user.short_url)return $log.warn("... cannot swithc to login, user already logged in:",$scope.user.username),e.preventDefault(),void($scope.state&&"login"!=$scope.state?$state.go($scope.state):$state.go("index"));if($scope.stopStateChangeStart===!0){var answer=confirm("Are you sure you want to leave this page?");answer||e.preventDefault()}}),$rootScope.$on("$stateChangeSuccess",function(e,state,stateParams,from,fromParams){var h=$location.hash();$scope.ToC=[],$scope.documents=[],$scope.state=state.name,$scope.previousState={from:from,fromParams:fromParams},$rootScope.page=_.compact(state.name.split(".").filter(function(d){return["page","all","story"].indexOf(d)==-1}).concat([$state.params.name,$state.params.storyId,$state.params.postId])).join(" - "),$scope.absoluteUrl=$rootScope.absoluteUrl=$state.href($state.current.name,$state.params,{absolute:!0}),$log.debug("CoreCtrl @stateChangeSuccess - name:",state.name,"- page:",$rootScope.page),h&&h.length&&$timeout($anchorScroll,0),$scope.toggleStopStateChangeStart(!1),$window.ga("send","pageview",$location.path())}),$scope.setHash=function(hash){$location.hash(hash)},$scope.changeLanguage=function(key){$scope.language=key,$rootScope.language=key,localStorageService.set("lang",$scope.language),$log.log("CoreCtrl -> changeLanguage language:",$scope.language),$translate.use(key)},$scope.isWithoutAuthors=function(story){return 0!==story.authors.length},$scope.hasWritingPermission=function(user,story){return!!user.username&&user.username.length>0&&(user.is_staff||story.owner.username==user.username)};var fullsizeModal=$modal({scope:$scope,template:RUNTIME["static"]+"templates/partials/modals/fullsize.html",id:"dii",show:!1});$scope.$on("modal.hide",function(e,modal){"dii"==modal.$id&&$location.search("view",null)}),$rootScope.fullsize=function(slug,type){$log.log("CoreCtrl -> fullsize, doc slug:",slug,type),"voc"==type?$state.go("story",{postId:slug}):$location.search("view",slug)},window.onbeforeunload=function(event){if($scope.state&&["draft","writing"].indexOf($scope.state)!==-1){var message="Sure you want to leave?";return"undefined"==typeof event&&(event=window.event),event&&(event.returnValue=message),message}},$scope.setOG=function(OG){$log.debug("CoreCtrl -> setOG",OG),$rootScope.OG=angular.extend({title:"",description:"",image:""},OG||{})},$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("CoreCtrl @locationChangeSuccess",path,$location),$scope.qs=$location.search(),$scope.locationPath=path,$scope.path=$location.path(),$scope.searchquery=$scope.qs.q,$scope.qs.view&&DocumentFactory.get({id:$scope.qs.view},function(res){$scope.fullsized=res,fullsizeModal.$promise.then(fullsizeModal.show)}),$scope.qs.view&&$scope.fullsized&&$scope.fullsized.short_url==$scope.qs.view?fullsizeModal.$promise.then(fullsizeModal.show):!$scope.qs.view&&$scope.fullsized&&fullsizeModal.hide();
}),$scope.setLocationFilter=function(field,value){$location.search(field,value)},$scope.removeLocationFilter=function(field){$location.search(field,null)},$scope.calculateBounds=function(event){$rootScope.isASmallScreen=$window.innerWidth<992},$rootScope.$on(EVENTS.BAD_REQUEST,function(e,rejection){$log.warn("@BAD_REQUEST."),400==rejection.status&&$alert({placement:"top",title:"form errors",animation:"bounceIn",content:_(rejection.data).map(function(d,k){return"<div><b>"+k+"</b>: "+d+"</div>"}).value().join(""),show:!0,type:"error"})}),$rootScope.$on(EVENTS.PERMISSION_DENIED,function(e,rejection){$log.warn("@PERMISSION_DENIED. Should redirect",$location.absUrl()),window.location.href="/login/?next="+$location.path()});var timer_event_message;$scope.$on(EVENTS.MESSAGE,function(e,message){$log.log("CoreCtrl @MESSAGE",message),$scope.message=message,timer_event_message&&$timeout.cancel(timer_event_message),timer_event_message=$timeout(function(){$scope.message=null},2e3)}),angular.element($window).bind("keydown",function(event){if(event.ctrlKey||event.metaKey)switch(String.fromCharCode(event.which).toLowerCase()){case"s":event.preventDefault(),$scope.save()}}),angular.element($window).bind("resize",$scope.calculateBounds),$scope.language=localStorageService.get("lang")||"en_US",$scope.changeLanguage($scope.language),StoryFactory.get({filters:JSON.stringify({tags__slug:"top",status:"public"})},function(data){$log.info("CoreCtrl breaking news loaded",data),$scope.setBreakingNews(data.results)}),$scope.calculateBounds()}),angular.module("miller").controller("DraftCtrl",function($scope,$log,$state,localStorageService,StoryFactory,EVENTS){$log.debug("DraftCtrl welcome"),$scope.isSaving=!1,$scope.save=function(){return $log.log("DraftCtrl -> save()"),$scope.isSaving?void $log.warn(" .. is still saving, be patient."):($scope.isSaving=!0,void StoryFactory.save({},{title:$scope.title,"abstract":$scope["abstract"],contents:"",status:"draft"},function(res){$scope.isSaving=!1,$scope.$emit(EVENTS.MESSAGE,"saved"),$log.log("DraftCtrl -> @EVENTS.SAVE saved:",res),$state.go("writing",{storyId:res.slug})},function(err){$log.error(err),$scope.isSaving=!1}))},$scope.$on(EVENTS.SAVE,function(){$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.save()})}),angular.module("miller").controller("IndexCtrl",function($scope,$log,$filter,writings,news){function excerpt(story){story.excerpt={},story.tags&&story.tags.length&&_.filter(story.tags,{slug:"collection",category:"writing"}).length&&(story.is_collection=!0);for(var i in story.metadata["abstract"])story.excerpt[i]=$filter("tokenize")(story.metadata["abstract"][i],32);return story}if($log.debug("IndexCtrl welcome",writings,news),$scope.setOG({type:"platform"}),writings.results=writings.results.map(excerpt),$scope.coverstory=writings.results.shift(),$scope.otherstories=writings.results,$scope.coverstory&&$scope.coverstory.covers.length){var maincover=_.first($scope.coverstory.covers);$scope.coverstory.cover=_.get(maincover,"metadata.thumbnail_url")||maincover.snapshot}$scope.news=news.results.map(excerpt),$log.debug("IndexCtrl welcome",$scope.news)}),angular.module("miller").controller("ItemsCtrl",function($scope,$log,$filter,items,model,factory,QueryParamsService){function normalizeItems(items){return items.map(function(d){return d.metadata&&d.metadata["abstract"]?(d.tags&&d.tags.length&&_.filter(d.tags,{slug:"collection",category:"writing"}).length&&(d.isCollection=!0),d.metadata["abstract"][$scope.language]?(d.excerpt=$filter("tokenize")(d.metadata["abstract"][$scope.language],32),d):d):d})}$log.log("ItemsCtrl ready, n.:",items.count,"- items:",items),$scope.model=model,$scope.sync=function(res){$scope.isLoadingNextItems=!1,next=QueryParamsService(res.next||""),console.log("ItemsCtrl > sync()",next),$scope.count=res.count,$scope.items=($scope.items||[]).concat(normalizeItems(res.results)),$scope.missing=res.count-$scope.items.length},$scope.more=function(){return $scope.isLoadingNextItems?void $log.warn("is still loading"):($scope.isLoadingNextItems=!0,void factory(next,$scope.sync))},$scope.sync(items)}),angular.module("miller").controller("LoginCtrl",function($scope,$log,AuthFactory,$location){$log.log("👉 LoginCtrl ready"),$scope.login=function(){$log.debug("👉 LoginCtrl > login"),$scope.pwd&&$scope.pwd.length&&$scope.username&&$scope.username&&AuthFactory.login({username:$scope.username,password:$scope.pwd},function(res){$location.url("/")},function(err){$log.error("👉 LoginCtrl > login error:",err.data)})}}),angular.module("miller").controller("NotificationsCtrl",function($scope,$log,RUNTIME){$log.log("⏱ NotificationsCtrl ready")}),angular.module("miller").controller("PageCtrl",function($scope,$log,page){$log.log("PageCtrl ready",page.status),$scope.md=page.data,$scope.setOG()}),angular.module("miller").controller("ProfileCtrl",function($scope,$log,profile,authors){$log.log("ProfileCtrl ready, profile:",profile,authors),$scope.profile=profile,$scope.authors=authors.results}),angular.module("miller").controller("PulseCtrl",function($scope,$log,RUNTIME){if($log.log("⚡ PulseCtrl ready"),!RUNTIME.settings.wshost)return void $log.warn("⚡ PulseCtrl disabled, no wshost received; please check your miller settings.");var socket=window.socket=new ReconnectingWebSocket(RUNTIME.settings.wshost+"?session_key="+RUNTIME.settings.session_key);socket.onmessage=function(e){$log.log("⚡ -> ",e.data,e)},socket.onopen=function(){$log.log("⚡ online")},socket.onclose=function(e){$log.warn("socket closed.",e)},socket.onerror=function(e){$log.error("socket error",e)},socket.readyState==WebSocket.OPEN&&socket.onopen()}),angular.module("miller").controller("ReviewCtrl",function($scope,$log,$state,review,ReviewFactory,RUNTIME,EVENTS){$log.log("⏱ ReviewCtrl ready"),$scope.fields=["thematic","interest","originality","innovation","interdisciplinarity","methodology","clarity","argumentation","structure","references","pertinence"],$scope.availableStatuses=["draft","complete","refusal","bounce"],$scope.reviewStatus=""+review.status,$scope.is_editable="draft"==review.status||"initial"==review.status,$scope.save=function(){if($log.debug("⏱ ReviewCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0,answers={};for(s in $scope.fields){var field=$scope.fields[s];answers[field]=$scope.review[field],answers[field+"_score"]=$scope.review[field+"_score"]||0}answers.contents=JSON.stringify($scope.review.contents),answers.status="draft",ReviewFactory.patch({id:review.id},answers,function(review){$scope.review=review,$log.debug("⏱ ReviewCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"error!"),$scope.unlock(),$scope.isSaving=!1})},$scope.finalize=function(status){return $log.debug("⏱ ReviewCtrl -> finalize() status:",status),$scope.$emit(EVENTS.MESSAGE,"closing the review"),$scope.lock(),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,void ReviewFactory.patch({id:review.id},{status:status},function(res){$log.debug("⏱ ReviewCtrl -> finalize(): success",res),$scope.unlock(),$scope.isSaving=!1,$state.go("report",{id:review.id})},function(err){$log.warn("⏱ ReviewCtrl @SAVE: error",err),$scope.$emit(EVENTS.MESSAGE,"Your request cannot be resolved. Is the review submitted already?"),$scope.unlock(),$scope.isSaving=!1}))},$scope.$watch("review",function(r,p){r&&($scope.points=_.filter(r,function(d,k){return k.indexOf("_score")!=-1}).reduce(function(a,b){return a+b}),$scope.is_valid=$scope.points>=$scope.fields.length,$log.log("⏱ ReviewCtrl @review - points:",$scope.points,"- can be submitted:",$scope.is_valid))},!0),$scope.review=review,$scope.$on(EVENTS.SAVE,$scope.save)}),angular.module("miller").controller("SearchCtrl",function($scope,$log,items,$stateParams,$location,StoryFactory){$log.debug("SearchCtrl welcome",$stateParams.query),$scope.count=items.count,$scope.items=items.results,$scope.query=$stateParams.query,$scope.$on("$locationChangeSuccess",function(e,path){$log.debug("SearchCtrl @$locationChangeSuccess",$scope.qs),StoryFactory.search(angular.extend({q:$scope.query},$scope.qs),function(res){$scope.count=res.count,$scope.items=res.results},function(err){})})}),angular.module("miller").controller("SignupCtrl",function($scope,$log){$log.debug("SignupCtrl welcome")}),angular.module("miller").controller("StoryCtrl",function($rootScope,$scope,$log,story,StoryFactory,EVENTS){$scope.story=story,$scope.story.isWritable=$scope.hasWritingPermission($scope.user,$scope.story),$scope.story.isUnderReview="review"==story.status||"editing"==story.status,$scope.layout="inline",$scope.setOG({title:story.metadata.title[$scope.language]||story.title,description:story.metadata["abstract"][$scope.language]||story["abstract"],image:_(story.covers).map(function(d){return _.get(d,"snapshot")||_.get(d,"metadata.thumbnail_url")||_.get(d,"metadata.urls.Publishable")||_.get(d,"metadata.urls.Preview")||_.get(d,"metadata.url")}).first()}),$scope.setStatus=function(status){$log.debug("StoryCtrl -> setStatus - status:",status),$scope.user.is_staff&&($scope.$emit(EVENTS.MESSAGE,"saving"),StoryFactory.update({id:$scope.story.id},{title:$scope.story.title,status:status},function(res){console.log("StoryCtrl -> setStatus - new status:",res),$scope.story.status=res.status,$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock()}))},$scope.download=function(){StoryFactory.download({id:$scope.story.id}).$promise.then(function(result){var url=URL.createObjectURL(new Blob([result.data])),a=document.createElement("a");a.href=url,a.download=result.filename,a.target="_blank",a.click()})["catch"](function(error){console.log(error)})},$scope.listener=function(event,data,callback){switch($log.log("StoryCtrl > listener, event:",event,data),event){case EVENTS.MARKDOWNIT_FOCUS:$scope.focusedIdx=data.idx;break;case EVENTS.MARKDOWNIT_FULLSIZE:$rootScope.fullsize(data.slug.replace(/\//g,"-"),data.type);break;case EVENTS.MARKDOWNIT_RESOLVE:$rootScope.resolve(data.slug.replace(/\//g,"-"),data.type,callback)}},$log.log("StoryCtrl ready, title:",story.title,"isWritable:",$scope.story.isWritable),$scope.setDocuments=function(items){$log.log("StoryCtrl > setDocuments items n.:",items.length,items);var documents=[];$scope.sidedocuments=0,documents=_(items).map(function(d){for(var i=0;i<story.documents.length;i++)if(story.documents[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.documents[i]);for(i=0;i<story.stories.length;i++)if(story.stories[i].slug==d.slug)return $scope.sidedocuments+=!!d.citation.length,angular.extend({_type:d._type,_index:d._index,citation:d.citation},story.stories[i]);return $scope.sidedocuments++,d}).value(),$log.log("StoryCtrl > setDocuments items n.:",items.length,"- documents n:",documents.length,"- sideDocuments:",$scope.sidedocuments),$scope.$parent.setDocuments(documents)}}),angular.module("miller").controller("UploadCtrl",function($scope,$state,$log,Upload,EVENTS){$log.debug("UploadCtrl welcome"),$scope.uploadable={title:"","abstract":""},$scope.$watch("docx",function(v){v&&($log.debug("UploadCtrl @docx",v.name,v.size),$scope.uploadable.docx=v,$scope.uploadable.name=v.name,$scope.uploadable.size=v.size)}),$scope.upload=function(){return $log.debug("UploadCtrl -> upload()"),$scope.createForm.$valid?!$scope.uploadable.docx||$scope.uploadable.docx.$error?void $log.warn("UploadCtrl -> upload() cannot find a valid docx file"):void Upload.upload({url:"/api/story/",data:{title:$scope.uploadable.title,"abstract":$scope.uploadable["abstract"],source:$scope.uploadable.docx}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status&&($log.debug("UploadCtrl -> upload() status:","success!",res.data),$state.go("story",{postId:res.data.slug}))},null,function(evt){var progressPercentage=parseInt(100*evt.loaded/evt.total);$log.log("progress: "+progressPercentage+"% "+evt.config.data.source.name)}):void $log.warn("UploadCtrl -> upload() errors:",$scope.createForm.$error)}}),angular.module("miller").controller("UploadedCtrl",function($scope,$log,story){$log.debug("UploadedCtrl welcome",story),$scope.story=story}),angular.module("miller").controller("WritingCtrl",function($scope,$log,$q,$modal,$filter,story,localStorageService,StoryFactory,StoryTagsFactory,StoryDocumentsFactory,CaptionFactory,MentionFactory,DocumentFactory,EVENTS,RUNTIME){$log.debug("WritingCtrl writing title:",story.title,"-id:",story.id,"- current language:",$scope.language),$scope.isDraft=!1,$scope.isSaving=!1,$scope.isCollection=!1,$scope.story=story,"object"!=typeof $scope.story.metadata&&($scope.story.metadata={title:{},"abstract":{}}),["title","abstract"].forEach(function(field){$scope.language&&!$scope.story.metadata[field][$scope.language]&&($scope.story.metadata[field][$scope.language]=story[field])}),$scope.id=story.id,$scope.title=$scope.story.metadata.title[$scope.language],$scope["abstract"]=$scope.story.metadata["abstract"][$scope.language],$scope.contents=story.contents,$scope.keywords=_.filter(story.tags,{category:"keyword"}),$scope.displayedTags=_.filter(story.tags,function(d){return"collection"==d.slug&&($scope.isCollection=!0),"keyword"!=d.category}),$scope.metadata={status:story.status,owner:story.owner},$scope.setStatus=function(status){$scope.metadata.status=status,$scope.save()};var initialItems={doc:_.map(story.documents,"slug"),voc:_.map(story.stories,"slug")};$scope.setDocuments=function(items){$log.log("WritingCtrl -> setDocuments()",items.length);for(var tobesaved={doc:[],voc:[]},tobedeleted={doc:[],voc:[]},tobekept={doc:[],voc:[]},i=0;i<items.length;i++){var t="block-doc"==items[i]._type?"doc":items[i]._type;initialItems[t]&&(initialItems[t].indexOf(items[i].slug)===-1?tobesaved[t].push(items[i].slug):tobekept[t].push(items[i].slug))}tobedeleted.doc=_.difference(initialItems.doc,tobekept.doc,tobesaved.doc),tobedeleted.voc=_.difference(initialItems.voc,tobekept.voc,tobesaved.voc),$log.log("... tobesaved:",tobesaved),$log.log("... tobedeleted:",tobedeleted),$log.log("... tobekept:",tobekept),(tobesaved.voc.length||tobedeleted.voc.length||tobesaved.doc.length||tobedeleted.doc.length)&&$q.all(_.compact(_.uniq(tobesaved.doc).map(function(slug){var p=CaptionFactory.save({story:story.id,document:{slug:slug}},function(res){$log.warn("... CaptionFactory.save success",res)},function(err){$log.warn("... CaptionFactory.save failed",err)}).promise;return p}).concat(_.uniq(tobesaved.voc).map(function(slug){$log.log("... saving voc->story slug:",slug);var p=MentionFactory.save({from_story:story.id,to_story:{slug:slug}},function(res){$log.log("... saving voc->story success",res)},function(err){$log.warn("... saving voc->story success failed miserably: ",err)}).promise;return p})).concat(_.uniq(tobedeleted.doc).map(function(slug){$log.log("... deleting doc->story slug:",slug)})).concat(_.uniq(tobedeleted.voc).map(function(slug){$log.log("... deleting voc->story slug:",slug)})))).then(function(results){$log.log("... setDocuments() done. Results:",results),results.length&&$scope.save()})},$scope.setCover=function(doc){$log.debug("WritingCtrl -> setCover() doc:",doc.id),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{covers:[doc.id]}).$promise.then(function(res){$log.debug("WritingCtrl -> setCover() doc success",res),$scope.story.covers=[doc],$scope.unlock(),$scope.isSaving=!1})},$scope.removeCover=function(doc){return $log.debug("WritingCtrl -> removeCover() doc:",doc.id),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,$scope.lock(),void StoryFactory.patch({id:story.id},{covers:[]}).$promise.then(function(res){$log.debug("WritingCtrl -> removeCover() doc success",res),$scope.story.covers=[],$scope.unlock(),$scope.isSaving=!1},function(err){$log.error("WritingCtrl -> removeCover() doc error",err),$scope.unlock(),$scope.isSaving=!1}))},$scope.references=[],$scope.lookups=[],$scope.attachTag=function(tag){return $log.debug("WritingCtrl -> attachTag() tag",arguments),$scope.isSaving?void $log.warn("wait, try again in. Is still saving."):($scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.compact(_.map($scope.displayedTags,"id").concat(_.map($scope.keywords,"id")))}).$promise.then(function(res){return $log.debug("WritingCtrl -> attachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return $scope.unlock(),$scope.isSaving=!1,!1}))},$scope.detachTag=function(tag){return $log.debug("WritingCtrl -> detachTag() tag",arguments,$scope.displayedTags),$scope.isSaving=!0,$scope.lock(),StoryFactory.patch({id:story.id},{tags:_.map($scope.displayedTags,"id")}).$promise.then(function(res){return $log.debug("WritingCtrl -> detachTag() tag success",res),$scope.unlock(),$scope.isSaving=!1,!0},function(){return!1})},$scope.suggestReferences=function(service){service||DocumentFactory.get(function(){console.log("list")})};var coversModal=$modal({controller:"CoversModalCtrl",templateUrl:RUNTIME["static"]+"templates/partials/modals/covers.html",show:!1,scope:$scope});$scope.openCoversModal=function(){coversModal.$promise.then(function(){$log.log("WritingCtrl -> openCoversModal()"),coversModal.show()})},$scope.save=function(){if($log.debug("WritingCtrl @SAVE"),$scope.$emit(EVENTS.MESSAGE,"saving"),$scope.lock(),$scope.isSaving)return void $log.warn("wait, try again in. Is still saving.");$scope.isSaving=!0;var update=angular.extend({title:$scope.title,"abstract":$scope["abstract"],contents:$scope.contents,metadata:JSON.stringify($scope.story.metadata),date:$scope.date},$scope.metadata);StoryFactory.update({id:story.id},update,function(res){console.log(res),$log.debug("WritingCtrl @SAVE: success"),$scope.$emit(EVENTS.MESSAGE,"saved"),$scope.unlock(),$scope.isSaving=!1,$scope.toggleStopStateChangeStart(!1)},function(){$scope.isSaving=!1})},$scope.$on(EVENTS.SAVE,$scope.save),$scope.$watch("contents",function(v,p){v&&v!=p&&$scope.toggleStopStateChangeStart(!0)}),$scope.$watch("language",function(v,p){v&&v!=p&&(["title","abstract"].forEach(function(d){$scope[d]=$scope.story.metadata[d][v]||$scope[d]}),$log.log("WritingCtrl @language"))}),$scope.$watch("title",function(v){$scope.language&&($scope.story.metadata.title[$scope.language]=v)}),$scope.$watch("abstract",function(v){$scope.language&&($scope.story.metadata["abstract"][$scope.language]=v)})}),angular.module("miller").controller("CoversModalCtrl",function($scope,$log,QueryParamsService,DocumentFactory){$log.info("CoversModalCtrl ready with crazy scope, n. covers:",$scope.story.covers.length),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{caption__story__owner__username:$scope.user.username,contents__icontains:query}:{caption__story__owner__username:$scope.user.username})},function(res){$log.debug("CoversModalCtrl - tab.favourite > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.favourite > init"),this.suggest($scope.query||"")}},all:{name:"all",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,isNextPage){var $s=this;$log.debug("CoversModalCtrl - tab.all > suggest",$s),$s.isLoadingNextItems=!0,isNextPage||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.debug("CoversModalCtrl - tab.all > suggest loaded n.docs:",res.results.length,"- total:",res.count,"-filters:",QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.debug("CoversModalCtrl - tab.all > init"),this.suggest($scope.query||"")}}},$scope.selectDocument=function(doc){$log.debug("CoversModalCtrl -> selectDocument() id:",doc.id),$scope.selectedDocument&&$scope.selectedDocument.id==doc.id?($scope.isSomethingSelected=!1,$scope.selectedDocument=!1):($scope.isSomethingSelected=!0,$scope.selectedDocument=angular.copy(doc))},$scope.addDocument=function(){return $scope.selectedDocument?($log.debug("CoversModalCtrl -> addDocument() id:",$scope.selectedDocument.id),$scope.setCover($scope.selectedDocument),void $scope.$hide()):void $log.warn("CoversModalCtrl -> addDocument() no document has been selected")},$scope.setTab=function(tabname){$log.debug("CoversModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.debug("CoversModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.more=function(query,tab){$log.debug("CoversModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab("favourite")}),angular.module("miller").controller("EnrichModalCtrl",function($timeout,$scope,$log,QueryParamsService,DocumentFactory,StoryFactory,OembedSearchFactory,embedService,localStorageService,Upload){$log.info("EnrichModalCtrl ready with crazy scope, language:",$scope.language),$scope.tabs={favourite:{name:"favourite",items:[],count:0,next:void 0,isLoadingNextItems:!1,suggest:function(query,keep){var $s=this;$log.log("tab.favourite > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),DocumentFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("tab.favourite > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},glossary:{name:"glossary",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;$log.log("tab.glossary > suggest",$s),$s.isLoadingNextItems=!0,keep||($s.next=void 0),StoryFactory.get($s.next||{filters:JSON.stringify(query.length>2?{contents__icontains:query,tags__category__in:["writing","blog"],status:"public"}:{tags__category__in:["writing","blog"],status:"public"})},function(res){$log.log("tab.glossary > suggest loaded n.docs:",res.results.length,QueryParamsService(res.next||"")),$s.items=$s.next?($s.items||[]).concat(res.results):res.results,$s.count=res.count,$s.missing=res.count-$s.items.length,$s.next=QueryParamsService(res.next||""),$s.isLoadingNextItems=!1})},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},url:{name:"url",items:[],suggest:function(url,keep){},onEmbedChange:function(){$log.log("EMC @embed embed.type:",$scope.embed.type),$scope.embed.html&&"link"==$scope.embed.type&&($scope.embed.type="rich")},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.url||"")}},CVCE:{name:"CVCE",items:[],count:0,next:void 0,suggest:function(query,keep){var $s=this;return $log.log("tab.CVCE > suggest - query:",query),$s.isLoadingNextItems=!0,OembedSearchFactory.CVCE?void(!query||query.length<3||(keep||($s.next=void 0),OembedSearchFactory.CVCE($s.next||{q:query}).then(function(res){$log.log("tab.CVCE > suggest loaded n.docs:",res.data.count),$s.items=$s.next?($s.items||[]).concat(res.data.results):res.data.results,$s.count=res.data.count,$s.missing=res.data.count-$s.items.length,$s.next=QueryParamsService(res.data.next||""),$s.query=query,$s.isLoadingNextItems=!1},function(){}))):void $log.error("OembedSearchFactory.CVCE does not exist")},init:function(){$log.log("init",this),localStorageService.set("lasttabname",this.name),this.suggest($scope.query||"")}},upload:{name:"upload",items:[],undo:function(){$scope.uploadable=null,$scope.uploadablefile={}},upload:function(){if(!$scope.uploadablefile)return void $log.warn("no file is selected");var types={"image/jpg":"image","image/png":"image","application/pdf":"pdf"};Upload.upload({url:"/api/document/",data:{title:$scope.uploadablefile.title||$scope.uploadablefile.name,type:types[$scope.uploadablefile.type]||$scope.uploadablefile.type.split("/").shift(),mimetype:$scope.uploadablefile.type,metadata:JSON.stringify({bibtex:$scope.reference,copyright:$scope.uploadablefile.copyright}),attachment:$scope.uploadablefile.f}}).then(function(res){$log.debug("UploadCtrl -> upload() status:",res.status),201==res.status?($log.debug("UploadCtrl -> upload() status:","success!",res.data),$scope.uploadablefile.progressPercentage=0,$scope.uploadablefile.document=res.data,$scope.selectDocument($scope.uploadablefile.document)):$log.error(res)},null,function(evt){$scope.uploadablefile.progressPercentage=parseInt(1e4*evt.loaded/evt.total)/100,$log.log("progress: "+$scope.uploadablefile.progressPercentage+"% "+evt.config.data,$scope.uploadablefile.name,evt)})},init:function(){$log.log("init",this),$scope.uploadable=null,$scope.uploadablefile={},localStorageService.set("lasttabname",this.name)}}},$scope.uploadablefile={},$scope.$watch("uploadable",function(v){v&&($log.debug("::mde @uploadable",v),$scope.uploadablefile.f=v,$scope.uploadablefile.name=v.name,$scope.uploadablefile.size=v.size,$scope.uploadablefile.type=v.type)});var timer_preview;$scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/^(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?($scope.isUrlValid=!0,url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),$scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),$scope.embed=data,$scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),$scope.suggestMessage="(url is not valid)",$scope.isUrlValid=!1,$scope.embed=null,!1)},$scope.setTab=function(tabname){$log.log("EnrichModalCtrl -> setTab() tab.name:",tabname),$scope.tab=$scope.tabs[tabname],$scope.tab.init()},$scope.suggest=function(query){$log.log("EnrichModalCtrl -> suggest() q:",query),$scope.tab.suggest(query)},$scope.upload=function(query){$log.log("EnrichModalCtrl -> upload()"),$scope.tab.upload()},$scope.undo=function(){$log.log("EnrichModalCtrl -> undo()"),$scope.tab.undo()},$scope.more=function(query,tab){$log.log("EnrichModalCtrl -> more()"),$scope.tab.suggest(query,!0)},$scope.setTab(localStorageService.get("lasttabname")||"favourite")}),angular.module("miller").directive("embedit",function($sce,$timeout){return{restrict:"A",scope:{embedit:"=",stretch:"=",language:"=",firstline:"="},link:function(scope,element,attrs){var stretching,options={breaks:!0,linkify:!0},disable=["image","heading"],stretching_timeout=1e4;scope.do_strech=function(){var els=element.find("iframe").width("100%").height("100%");stretching&&$timeout.cancel(stretching),els.length?(element.css("opacity",1),console.log("embedit :: iframe Stretched.")):stretching_time>stretching_timeout?console.warn("embedit :: skipping stretching iframe, time exceeded."):(console.log("embedit :: iframe not found, but stretch is set to true. Calling do_stretch again in a few ms..."),stretching=$timeout(scope.do_strech,300),stretching_time+=300)},scope.render=function(language){if(scope.embedit){if(language&&"object"==typeof scope.embedit){var altlanguage=scope.language.replace(/_[A-Z][A-Z]$/,""),contents=scope.embedit[language]||scope.embedit[altlanguage]||"";if(attrs.markdown){var md=new window.markdownit(options).disable(disable);contents=md.render(contents)}scope.firstline&&(contents=contents.split(/<br\s?\/?>/).shift()),element.html(contents)}else if(attrs.markdown){var md=new window.markdownit(options).disable(disable);contents=md.render(scope.embedit),element.html(contents)}else element.html(scope.embedit);if(scope.stretch&&scope.do_strech(),attrs.autoplay){var src=element.find("iframe").attr("src");element.find("iframe").attr("src",src+(src.indexOf("?")==-1?"?":"&")+"autoplay=1"),console.log("embedit :: Activating autoplay on iframe...",src)}}},scope.stretch&&element.css("opacity",0),scope.language&&"object"==typeof scope.embedit?scope.$watch("language",scope.render):scope.render()}}}),angular.module("miller").directive("footnote",function($compile,RUNTIME){return{restrict:"A",scope:{caption:"=",footnote:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/footnote.html",link:function(scope,element,attrs){var footnoteSl="#fn"+scope.footnote+" p",contents=$(footnoteSl).clone(),wrapper=element.find(".footnote-contents");wrapper.html(contents),$compile(wrapper.contents())(scope),scope.isOpened=!!attrs.isOpened,scope.toggleFootnote=function(){console.log("::footnote > toggleFootnote")},scope.fullsize=function(slug,type){scope.$parent.fullsize?scope.$parent.fullsize(slug,type):$log.error(":: footnote > fullsize is without hanlders.")}}}}),angular.module("miller").directive("lazyImage",function($log){return{restrict:"A",scope:{src:"="},link:function(scope,element,attrs){function wakeup(){element.css({"background-size":attrs.size||"cover","background-position":"center center","background-repeat":"no-repeat","background-image":"url("+scope.src+")"}),element.find(".loading").hide()}$log.log(":::lazy on ",scope.src),element.addClass("lazy-box").css({"background-color":"#B7B2B2"}).html('<div class="loading">...</div>'),scope.$watch("src",function(v){v&&wakeup()})}}}).directive("lazyPlaceholder",function($log,$rootScope,$compile,RUNTIME){return{scope:{},templateUrl:RUNTIME["static"]+"templates/partials/placeholder.html",link:function(scope,element,attrs){var slug=element.attr("lazy-placeholder"),type=element.attr("type");scope.type=type,scope.user=$rootScope.user,scope.language=$rootScope.language,$log.log("⏣ lazy-placeholder on type:",type,"- slug:",slug,"lang"),scope.complete=function(res){res?(scope.resolved=res,$log.log("⏣ lazy-placeholder resolved for type:",type,"- slug:",slug),$compile(element.contents())(scope)):$log.error("⏣ lazy-placeholder cannot find slug:",slug)},$rootScope.resolve&&"string"==typeof slug&&$rootScope.resolve(slug,type,scope.complete),scope.fullsize=function(slug,type){$rootScope.fullsize(slug,type)}}}}).directive("respectPreviousSibling",function($log,$timeout){return{scope:{update:"="},restrict:"A",link:function(scope,element,attrs){function setHeight(){$log.log("🚀 respect-previous-sibling > setHeight()"),$timeout.cancel(p),p=$timeout(function(){element.height(Math.max(element.prev()[0].offsetHeight,attrs.minHeight||300))},500)}$log.log("🚀 respect-previous-sibling ready");var p;setHeight(),angular.element(window).bind("resize",setHeight)}}}),angular.module("miller").directive("markdownit",function($compile,$log,$location,markdownItService,EVENTS){return{restrict:"A",scope:{markdownit:"=",settoc:"&",setdocs:"&",language:"=",watchlanguage:"=",listener:"&"},link:function(scope,element,attrs){function parse(){if(!scope.markdownit||!scope.markdownit.length)return void $log.warn(":: markdownit parse() without any markdown text! Check the value for `markdownit`");var results=markdownItService(scope.markdownit,scope.language);scope.resources=results.docs,element.html(results.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({
ToC:results.ToC}),scope.setdocs&&scope.setdocs({items:results.docs})}var previousFocus;scope.hash=function(what){$location.hash(what)},scope.focus=function(idx){$log.log(":: markdownit > focus - idx:",idx),previousFocus&&previousFocus==idx&&scope.listener?(previousFocus=0,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:0}})):scope.listener&&(previousFocus=idx,scope.listener({event:EVENTS.MARKDOWNIT_FOCUS,data:{idx:idx}}))},scope.fullsize=function(slug,type){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_FULLSIZE,data:{slug:slug.replace(/^[^\/]*\//,""),type:type}})},scope.resolve=function(slug,type,notify){scope.listener&&scope.listener({event:EVENTS.MARKDOWNIT_RESOLVE,data:{slug:slug,type:type},callback:notify})},scope.watchlanguage&&scope.language?scope.$watch("language",function(language){language&&parse()}):parse()}}}).directive("marked",function($compile,$log,$location,markedService){return{restrict:"A",scope:{marked:"=",settoc:"&",setdocs:"&",language:"="},link:function(scope,element,attrs){function init(){if(!scope.marked||!scope.marked.length)return void $log.warn(":: marked init(), no text to be marked");var rendered=markedService(scope.marked,scope.language);element.html(rendered.html),$compile(element.contents())(scope),scope.settoc&&scope.settoc({ToC:rendered.ToC}),scope.setdocs&&scope.setdocs({items:rendered.docs})}new marked.Renderer;scope.hash=function(what){$location.hash(what)},scope.miller=function(url){},scope.language?scope.$watch("language",function(language){language&&init()}):init()}}}),angular.module("miller").directive("mde",function($log,$timeout,$modal,$filter,DocumentFactory,StoryFactory,OembedSearchFactory,embedService,markdownItService,angularLoad,RUNTIME){return{restrict:"AE",scope:{mde:"=",settoc:"&",setdocs:"&",language:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/mde.html",link:function(scope,el,attributes){$log.log("::mde lib loading..."),angularLoad.loadScript(RUNTIME["static"]+"js/lib/simplemde.min.js").then(function(){function init(){function move(){timer&&clearTimeout(timer),timer=setTimeout(function(){simplemde.codemirror.display.cursorDiv.firstChild&&(cursor={top:simplemde.codemirror.display.cursorDiv.firstChild.offsetTop,left:simplemde.codemirror.display.cursorDiv.firstChild.offsetLeft,height:simplemde.codemirror.display.cursorDiv.firstChild.offsetHeight},wand.css("transform","translateY("+(cursor.top+cursor.height-20)+"px)"),followCursor&&toolbox.css("transform","translate("+cursor.left+"px,"+cursor.top+"px)"),pos=simplemde.codemirror.getCursor("start"),stat=simplemde.codemirror.getTokenAt(pos),scope.activeStates=(stat.type||"").split(" "),scope.$apply())},20)}function beforeSelectionChange(e,sel){var isSelection=sel.ranges[0].head.ch-sel.ranges[0].anchor.ch!==0;isSelection&&isSelection!=_isSelection?toolbox.addClass("active"):isSelection||isSelection==_isSelection||toolbox.removeClass("active"),_isSelection=isSelection}function recompile(){var marked=markdownItService(simplemde.value()),ToCHash=md5(JSON.stringify(marked.ToC)),docsHash=md5(_.map(marked.docs,"slug").join("--"));_ToCHash!=ToCHash&&($log.log("::mde -> recompile() items ToC:",marked.ToC.length,"docs:",marked.docs.length,ToCHash),scope.settoc({items:marked.ToC})),_docsHash!=docsHash&&($log.log("::mde -> recompile() items docs:",_docsHash),scope.setdocs({documents:marked.docs})),_ToCHash=ToCHash,_docsHash=docsHash}function onUpdate(e){var value=simplemde.value();textarea.val()!=value&&(scope.mde=value,textarea.val(value)),move(),timer_recompile&&clearTimeout(timer_recompile),timer_recompile=setTimeout(function(){recompile(),scope.$apply()},500)}function onChange(e,change){var from=change.from,text=change.text.join("\n"),to=(change.removed.join("\n"),simplemde.codemirror.posFromIndex(simplemde.codemirror.indexFromPos(from)+text.length));simplemde.codemirror.markText(from,to,{className:"mde-modified"})}function beforeChange(){}textarea.show(),wand.show(),toolbox.show(),simplemde=new SimpleMDE({element:textarea[0],spellChecker:!1,status:!1,toolbar:!1,toolbarTips:!1,initialValue:scope.mde});var cursor,pos,stat,followCursor,_isSelection,_ToCHash,_docsHash;simplemde.codemirror.on("update",onUpdate),simplemde.codemirror.on("cursorActivity",move),simplemde.codemirror.on("beforeSelectionChange",beforeSelectionChange),simplemde.codemirror.on("beforeChange",beforeChange),simplemde.codemirror.on("change",onChange),scope.settoc&&(timer_recompile=setTimeout(recompile,20))}$log.log("::mde lib loading done."),scope.activeStates=[],scope.isReady=!0,scope.isPreviewEnabled=!1,$log.log("::mde @link, language:",scope.language);var simplemde,timer,timer_recompile,timer_preview,wand=el.find(".wand").hide(),textarea=el.find("textarea").hide(),toolbox=el.find(".toolbox").hide(),referenceModal=$modal({scope:scope,title:"h",controller:"EnrichModalCtrl",template:RUNTIME["static"]+"templates/partials/modals/mde-enrich.html",show:!1});scope.setTab=function(tab){scope.tab=tab},scope.tab="CVCE",scope.previewUrl=function(url){timer_preview&&$timeout.cancel(timer_preview);var regexp=/(ftp|http|https):\/\/(\w+:{0,1}\w*@)?(\S+)(:[0-9]+)?(\/|\/([\w#!:.?+=&&#37;@!\-\/]))?/;return regexp.test(url)?(url=url.replace("#",".hash."),void(timer_preview=$timeout(function(){$log.debug("::mde -> previewUrl() url:",url),scope.suggestMessage="(loading...)",embedService.get(url).then(function(data){$log.debug(":: mde -> previewUrl() received:",data),scope.embed=data,scope.suggestMessage="(<b>done</b>)"})},20))):($log.error("::mde -> previewUrl() url provided:",url,"is not valid"),!1)};scope.suggestResults=[],scope.suggestMessage="",scope.suggest=function(query,service){if($log.log("::mde -> suggest()",scope.query,query,OembedSearchFactory),query.length<3)return scope.suggestMessage="(write something more)",void(scope.suggestResults=[]);if(scope.lookups=[],scope.count=0,scope.next=void 0,scope.suggestMessage="(loading...)","favourite"==service)return void DocumentFactory.get({filters:JSON.stringify(query.length>2?{contents__icontains:query}:{})},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.lookups=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"});if("glossary"==service){var params={tags__slug:"glossary"};return query.length>2&&(params.contents__icontains=query),void StoryFactory.get({filters:JSON.stringify(params)},function(res){$log.log("::mde -> showReferenceModal documents loaded",res.results.length),scope.glossary=res.results,scope.suggestMessage="(<b>"+res.count+"</b> results)"})}OembedSearchFactory[service]&&OembedSearchFactory[service](query).then(function(res){scope.suggestResults=res.data.results,scope.suggestMessage="(<b>"+res.data.count+"</b> results)"})},scope.showReferenceModal=function(){return scope.activeStates.indexOf("link")!==-1?void $log.warn("oh dear, you should not click on it"):void referenceModal.$promise.then(function(){$log.log("::mde -> showReferenceModal called"),referenceModal.show()})},scope.addDocument=function(type,contents,reference,url,embed){var slug;return $log.debug("::mde -> addDocument() type:",type),"bibtex"==type?void $log.debug("    reference:",bibtexParse.toJSON(reference)):"glossary"==type?(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"voc/"+scope.selectedDocument.slug})):"url"==type?embed.title?(slug=$filter("slugify")(embed.title).substr(0,100),reference&&(embed.bibtex=reference),void DocumentFactory.save({title:embed.title,contents:JSON.stringify(embed),metadata:JSON.stringify(embed),type:(embed.type||"link").toLowerCase(),url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&"slug"==_.keys(err.data).join("")?SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}):$log.error("::mde -> addDocument() cannot save document",err)})):(referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:url})):scope.selectedDocument?"CVCE"==type?(slug="cvce-"+scope.selectedDocument.details.doi,$log.debug("::mde -> addDocument() doc:",slug),void DocumentFactory.save({title:scope.selectedDocument.title,contents:JSON.stringify(scope.selectedDocument),metadata:JSON.stringify(scope.selectedDocument),type:(scope.selectedDocument.type||"link").toLowerCase(),slug:slug,url:url},function(res){$log.debug("::mde -> addDocument() document saved:",res.slug,res.id,res.short_url),res.slug&&(referenceModal.hide(),SimpleMDE.drawLink(simplemde,{url:"doc/"+res.slug}))},function(err){err.data.slug&&($log.debug("::mde -> addDocument() document already saved:",slug),SimpleMDE.drawLink(simplemde,{url:"doc/"+slug}))})):("bibtex"==scope.selectedDocument.type&&SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug}),$log.debug("::mde -> addDocument() doc:",scope.selectedDocument),referenceModal.hide(),void SimpleMDE.drawLink(simplemde,{url:"doc/"+scope.selectedDocument.slug})):void $log.warn("::mde -> addDocument() no document selected")},scope.selectDocument=function(doc){$log.log("::mde -> selectDocument()",doc.id),scope.selectedDocument&&scope.selectedDocument.id==doc.id?(scope.isSomethingSelected=!1,scope.selectedDocument=!1):(scope.isSomethingSelected=!0,scope.selectedDocument=angular.copy(doc))},scope.action=function(action){"togglePreview"==action&&(scope.isPreviewEnabled=!scope.isPreviewEnabled),SimpleMDE[action](simplemde)},$timeout(init,50)})}}}),angular.module("miller").directive("rating",function(){return{restrict:"EA",template:'<ul class="star-rating" ng-class="{readonly: readonly}">  <li ng-repeat="star in stars" class="star" ng-class="{filled: star.filled}" ng-click="toggle($index)">    <i class="icon icon-star"></i>  </li></ul>',scope:{ratingValue:"=ngModel",max:"=?",onRatingSelect:"&?",readonly:"=?"},link:function(scope,element,attributes){function updateStars(){scope.stars=[];for(var i=0;i<scope.max;i++)scope.stars.push({filled:i<(scope.ratingValue||0)})}void 0==scope.max&&(scope.max=5),scope.toggle=function(index){if(void 0==scope.readonly||scope.readonly===!1){scope.ratingValue=index+1,"function"==typeof scope.onRatingSelect&&scope.onRatingSelect({rating:index+1});for(var i in scope.stars){if(!(i<scope.ratingValue))break;scope.stars[i].filled=!0}}},scope.$watch("ratingValue",function(oldValue,newValue){newValue&&updateStars()}),updateStars()}}}),angular.module("miller").directive("richOembed",function($sce,$log,$timeout,RUNTIME){return{restrict:"A",scope:{enabled:"=",oembed:"=",cover:"=",autoplay:"=",fullscreen:"&"},templateUrl:RUNTIME["static"]+"templates/partials/directives/rich-oembed.html",link:function(scope,element,attrs){var timer;scope.iframeEnabled=!1,$log.log("🍩 rich-oembed ready, cover:",scope.cover,"- autoplay:",scope.autoplay,"- type:",scope.oembed.type),scope.$watch("enabled",function(v){$log.debug("🍩 rich-oembed @enabled:",v),scope.toggleEnable(!!v)}),scope.toggleFullscreen=function(){$log.debug("🍩 rich-oembed > toggleFullscreen:",typeof scope.fullscreen),scope.fullscreen()},scope.toggleEnable=function(enabled){$log.log("🍩 rich-oembed > toggleEnable()",enabled);var v=void 0===enabled?!scope.iframeEnabled:enabled;timer&&$timeout.cancel(timer),timer=$timeout(function(){$log.log("🍩 rich-oembed apply iframeEnabled:",v),scope.iframeEnabled=v},100)}}}}),angular.module("miller").directive("slidingSteps",function($log,$rootScope,RUNTIME,$timeout){return{restrict:"A",scope:{items:"=",focus:"=",language:"="},templateUrl:RUNTIME["static"]+"templates/partials/directives/sliding-steps.html",link:function(scope,element,attrs){function scrollTo(to,callback,duration){function move(amount){document.documentElement.scrollTop=amount,document.body.parentNode.scrollTop=amount,document.body.scrollTop=amount}function position(){return document.documentElement.scrollTop||document.body.parentNode.scrollTop||document.body.scrollTop}var start=position(),change=to-start,currentTime=0,increment=20;duration="undefined"==typeof duration?360:duration;var animateScroll=function(){currentTime+=increment;var val=easeInOutQuad(currentTime,start,change,duration);move(val),currentTime<duration?requestAnimFrame(animateScroll):callback&&"function"==typeof callback&&callback()};animateScroll()}$log.log("⏣ sliding-steps ready, items.length:",_.map(scope.items,"_index"),scope.items.length,scope.items);var lastIdxSelected,sideOffset=0,refOffset=0,parentOffset=element.offset().top,steps=element.find(".sliding-steps"),stepswrapper=steps.parent(),stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,translateY=0;scope.user=$rootScope.user;var requestAnimFrame=function(){return window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||function(callback){window.setTimeout(callback,1e3/60)}}(),easeInOutQuad=function(t,b,c,d){return t/=d/2,t<1?c/2*t*t+b:(t--,-c/2*(t*(t-2)-1)+b)};scope.reach=function(idx,sideoffset,refOffset,step){stepswrapperHeight=stepswrapper[0].offsetHeight,stepsHeight=steps[0].offsetHeight;var expectedOffset=refOffset-sideoffset,visibleOffset=-(sideoffset+step[0].offsetHeight-stepswrapperHeight);$log.log("⏣ sliding-steps > reach idx:",idx,"- side offset:",sideoffset,"- ref offset:",refOffset,"- parentOffset:",parentOffset,"- expectedOffset:",expectedOffset,"- visibleOffset:",visibleOffset,"- step[0].offsetHeight: ",step[0].offsetHeight),translateY=Math.min(expectedOffset,visibleOffset),steps.css("transform","translateY("+translateY+"px)"),scope.isMoreTop=expectedOffset<-2,scope.isMoreBottom=stepsHeight+translateY>stepswrapperHeight},scope.prev=function(){$log.log("⏣ sliding-steps > prev - idx:",lastIdxSelected,"- isMoreTop:",scope.isMoreTop),scope.isMoreTop&&(steps.children().each(function(i,d){return d.offsetTop+translateY>0?(console.log("...",target),!1):void(target=+d.id.replace("step-",""))}),target&&scope.alignTo(target))},scope.next=function(){$log.log("⏣ sliding-steps > next - idx:",lastIdxSelected,"- steps",steps),steps.children().each(function(i,d){return i<lastIdxSelected||(console.log("...",d.offsetTop+d.offsetHeight+translateY,stepswrapperHeight,d.offsetTop+d.offsetHeight+translateY<stepswrapperHeight),d.offsetTop+d.offsetHeight+translateY>stepswrapperHeight?(scope.alignTo(+d.id.replace("step-","")),!1):void 0)})},scope.isMoreTop=!1,scope.isMoreBottom=stepsHeight>stepswrapperHeight,scope.fullsize=function(slug,type){$log.log("⏣ sliding-steps > fullsize slug:",slug),$rootScope.fullsize(slug,type)},scope.align=function(idx,_sideOffset,_refOffset){var item=angular.element("#item-"+idx),step=element.find("#step-"+idx);return sideoffset=_sideOffset||step[0].offsetTop,refOffset=_refOffset||item[0].offsetTop,lastIdxSelected==idx-1?void scope.reset(item):(void 0!==lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active")),item.addClass("active"),lastIdxSelected=idx-1,scope.items[idx-1].isFocused=!0,void scope.reach(idx,sideoffset,refOffset,step))},scope.reset=function(){lastIdxSelected&&(scope.items[lastIdxSelected].isFocused=!1,angular.element("#item-"+(lastIdxSelected+1)).removeClass("active"),lastIdxSelected=void 0)},scope.alignTo=function(idx){$log.log("⏣ sliding-steps > alignTo -idx:",idx);var step=element.find("#step-"+idx);sideOffset=step[0].offsetTop,refOffset=angular.element("#item-"+idx)[0].offsetTop;var wrapperOffset=element.parent().offset().top;$log.log("⏣ sliding-steps > alignTo idx:",idx,"- side offset:",sideOffset,"- ref offset:",refOffset,"- win height:",window.innerHeight/3,"- parentOffset:",parentOffset,"- current scrollY:",window.scrollY),scrollTo(refOffset+wrapperOffset-window.innerHeight/2),scope.align(idx,sideOffset,refOffset,step)},scope.$watch("focus",function(idx){idx?($log.log("⏣ sliding-steps @focus - idx:",idx,scope.items[idx-1]),scope.align(idx)):0===idx&&scope.reset()}),$timeout(function(){stepsHeight=steps[0].offsetHeight,stepswrapperHeight=stepswrapper[0].offsetHeight,scope.isMoreBottom=stepsHeight>stepswrapperHeight},1e3)}}}),angular.module("miller").run(["$templateCache",function($templateCache){$templateCache.put("/static/templates/author.edit.html","<div class='container'>\n  <div class='view'>\n    <h2>{{author.fullname}}</h2>\n<form ng-submit=\"save()\">\n  <div class=\"row\">\n    <div class=\"col-sm-6\">\n    <p>\n    <label>\n      <span translate=\"field.label.firstname\"></span>\n    </label>\n    <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.metadata.firstname'  type='text'></textarea>\n    </p>\n    </div>\n    <div class=\"col-sm-6\">\n    <p>\n    <label>\n      <span translate=\"field.label.lastname\"></span>\n    </label>\n    <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.metadata.lastname'  type='text'></textarea>\n    </p>\n    </div>\n  </div>\n  \n\n  <p>\n  <label>\n    <span translate=\"field.label.affiliation\"></span>\n  </label>\n  <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.affiliation'  type='text'></textarea>\n  </p>\n\n  <p>\n  <label>\n    <span translate=\"field.label.bio\"></span>\n  </label>\n  <textarea class='elastic-textarea' rows=\"1\" msd-elastic ng-model='author.metadata.biography'  type='text' placeholder='short biography'></textarea>\n  </p>\n\n  <div class=\"btn-line-group primary\">\n  <button class=\"btn-line\" type=\"submit\">\n    <span ng-if='!isSaving' translate='button.save'></span>\n    <span ng-if='isSaving' translate='button.issaving'></span>\n  </button>\n  </div>\n</form>\n</div>\n</div>"),$templateCache.put("/static/templates/author.html","<div class='container'>\n  <div class='view'>\n    <h2>{{author.fullname}}</h2>\n    <div class='affiliation sans-serif' embedit='author.affiliation' language='language'></div>\n    \n    <div embedit='author.metadata.biography' markdown='true' language='language'></div>\n    \n    <div ui-view></div>\n  \n    <div ng-if='isMe || user.is_staff' class='actions'>\n      <div class='btn-line-group primary'>\n        <button ui-sref='modifyauthor({slug: author.slug})' class='btn-line' translate=\"button.edit.author\"></button>\n      </div>\n    </div>\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/author.publications.html",'\n\n<h3 ng-if=\'isMe\' translate="me.publications"></h3>\n<h3 ng-if=\'!isMe\' translate="latest publications"></h3>\n<!-- Nav tabs -->\n  <ul class=\'nav nav-tabs\'>\n    <li role="presentation" ui-sref-active="active" >\n      <a href ui-sref=\'author.publications.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.all.label"></a>\n    </li>\n    <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n      <a href ui-sref=\'author.publications.{{link.slug}}({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="{{link.name}}"></a>\n    </li>\n    \n    <li ng-if=\'isMe\' ui-sref-active="active">\n      <a href ui-sref=\'author.publications.drafts({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="drafts"></a>\n    </li>\n    <li ng-if=\'isMe\' ui-sref-active="active">\n      <a href ui-sref=\'author.publications.bin({username: author.profile.username})\' aria-controls="home" role="tab" data-toggle="tab" translate="bin"></a>\n    </li>\n  </ul>\n  \n\n<div ui-view></div>\n'),$templateCache.put("/static/templates/authors.html","\n<h2 translate=\"headline.authors\"></h2>\n<ul class=\"nav nav-tabs ng-scope\">\n</ul>\n<div ui-view>\n  <div class='post' ng-repeat='profile in items'>\n    <div class='wrapper'>\n      <div ng-if=\"!$first\" class=\"divider ng-scope\"></div>\n      <div class='tags'><span class='tag'>author</span></div>\n      <h3><a ui-sref=\"author.publications({username: profile.user.username})\">{{profile.user.first_name}} {{profile.user.last_name}}</a></h3>\n      <div class='type'>{{profile.user.username}}</div>\n      <div markdown='profile.bio|| \"...\"'></div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/blog.html",'<div class=\'container\'>\n<div class=\'view\'>\n<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.blog.title"></h1>\n\n    <!-- <blockquote translate="headline.blog.abstract"></blockquote> -->\n\n    </div>\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class="nav nav-tabs" role="tablist">\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.event\' aria-controls="home" role="tab" data-toggle="tab" translate="state.blog.events.label"></a></li>\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'blog.news\' aria-controls="profile" role="tab" data-toggle="tab" translate="state.blog.news.label"></a></li>\n</ul>\n\n<div ui-view></div>\n</div>\n</div>'),$templateCache.put("/static/templates/collection.html","<div class=\"collection\" ng-class='state|statetoclass'>\n\n  \n\n  <div class='container'>\n    <div class=\"view\">\n      \n\n      <div class=\"actions\" ng-if='state==\"collection\"'>\n        <div ng-if='collection.isWritable' class='btn-line-group primary'>\n          <button  class='btn-line' nref ui-sref='writing({storyId:collection.slug})'>edit</button>\n        </div>\n\n        <div ng-if='user.is_staff' class='btn-line-group'>\n          <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": collection.status==\"draft\"}' translate=\"collection.status.draft\"></button>\n          <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": collection.status==\"public\"}' translate=\"story.status.public\"></button>\n        </div>\n      </div>\n    </div>\n\n\n  </div>\n  \n  \n\n  <div class='container'>\n    <div class='row'>\n      <div class='col-md-12'>\n        <div class=\"tags\" >\n          <!-- <span ng-if=\"collection.tags.length\" class='tag sans-serif' ng-repeat='tag in collection.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span> -->\n          <span class='tag sans-serif'>\n            <span class='tag writing'><a ui-sref='publications.collection'>collection</a></span>\n          </span>\n        </div>\n        <h1 class='collection-title'><a ui-sref='collection({storyId:collection.slug})' embedit='collection.metadata.title' language='language'></a></h1>\n        \n        <!-- <div class='authors' ng-if=\"collection.authors.length\">\n          by <span ng-repeat='author in collection.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n        </div> -->\n        \n      </div>\n    </div>\n\n    <!-- <div class='row'>\n      <div class='col-md-12'>\n        <h1 embedit='collection.metadata.title' language='language'></h1>\n        <blockquote embedit='collection.metadata.abstract' language='language'></blockquote>\n      </div>\n    </div> -->\n  </div>\n\n\n  \n  <div class='container' style=\"\">\n    <div class='row'>\n      <div class=\"col-sm-12\">\n        <ul class='pagination'>\n          <li ui-sref-active=\"active\" class='special'>\n            <a ui-sref='collection({storyId:collection.slug})' translate='index'>&nbsp;</a>\n          </li>\n          <li ui-sref-active=\"active\" ng-repeat=\"story in chapters\">\n            <a ui-sref='collection.story({storyId:story.slug})'>{{$index + 1}}</a>\n          </li>\n\n        </ul>\n      </div>\n    </div>\n  </div>\n\n  <div ui-view  >\n    <div class='container'>\n    <div class=\"cover-wrapper\" ng-if='collection.cover'>\n      <div class='image-wrapper cover' lazy-img='{{collection.cover.attachment || collection.cover.metadata.preview || collection.cover.metadata.urls.Preview || collection.cover.metadata.thumbnail_url || collection.cover.metadata.url }}'></div>\n      <div class='metadata-wrapper' ng-init='document=collection.cover' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate''></div>\n    </div>\n    </div>\n    <div class='container'>\n      <div class='row'>\n        <div class=\"col-sm-12\">\n        <p class='collection-abstract' embedit='collection.metadata.abstract' language='language'></p>\n        </div>\n      </div>\n    </div>\n    <div  ng-repeat=\"story in chapters\">\n      <div class='container'>\n        <div class=\"chapter\" ng-class='{\"last\": $last}'>\n\n          <a class=\"number\" ui-sref='collection.story({storyId:story.slug})'>{{$index + 1}}</a>\n          <div class='col-md-6'>\n            <div class=\"inner\">\n              <div class=\"divider\"></div>\n              <div class=\"tags\" ng-if=\"story.tags.length\">\n                <span class=\"tag\" ng-repeat='tag in story.tags|filter:{ category: \"writing\", status:\"public\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n              </div>\n              <h2><a ui-sref='collection.story({storyId:story.slug})' embedit='story.metadata.title' language='language'></a></h2>\n              <blockquote embedit='story.metadata.abstract' language='language'></blockquote>\n            </div>\n          </div>\n          <div class='col-md-6' style='padding:0'>&nbsp;\n            <div ng-if='story.covers.length' class=\"cover\" ng-repeat='document in story.covers' class='fluid-container'>\n              <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n            </div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/collection.story.html","<div class=\"story\">\n  \n\n  \n\n  <div class='overlay'>\n    <div class='container'>\n      \n\n      <div class='row'>\n        <div class='col-md-12'>\n\n          <div class=\"actions\" >\n            <div ng-if='story.isWritable' class='btn-line-group primary'>\n              <button  class='btn-line' nref ui-sref='writing({storyId:story.slug})'>edit</button>\n            </div>\n\n            <div ng-if='user.is_staff' class='btn-line-group'>\n              <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": story.status==\"draft\"}' translate=\"collection.status.draft\"></button>\n              <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": story.status==\"public\"}' translate=\"story.status.public\"></button>\n            </div>\n          </div>\n\n          <h1><span class=\"\" embedit='story.metadata.title' language='language'></span></h1>\n          \n          <!-- story reference and cite as buttons -->\n          <div embedit='story.metadata.reference' ng-if='story.metadata.reference' markdown='true' language='language'></div>\n          \n          <!-- social share buttons: -->\n          <div ng-if='story.status == \"public\"' ng-include='\"templates/partials/story.socialshare.html\"|prefixTemplate'></div>\n\n          \n          <blockquote embedit='story.metadata.abstract' language='language'></blockquote>\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n\n\n        </div>\n\n        \n      </div>\n      <div ng-if='story.covers.length' class=\"main cover\" ng-repeat='document in story.covers'>\n        <!-- <div class='row'>\n          <div class='col-md-8'> -->\n          <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.metadata' cover='document.metadata.media_url || document.metadata.urls.Publishable || document.metadata.urls.Preview || document.metadata.thumbnail_url || document.snapshot || document.metadata.url'></div>\n          \n          <!-- </div> -->\n          \n          <!-- <div class='col-md-4'> -->\n          <div class='metadata-wrapper' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate''></div>\n          \n          <!-- </div> -->\n        <!-- </div> -->\n        </div>\n     <!--  <div ng-if='story.covers.length' class=\"main cover\" ng-repeat='document in story.covers'>\n\n          <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.metadata' cover='document.metadata.media_url || document.metadata.urls.Publishable || document.metadata.urls.Preview || document.metadata.thumbnail_url || document.metadata.url'></div>\n         \n            <div class='metadata-wrapper' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate''></div>\n      \n      </div> -->\n\n\n      <div class='row' style='margin-bottom: 50px'>\n        <div  ng-class='{\"col-md-12\": !documents.length, \"col-md-8 col-lg-7\": documents.length}'>\n          <div class=\"contents\">\n            <div markdownit='story.contents' language='language' listener='listener(event, data, callback)' settoc='setToC(ToC)' setdocs='setDocuments(items)'></div>\n          </div>\n        </div>\n        <div class='col-md-4 col-lg-5' ng-if='documents.length' respect-previous-sibling update=\"documents\">\n          <div sliding-steps data-language='language' data-focus='focusedIdx' style='height:100%' items='documents'></div>\n        </div>\n      </div>\n      <!-- <div style='margin-top: 50px' disqus=\"story.slug\"></div> -->\n    </div>\n  </div>\n</div>\n"),$templateCache.put("/static/templates/draft.html","<div class='container'>\n<div class='view'>\n  <p>\n    <label>\n      <span translate=\"field.label.title\"></span>\n    </label>\n    <textarea id='draft-title' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='title'   type='text' placeholder='Untitled'></textarea>\n  </p>\n  <p>\n    <label>\n      <span translate=\"field.label.abstract\"></span>\n    </label>\n    <textarea id='draft-abstract' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='abstract' type='text' placeholder='abstract'></textarea>\n  </p>\n\n  <div class='actions'>\n    <div class='btn-line-group primary'>\n      <button ng-click='save()' class='btn-line'><span translate=\"button.create\"></span></button>\n    </div>\n  </div>\n</div>\n</div>"),$templateCache.put("/static/templates/events.html",'<h2>events</h2>\n<!-- Nav tabs -->\n<ul class="nav nav-tabs" role="tablist">\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'events.everything\' aria-controls="home" role="tab" data-toggle="tab">everything</a></li>\n  <li role="presentation" ui-sref-active="active"><a href ui-sref=\'events.events\' aria-controls="profile" role="tab" data-toggle="tab">working seminars</a></li>\n</ul>\n\n<div ui-view></div>'),$templateCache.put("/static/templates/index.html","<div class=\"container\">\n<div class=\"view\">\n<div class=\"row\">\n  <div class=\"col-md-8\">\n\n    <!-- CONVER STORY -->\n    <div class=\"coverstory story lite\">\n      <div class=\"tags\" ng-if=\"coverstory.tags.length\">\n        <span class=\"tag\" ng-repeat='tag in coverstory.tags|filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n\n      <h3>\n        <a ng-if='!story.is_collection' href ui-sref=\"story({postId: coverstory.slug})\" embedit='coverstory.metadata.title' language='language'></a>\n        <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: coverstory.slug})\" embedit='coverstory.metadata.title' language='language'></a>\n      </h3>\n      <div class='authors' ng-if=\"coverstory.authors.length\">\n        by <span ng-repeat='author in coverstory.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      <blockquote>\n        <span embedit='coverstory.excerpt' language='language'></span>\n        <a ng-if='!coverstory.is_collection' href ui-sref=\"story({postId: coverstory.slug})\"><span class='icon-arrow-right-circle'></span></a>\n        <a ng-if='coverstory.is_collection' href ui-sref=\"collection({collectionId: coverstory.slug})\"><span class='icon-arrow-right-circle'></span></a>\n      </blockquote>\n      \n      <div ng-if='coverstory.covers.length' ng-repeat='document in coverstory.covers' class='cover-wrapper'>\n        <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.metadata' cover='document | coverage:\"hifi\"'></div>\n          <!-- <div class='cover' style='background-size: cover; height:300px; background-image:url({{coverstory.cover}})' ></div> -->\n      </div>\n      \n    </div>\n\n    \n    <div class=\"row\">\n    <!-- REMAINING STORIES -->\n      <div ng-repeat='story in otherstories' class=\"col-md-6\" ng-class-odd=\"'clear-left'\">\n        <div class=\"coverstory other\">\n          <div class=\"divider\"></div>\n          <div class=\"tags\" ng-if=\"story.tags.length\">\n            <span  class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n          </div>\n          <h4>\n            <a ng-if='!story.is_collection' href ui-sref=\"story({postId: story.slug})\" embedit='story.metadata.title' language='language'></a>\n            <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: story.slug})\" embedit='story.metadata.title' language='language'></a>\n          </h4>\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n          <blockquote class=\"reduced\">\n            <span embedit='story.excerpt' language='language'></span>\n            <a ng-if='!story.is_collection' href ui-sref=\"story({postId: story.slug})\"><span class='icon-arrow-right-circle'></span></a>\n            <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: story.slug})\"><span class='icon-arrow-right-circle'></span></a></blockquote>\n          <div ui-sref=\"story({postId: story.slug})\" style='cursor:pointer' ng-if='story.covers.length' ng-repeat='document in story.covers' class='fluid-container relative'>\n            <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n            <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n          </div>\n        </div>\n      </div>\n    </div>\n\n  </div>\n  <div class=\"col-md-4\">\n    <h5 class='lined'><span translate='latest news'></span></h5>\n    <div ng-repeat='story in news'>\n      <div class=\"coverstory news\">\n        <div ng-if='!$first' class=\"divider\"></div>\n        <div class=\"date\">{{story.date|date:\"yyyy'.'MM'.'dd\"}}</div>\n        <h4>\n          <a ng-if='!story.is_collection' href ui-sref=\"story({postId: story.slug})\" embedit='story.metadata.title' language='language'></a>\n          <a ng-if='story.is_collection' href ui-sref=\"collection({collectionId: story.slug})\" embedit='story.metadata.title' language='language'></a>\n        </h4>\n        <div class='authors' ng-if=\"story.authors.length\">\n          by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n        </div>\n        <blockquote class=\"reduced\">\n          <span embedit='story.excerpt' language='language'></span>\n          <a href ui-sref=\"story({postId: story.slug})\"><span class='icon-arrow-right-circle'></span></a>\n        </blockquote>\n        <div ui-sref=\"story({postId: story.slug})\" style='cursor:pointer' ng-if='story.covers.length' ng-repeat='document in story.covers' class='fluid-container relative'>\n          <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n          <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n        </div>\n\n        \n      </div>\n    </div>\n\n    <div style='text-align: center; margin-top: 20px'>\n      <div class=\"btn-line-group primary\">\n        <button class='btn-line' ui-sref='blog.event'>\n          <span translate='button.more.events'></span>\n        </button>\n        <button class='btn-line' ui-sref='blog.news'>\n          <span translate='button.more.news'></span>\n        </button>\n      </div>\n    </div>\n\n  </div>\n</div>\n</div>\n</div>"),
$templateCache.put("/static/templates/items.html","<div ng-if='count == 0' translate='items.empty'></div>\n<div ng-if='model == \"story\"' ng-repeat='story in items' ng-include='\"templates/partials/story.html\"|prefixTemplate'></div>\n<div ng-if='model == \"action\"' ng-repeat='action in items' ng-include='\"templates/partials/action.html\"|prefixTemplate'></div>\n<div ng-if='model == \"review\"' ng-repeat='review in items' ng-include='\"templates/partials/review.html\"|prefixTemplate'></div>\n<div ng-if='model == \"report\"' ng-repeat='review in items' ng-include='\"templates/partials/report.html\"|prefixTemplate'></div>\n\n<div style='text-align: center'>\n  <div ng-if='items.length > 0 && items.length < count' class=\"btn-line-group primary\">\n    <button class='btn-line' ng-click='more()'>\n      <span ng-if='!isLoadingNextItems'>\n        <span translate='button.more'></span>\n        <span translate='missing' translate-values=\"{count: missing}\"></span>\n      </span>\n      <span ng-if='isLoadingNextItems' translate='button.loading'></span>\n    </button>\n  </div>\n  <!-- when count equals item length, we are at the end -->\n</div>"),$templateCache.put("/static/templates/login.html",'<div class="container">\n  <div class="view">\n    <div class="row">\n      <div class="col-md-6">\n        <h1 translate="login"></h1>\n\n        <form role="form" name="loginform" method="POST">\n          <div class="form-group">\n            <label for="id_login_username" translate="username"></label>\n            <input type="text" ng-model=\'username\' class="form-control" id="id_login_username" autofocus="autofocus" name="username" placeholder="username" required>\n          </div>\n\n          <div class="form-group">\n            <label for="id_login_password" translate="password"></label>\n            <input type="password" ng-model=\'pwd\' class="form-control" id="id_login_password" placeholder="Password" name="password" required>\n          </div>\n\n          <div class=\'btn-line-group primary\'>\n            <button class="btn btn-line" ng-click="login()" translate=\'button.login\'></button>\n          </div>\n        </form>\n      </div>\n    </div>\n\n    <div class="row">\n      <div class="col-sm-6 col-sm-offset-3">\n        <h3 translate=\'signup.with.social\'></h3>\n\n        <div class=\'btn-line-group\'>\n          <a class=\'btn btn-line\' href=\'/social/login/twitter\' translate=\'button.signup.with.twitter\'></a>\n        </div>\n        <div class=\'btn-line-group\'>\n          <a class=\'btn btn-line\' href=\'/social/login/google-oauth2\' translate=\'button.signup.with.google\'></a>\n        </div>\n\n      </div>\n    </div>\n  </div>\n</div>'),$templateCache.put("/static/templates/md.html","<div class=\"container\">\n<div class=\"view\">\n<div class='row'>\n  <div class='col-md-8'>\n    <div class=\"contents\">\n    <div markdownit='md' watchlanguage='true' language='language' settoc='setToC(ToC)'></div>\n    </div>\n  </div>\n</div>\n</div>\n</div>"),$templateCache.put("/static/templates/notfound.html","not found. \nGo back"),$templateCache.put("/static/templates/notifications.html","<div class='container'>\n  <div class='view'>\n    <h2 translate='your.notifications'></h2>\n    <div ui-view></div>\n    \n  </div>\n</div>"),$templateCache.put("/static/templates/profile.html","<div class='container'>\n  <div class='view'>\n    <h1>{{profile.username}}</h1>\n    <div ng-repeat='author in authors' style=\"position:relative; border-bottom:1px solid #ccc\">\n    \n      <h2>{{author.fullname}}</h2>\n      <div class='affiliation sans-serif' embedit='author.affiliation' language='language'></div>\n      \n      <div embedit='author.metadata.biography' markdown='true' language='language'></div>\n      \n      \n    \n      <div ng-if='isMe || user.is_staff' class='actions'>\n        <div class='btn-line-group primary'>\n          <button ui-sref='modifyauthor({slug: author.slug})' class='btn-line' translate=\"button.edit.author\"></button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  <h3 translate=\"latest publications\"></h3>\n  <!-- Nav tabs -->\n  <ul class='nav nav-tabs'>\n    <li role=\"presentation\" ui-sref-active=\"active\" >\n      <a href ui-sref='author.publications({slug: author.slug})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"state.publications.all.label\"></a>\n    </li>\n    <li ng-if='isMe' ui-sref-active=\"active\">\n      <a href ui-sref='profile.publications({username: profile.username})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"drafts\"></a>\n    </li>\n    <li ng-if='isMe' ui-sref-active=\"active\">\n      <a href ui-sref='profile.publications({username: profile.username})' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\" translate=\"bin\"></a>\n    </li>\n  </ul>\n  \n\n  <div ui-view></div>\n</div>"),$templateCache.put("/static/templates/publications.html",'<div class=\'container\'>\n<div class="view">\n\n<h1 translate="headline.publications.title"></h1>\n\n    <p translate="headline.publications.abstract"></p>\n\n\n\n<!-- Nav tabs -->\n<ul class=\'nav nav-tabs\' style=\'margin-top: 20px\'>\n  <li role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.all.label"></a>\n  </li>\n  <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n    <a ng-if=\'link.preventTranslation\' href ui-sref=\'publications.{{link.slug}}\' aria-controls="home" role="tab" data-toggle="tab">{{link.name}}</a>\n    <a ng-if=\'!link.preventTranslation\' href ui-sref=\'publications.{{link.slug}}\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.{{link.name}}.label"></a>\n  </li>\n  <li ng-if=\'slug\' role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.tags({slug: slug})\' aria-controls="home" role="tab" data-toggle="tab">/filter: <b>{{slug}}</b>/</a>\n  </li>\n\n  <!-- <li class=\'dropdown active secondary\'>\n    <a bs-dropdown placement=\'bottom-right\' aria-haspopup="true" aria-expanded="false" style=\'position:relative; padding-right: 30px\'>\n      <span class=\'inner\'>\n        <span translate=\'orderby.date\'></span>\n        <span style=\'position:absolute; right:5px; top:0\' class=\'icon icon-arrow-down-circle\'></span>\n      </span>\n    </a>\n    <ul class="dropdown-menu" role="menu">\n      <li ui-sref-active="active"><a ui-sref="draft" translate=\'write\'></a></li>\n    </ul>\n  </li> -->\n</ul>\n\n\n\n\n<div ui-view></div>\n</div>\n</div>\n\n\n<!-- <div class=\'row\'>\n  \n  <div class=\'col-md-4\'>\n    <h2 class=\'no-margin-top\' translate=\'state.{{state}}.title\'></h2>\n    <p class="small" translate=\'state.{{state}}.abstract\'></p>\n  </div>\n  <div class=\'col-md-8\'>\n    <div ui-view></div>\n  </div>\n</div> -->\n'),$templateCache.put("/static/templates/review.html","\n<div ui-view>\n  <div class='container'>\n  <div class='view review'>\n    <div class=\"actions\" >\n      <div class='btn-line-group'>\n        <button class='btn-line' ui-sref=\"reviews.pending\" translate=\"button.backtoreviews\"></button>\n      </div>\n      <div class='btn-line-group primary'>\n        <button class='btn-line' ui-sref=\"review.story({id:review.id})\" translate=\"button.viewmode\"></button>\n      </div>\n    </div>\n\n    <h1><span translate=\"headline.review.of\"></span></h1>\n    <div class='reviewed'>\n      <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n      \n      <h2><a ui-sref='review.story({id:review.id})' embedit='review.story.metadata.title' language='language'></a></h2>\n      <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      <div ng-if='!is_editable && review.category != \"editing\"'>\n        <h2 class='center' ><span translate='field.label.review.score'></span> <span ng-class='{\"error\": !is_valid}'>{{points}}</span> / {{fields.length * 5}}</span></h2>\n        <!-- final decision: -->\n        <h3 class='center'>\n          <span translate='field.label.review.status.{{review.status}}'></span>\n        </h3>\n      </div>\n    </div>\n\n    \n\n    <form class='generic-form-wrapper' name=\"createForm\" novalidate>\n      <div ng-if='review.category != \"editing\"' ng-repeat='field in fields' style='margin: 10px 0 20px 0px'>\n        <label style='margin-left:60px'>\n\n          <span class=\"number\" ng-class='{\"active\": createForm[field].$valid, \"error\": createForm[field].$dirty && !createForm[field].$valid}'>{{$index+1}}</span>\n            <span translate=\"field.label.{{field}}\"></span>\n          <!-- <p class='description' translate=\"field.label.{{field}}.description\"></p> -->\n        </label>\n        <div rating readonly='!is_editable' ng-model='review[field + \"_score\"]'></div>\n        <div ng-show='is_editable' class='elastic-textarea-wrapper'>\n          <textarea placeholder='{{\"field.label.placeholder.review\" | translate}}' class='elastic-textarea' msd-elastic ng-model='review[field]' name='{{field}}' ng-model-options=\"{ debounce: 200 }\" ng-disabled='!is_editable'></textarea>\n\n        </div>\n        <div class='answer' ng-if='!is_editable && review[field].length' embedit='review[field]' markdown></div>\n      </div>\n\n      <div style='margin: 10px 0 20px 0px'>\n        <label ng-if='review.category != \"editing\"' style='margin-left:60px'>\n\n          <span class=\"number\" ng-class='{\"active\": createForm.reviewcontentstext.$valid, \"error\": createForm.reviewcontentstext.$dirty && !createFormreviewcontentstext.$valid}'>{{fields.length + 1}}</span>\n            <span translate=\"field.label.review.final\"></span>*\n          <p class='description' translate=\"field.label.review.final.description\"></p>\n        </label>\n\n        <label ng-if='review.category == \"editing\"'>\n          <span translate=\"field.label.review.final\"></span>\n          <p class='description' translate=\"field.label.review.final.description\"></p>\n        </label>\n        <div ng-show='is_editable' class='elastic-textarea-wrapper'>\n          <textarea rows=\"5\" placeholder='{{\"field.label.placeholder.review\" | translate}}' required class='elastic-textarea' msd-elastic ng-model='review.contents.text' name='reviewcontentstext' ng-model-options=\"{ debounce: 200 }\" ng-disabled='!is_editable' ></textarea>\n\n        </div>\n        <div class='answer' ng-if='!is_editable' embedit='review.contents.text' markdown></div>\n      </div>\n\n\n      <div style='margin: 20px 0'>\n        <h2 class='center' ng-if='review.category != \"editing\"' ><span translate='field.label.review.score'></span> <span ng-class='{\"error\": !is_valid}'>{{points}}</span> / {{fields.length * 5}}</span></h2>\n        <!-- final decision: -->\n        <h3 ng-if='!is_editable' class='center'>\n          <span translate='field.label.review.status.{{review.status}}'></span>\n        </h3>\n        <div ng-if='is_editable && is_valid && createForm.$valid'>\n          <p translate='field.label.review.final.decision'></p>\n          <div class=\"radio\" ng-repeat='status in availableStatuses'>\n            <label>\n              <input type=\"radio\"\n                ng-model=\"$parent.$parent.reviewStatus\"\n                value=\"{{status}}\"\n                name=\"reviewstatus\">\n              <span translate='field.label.review.status.{{status}}'></span>\n            </label>\n          </div>\n        </div>\n      </div>\n\n      <div ng-if='is_editable' class='center' style='margin: 20px 0'>\n        <div class='btn-line-group primary' ng-class='{\"primary\": createForm.$valid && reviewStatus != \"draft\"}'>\n          <button class='btn-line' ng-click='finalize(reviewStatus)'><span translate='button.reviewcompleted' translate-values='{is_valid: is_valid}'></span></button>\n        </div>\n\n        <div class='btn-line-group' ng-class='{\"primary\": reviewStatus == \"draft\"}'>\n          <button class='btn-line' ng-click='save()'><span translate='button.savedraft' translate-values='{isSaving: isSaving}'></span></button>\n        </div>\n      </div>\n    </form>\n\n  </div>\n</div>\n</div>"),$templateCache.put("/static/templates/reviews.html",'<div class=\'container\'>\n  <div class=\'view\'>\n    <h1 translate="headline.reviews"></h1>\n    <blockquote translate="headline.reviews.abstract"></blockquote>\n  \n    <!-- Nav tabs -->\n    <ul class=\'nav nav-tabs\'>\n      <li ng-if=\'user.is_reviewer\' role="presentation" ui-sref-active="active" >\n        <a href ui-sref=\'reviews.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.reviews.all"></a>\n      </li>\n      \n      <li ng-if=\'user.is_reviewer\' role="presentation" ui-sref-active="active" >\n        <a href ui-sref=\'reviews.pending\' aria-controls="home" role="tab" data-toggle="tab" translate="state.reviews.pending"></a>\n      </li>\n\n      <li role="presentation" ui-sref-active="active" >\n        <a href ui-sref=\'reviews.reports\' aria-controls="home" role="tab" data-toggle="tab" translate="state.reviews.reports"></a>\n      </li>\n    </ul>\n\n\n<div ui-view></div>\n  </div>\n\n</div>'),$templateCache.put("/static/templates/search.html","<div class='container'>\n<div class='view'>\n<div class='row'>\n  <div class='col-md-8'>\n\n    {{count}} results for search: {{query}}\n    \n    <ul class=\"filters\">\n      <li class='filter' ng-class='k' ng-repeat=\"(k, v) in qs\">\n        <span ng-if='k == \"q\"'>{{v}}</span>\n        <span ng-if='k != \"q\"'>{{k}}: {{v}} <span ng-click=\"removeLocationFilter(k)\" class=\"icon icon-close\"></span></span>\n      </li>\n    </ul>\n  </div>\n</div>\n<!-- Nav tabs -->\n<ul class='nav nav-tabs'>\n</ul>\n<div>\n  <div ng-repeat=\"story in items\"  ng-include='\"templates/partials/story.html\"|prefixTemplate'></div>\n</div>\n</div>\n</div>"),$templateCache.put("/static/templates/story.html","<div class=\"story\">\n  <div class='container'>\n    <div class=\"view\">\n      <div class=\"actions\" >\n        <div ng-if='review' class='btn-line-group'>\n          <button class='btn-line' ui-sref=\"reviews.pending\" translate=\"button.backtoreviews\"></button>\n        </div>\n        <div ng-if='review' class='btn-line-group primary'>\n          <button class='btn-line' ui-sref=\"review({id:review.id})\" translate='button.completereview'></button>\n        </div>\n        <div class='btn-line-group primary'>\n          <a  class='btn-line' ng-href=\"/api/story/{{story.id}}/download/\" _target=\"blank\">PDF <span class='icon icon-cloud-download'></span></a>\n        </div>\n        <div ng-if='story.isWritable && !story.isUnderReview' class='btn-line-group primary'>\n          <button  class='btn-line' nref ui-sref='writing({storyId:story.slug})' translate='edit'></button>\n        </div>\n        \n\n        <div ng-if='story.isWritable && !story.isUnderReview' class='btn-line-group primary'>\n          <button  class='btn-line' ng-if='story.status!=\"deleted\"' ng-click='setStatus(\"deleted\")' translate='remove'><span class='icon icon-bin'></span></button>\n          <button  class='btn-line' ng-if='story.status==\"deleted\"' ng-click='setStatus(\"draft\")' translate='recover'><span class='icon icon-bin'></span></button>\n        </div>\n        \n        \n\n        <div ng-if='user.is_staff && !story.isUnderReview' class='btn-line-group'>\n          <button class='btn-line' ng-click='setStatus(\"draft\")' ng-class='{\"active warning\": story.status==\"draft\"}' translate=\"story.status.draft\"></button>\n          <button class='btn-line' ng-click='setStatus(\"public\")' ng-class='{\"active\": story.status==\"public\"}' translate=\"story.status.public\"></button>\n        </div>\n      </div>\n    </div>\n  </div>\n\n  \n\n  <div class='overlay'>\n    <div class='container'>\n      <div class='row'>\n        <div class='col-md-8'>\n          <div class=\"tags\" >\n            <span ng-if=\"story.tags.length\" class='tag sans-serif' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n            \n          </div>\n\n          <div class='authors' ng-if=\"story.authors.length\">\n            by <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n          </div>\n\n\n        </div>\n      </div>\n\n      <div class='row'>\n        <div class='col-md-12'>\n          <h1 embedit='story.metadata.title' language='language'></h1>\n          \n          <!-- story reference and cite as buttons -->\n          <div embedit='story.metadata.reference' ng-if='story.metadata.reference' markdown='true' language='language'></div>\n          \n          <!-- social share buttons: -->\n          <div ng-if='story.status == \"public\"' ng-include='\"templates/partials/story.socialshare.html\"|prefixTemplate'></div>\n\n          <blockquote embedit='story.metadata.abstract' language='language'></blockquote>\n        </div>\n      </div>\n      \n      <div ng-if='story.covers.length' class=\"main cover\" ng-repeat='document in story.covers'>\n        <!-- <div class='row'>\n          <div class='col-md-8'> -->\n          <div class='cover-oembed' rich-oembed fullscreen='fullsize(document.slug)' autoplay='true' oembed='document.metadata' cover='document | coverage:\"hifi\"'></div>\n          \n          <!-- </div> -->\n          \n          <!-- <div class='col-md-4'> -->\n          <div class='metadata-wrapper' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate''></div>\n          <!-- </div> -->\n        <!-- </div> -->\n      </div>\n\n      <div class='row' style='margin-bottom: 50px'>\n        <div  ng-class='{\"col-md-12\": !sidedocuments, \"col-md-8 col-lg-7 col-xs-8\": sidedocuments}'>\n          <div class=\"contents\">\n            <div markdownit='story.contents' watchlanguage='true' language='language' listener='listener(event, data, callback)' settoc='setToC(ToC)' setdocs='setDocuments(items)'></div>\n          </div>\n        </div>\n        <div class='col-md-4 col-lg-5 col-xs-4' ng-if='sidedocuments' respect-previous-sibling update=\"documents\">\n          <div  sliding-steps data-language='language' data-focus='focusedIdx' style='height:100%' items='documents'></div>\n        </div>\n      </div>\n      <!-- <div style='margin-top: 50px' disqus=\"story.slug\"></div> -->\n      \n    </div>\n  </div>\n</div>\n"),$templateCache.put("/static/templates/tags.html",'<div class=\'container\'>\n<div class="view">\n<div class=\'row\'>\n<div class=\'col-lg-8\'>\n  <div>\n    <h1 translate="headline.publications.title"></h1>\n\n    <blockquote translate="headline.publications.abstract"></blockquote>\n\n    </div>\n  </div>\n</div>\n\n\n<!-- Nav tabs -->\n<ul class=\'nav nav-tabs\'>\n  <li role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.all\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.all.label"></a>\n  </li>\n  <li ng-repeat=\'link in urls\' role="presentation" ui-sref-active="active">\n    <a href ui-sref=\'publications.{{link.name}}\' aria-controls="home" role="tab" data-toggle="tab" translate="state.publications.{{link.name}}.label"></a>\n  </li>\n  <li ng-if=\'slug\' role="presentation" ui-sref-active="active" >\n    <a href ui-sref=\'publications.tags({slug: slug})\' aria-controls="home" role="tab" data-toggle="tab">/filter: <b>{{slug}}</b>/</a>\n  </li>\n</ul>\n\n\n<div ui-view></div>\n</div>\n</div>'),$templateCache.put("/static/templates/upload.html",'<div class=\'container\'>\n<div class=\'view\'>\n<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.title" class="ng-scope">Publications</h1>\n\n      <blockquote translate="upload.description" class="ng-scope"></blockquote>\n\n      </div>\n    </div>\n  </div>\n</div>\n \n\n<div ngf-no-file-drop>File Drag/Drop is not supported for this browser</div>\n\n<div class=\'drop-box-form-wrapper\'>\n  <form name="createForm" novalidate class="simple-form">\n    <label>\n      <span class="number" ng-class=\'{"active": createForm.utitle.$valid, "error": createForm.utitle.$dirty && !createForm.utitle.$valid}\'>1</span>\n      <span translate="field.label.upload.title"></span>\n    </label>\n    <textarea id=\'draft-title\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.title\' name=\'utitle\' required type=\'text\' placeholder=\'Untitled\'></textarea>\n    \n    <label>\n      <span class="number" ng-class=\'{"active": createForm.uabstract.$valid, "error": createForm.uabstract.$dirty && !createForm.uabstract.$valid}\'>2</span>\n      <span translate="field.label.upload.abstract"></span>\n    </label>\n    <textarea id=\'draft-abstract\' class=\'elastic-textarea\' rows="1" msd-elastic ng-model=\'uploadable.abstract\' name=\'uabstract\' required type=\'text\' placeholder=\'abstract\'></textarea>\n\n    <label>\n      <span class="number" ng-class=\'{"active": uploadable.size}\'>3</span>\n      <span translate="field.label.upload.docx"></span>\n    </label>\n    <div ng-show=\'!uploadable.size\'>\n    <div ngf-drop ngf-select ng-model="docx" class="drop-box sans-serif" \n    ngf-drag-over-class="\'dragover\'" ngf-multiple="false" ngf-allow-dir="true"\n    accept="application/vnd.openxmlformats-officedocument.wordprocessingml.document" \n    ngf-pattern="application/vnd.openxmlformats-officedocument.wordprocessingml.document">Drop docx or click to upload</div>\n    </div>\n    <div ng-if="uploadable.size" class="uploadable">\n      <span class=\'icon-doc\'></span> \n      <span class=\'sans-serif\'>{{uploadable.name}}</span>\n      <span class="size">{{uploadable.size}}</span>\n    </div>\n\n    <div class=\'button-wrapper\'>\n      <span class="number" ng-class=\'{"active": createForm.$valid && uploadable.size}\'>4</span>\n      <div class=\'btn-line-group\' ng-class=\'{"primary": createForm.$valid && uploadable.size}\'>\n        <button class=\'btn-line\' type="submit" ng-click="upload()">\n          <span ng-if=\'createForm.$valid && uploadable.size\' translate=\'button.upload.story\'></span>\n          <span ng-if=\'!createForm.$valid || !uploadable.size\' translate-values=\'{ steps: (3 - +createForm.utitle.$valid - +createForm.uabstract.$valid - +!!uploadable.size)}\' translate=\'upload.missing.steps\'></span>\n        </button>\n      </div>\n    </div>\n    \n  </form>\n  \n</div>\n</div>\n</div>'),$templateCache.put("/static/templates/uploaded.html",'<div class="row">\n  <div class="col-lg-8">\n    <div>\n      <h1 translate="upload.success.title" class="ng-scope">Your content has been submitted</h1>\n\n      <blockquote translate="upload.success.description" class="ng-scope"></blockquote>\n\n      <div ng-include=\'"templates/partials/story.html"|prefixTemplate\'></div>\n\n      </div>\n    </div>\n  </div>\n</div>'),$templateCache.put("/static/templates/writings.html","<div class='container'>\n<div class='view'>\n\n<!-- <span class='btn-line-group'><button class='btn-line active' ng-click='save()'>{{isSaving? \"saving...\":\"save\"}}</button></span> -->\n\n\n<div class=\"row\">\n  <div class='col-md-8'>\n    <label>\n      <span translate=\"field.label.title\"></span>\n    </label>\n    <textarea id='draft-title' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='title'   type='text' placeholder='Untitled'></textarea>\n    <label></label>\n    <label>\n      <span translate=\"field.label.abstract\"></span>\n    </label>\n    <textarea id='draft-abstract' class='elastic-textarea' rows=\"1\" msd-elastic ng-model='abstract' type='text' placeholder='abstract'></textarea>\n  \n  </div>\n  <div class='col-md-4'>\n    \n    <div class='cover-preview-wrapper'>\n      <label translate=\"field.label.cover\"></label>\n      <div class=\"cover-preview\" ng-repeat=\"document in story.covers\">\n        <div ng-if='document.metadata'>\n          <div lazy-img='{{document|coverage}}' class='lazy-box'></div>\n\n          <div class='tile'>\n            <div class='title' embedit='document.metadata.title' language='language'></div>\n            <div class='copyright' embedit='document.metadata.copyright'></div>\n            <div class='btn-line-group'>\n              <button class='btn-line' ng-disabled='!story.covers.length' ng-click='\n              removeCover(document)' translate=\"button.removecover\"></button>\n            </div>\n          </div>\n        </div>\n\n      </div>\n      <div class=\"center\">\n        <div class='btn-line-group ' style='width: 100%'>\n          <button   class='btn-line' ng-click='\n            openCoversModal()' translate=\"button.choosecover\"></button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>\n\n\n<div class='actions'>\n  <!-- <div ng-if='metadata.owner.is_staff' class='btn-line-group'> -->\n  \n  <div class='btn-line-group' ng-if='!isDraft && id'>\n    <button ng-if='!isCollection' class='btn-line' ui-sref=\"story({postId: story.slug})\" translate=\"button.viewmode\"></button>\n    <button ng-if='isCollection' class='btn-line' ui-sref=\"collection({collectionId: story.slug})\" translate=\"button.viewmode\"></button>\n  </div>\n  \n  <div class='btn-line-group primary'>\n    <button ng-if='!isDraft' ng-click='save()' class='btn-line'><span ng-if='!isSaving' translate=\"button.save\"></span><span ng-if='isSaving' translate=\"button.issaving\"></span></button>\n    <button ng-if='isDraft' ng-click='save()' class='btn-line'><span translate=\"button.create\"></span></button>\n    \n  </div>\n  <!-- </div> -->\n  \n</div>\n\n<div class='section' style='margin-bottom:20px'>\n  <div class=\"row\">\n    <div ng-class='{\"col-md-8\": !isDraft}' ng-if='!isDraft'>\n      <label translate=\"drafts.keywords.placeholder\"></label>\n  <tags-input class='tags-input' placeholder='{{\"drafts.keywords.placeholder\"| translate}}' on-tag-added='attachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"keywords\" add-from-autocomplete-only=\"true\">\n    <auto-complete source=\"suggestTags($query, {category:'keyword'})\"></auto-complete>\n\n  </tags-input>\n    </div>\n\n    <div class=\"col-md-4\" ng-if='!isDraft && user.is_staff'>\n      <label translate=\"staff.drafts.tags.placeholder\"></label>\n      <tags-input class='tags-input'  on-tag-added='attachTag($tag)' on-tag-removed='detachTag($tag)' key-property='id' display-property='name' ng-model=\"displayedTags\" add-from-autocomplete-only=\"true\">\n        <auto-complete source=\"suggestTags($query, {category__in:['blog','writing', 'highlights']})\" ></auto-complete>\n\n      </tags-input>\n    </div>\n  </div>\n\n</div>\n\n<!-- <div class='authors' ng-if='!isDraft'>\nby <a href>{{metadata.owner.username}}</a>\n</div>\n<div class='authors' ng-if='isDraft'>\n  <div ng-if='user.username'>\n    by <a href>{{user.username}}</a>\n  </div>\n  <div ng-if='!user.username'>\n    by <a href>anonymous</a>\n  </div>\n</div> -->\n\n<!-- <div ng-if='!isDraft'>\n  <form class=\"form-inline\">\n    <div class=\"form-group\">\n      <label translate='date'></label>\n      <input type=\"text\" class=\"form-control\" ng-model=\"date\" name=\"date\" data-max-date=\"today\" timezone='UTC' bs-datepicker data-autoclose=\"1\">{{date}}\n    </div>\n  </form>\n</div> -->\n\n<div id=\"draft-contents\">\n  \n  <div style='min-height: 50px; position:relative'>\n      <!-- <medium-editor ng-model='contents' bind-options=\"mediumOptions\"></medium-editor> -->\n      \n      <div mde='contents' language='language' setdocs='setDocuments(documents)' settoc='setToC(items)'></div>\n      \n  </div>\n</div>\n</div>\n</div>"),$templateCache.put("/static/templates/partials/action.html","<div class=\"stream-item\">\n  {{action.ctor.username}} \n  <span translate='verb.{{action.verb}}'></span>\n  <span translate='model.{{action.target_content_type}}'></span>\n  {{action.timestamp|date:'Ymd'}}\n  <div ng-if=\"action.target_content_type == 'document'\" ng-init='document=action.target' ng-include='\"templates/partials/document.html\"|prefixTemplate'>\n  </div>\n</div>\n"),$templateCache.put("/static/templates/partials/author.html","<a class='author' ui-sref='author.publications.all({slug:author.slug})'>{{author.fullname}}</a>{{$last? '':', '}}"),$templateCache.put("/static/templates/partials/breakingNews.html","<div class=\"wrapper\" style='    background-size: cover; background-image: url({{news.cover_url}})'>\n  <div class='overlay'>\n    <div class=\"type\">\n      <span ng-repeat='tag in news.tags | filter:{ category: \"writing\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <h3><a ng-if='!news.isCollection' ui-sref=\"story({postId: news.slug})\" embedit='news.metadata.title' language='language'></a><a ng-if='news.isCollection' ui-sref=\"collection({collectionId: news.slug})\" embedit='news.metadata.title' language='language'></a></h3>  \n  </div>\n</div>"),$templateCache.put("/static/templates/partials/collection.html","<!-- <div ng-if='!$first' class=\"divider\"></div> -->\n<div class=\"story collection lite\">\n  <div class=\"divider\"></div>\n  <div class=\"tags\" ng-if=\"story.tags.length\">\n    <span class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n  </div>\n  <!-- <div class=\"date\">{{story.date_created|date:'mediumDate'}}</div> -->\n  \n  <h3 class=\"title\"><a ui-sref=\"collection({collectionId: story.slug})\"><span embedit='story.metadata.title' language='language'></span> {{story.status != 'public'? '(DRAFT)': ''}}</a></h3>  \n  \n  <div class='authors' ng-if=\"story.authors.length\">\n    <span translate='by'></span> <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n  </div>\n  <blockquote ng-if='story.excerpt' class=\"reduced\">{{story.excerpt}}.\n    <a href ui-sref=\"collection({collectionId: story.slug})\">\n      <span class='icon-arrow-right-circle'></span>\n    </a>\n    <p>\n      <em ng-if=\"story.difference\">{{story.difference}}</em>\n    </p>\n  </blockquote>\n  \n  <blockquote ng-if='!story.excerpt' embedit='story.metadata.abstract' language='language'></blockquote>\n</div>"),$templateCache.put("/static/templates/partials/document.html","\n<div class='doc doc-{{document.type}} {{document.isSelected?\"active\":\"\"}}' ng-click='selectDocument(document)'>\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='switch' ng-if='document.type==\"image\"' ng-include='\"templates/partials/document.image.html\"|prefixTemplate'></div>\n\n  <div class='switch' ng-if='document.type==\"photo\"' ng-include='\"templates/partials/document.photo.html\"|prefixTemplate'></div>\n\n\n  <div class='switch' ng-if='document.type==\"rich\" || document.type==\"video\"' rich-oembed fullscreen='fullsize(document.slug)' oembed='document.metadata' cover='document.metadata.details.urls.Preview || document.snapshot ||  document.metadata.urls.Preview || document.metadata.thumbnail_url;'></div>\n\n  \n\n  <div class='switch' ng-if='document.type==\"picture\"' style='height: 400px; width:100%; background-position: center; background-color: #151515; background-size:contain; background-repeat: no-repeat;' lazy-img='{{document.src}}'></div>\n\n  <div ng-if='document.metadata' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate'></div>\n\n      <!-- this element has fixed height. -->\n      <div ng-if='document.type==\"video-cover\"'>\n        \n        <div class='caption reference' markdown='document.metadata.reference.fr'></div>\n        <div class='copyright'>{{document.copyrights}}</div>\n        \n      </div>\n\n      \n\n      <div ng-if='document.type==\"pdf\"' lazy-image src='document.snapshot'></div>\n      \n\n      <blockquote ng-if='document.citation' markdown='document.citation'></blockquote>\n\n\n      \n      <div ng-if='!document.metadata'>\n        <div ng-if='document.title' class='title'>{{document.title}}</div>\n        <div ng-if='document.caption' class='caption'>{{document.caption}}</div>\n        <div ng-if='document.copyrights' class='copyright'>{{document.copyrights}}</div>\n        \n      </div>\n\n      <div ng-if='document.type==\"bibtex\"'>\n        <div class='caption'>\n          <span ng-if='document.metadata.author'>{{document.metadata.author|bibtex}},</span>\n          <span ng-if='document.metadata.editor'>{{document.metadata.editor|bibtex}}</span>(edited by)</span> \n          \n          <em>{{document.metadata.title|bibtex}}</em>\n          <span>{{document.metadata.publisher|bibtex}}</span>\n          <span ng-if='document.metadata.year'>, <span>{{document.metadata.year|bibtex}}</span> \n        </div>\n      </div>\n\n      <div ng-if='document.type!=\"bibtex\" && document.metadata.title'>\n        <div class='caption' markdown='document.metadata.title'></div>\n        <div ng-if='document.metadata.reference' class='caption reference' markdown='document.metadata.reference'></div>\n        <div ng-if='document.metadata.copyright' class='copyright' markdown='document.metadata.copyright'></div>\n        <div ng-if='document.metadata.author_name' class='copyright'>\n          <a ng-href='{{document.metadata.author_url}}' target='_blank' markdown='document.metadata.author_name'></a>\n        </div>\n      </div>\n\n    </div>"),
$templateCache.put("/static/templates/partials/document.image.html","<div class='image-wrapper'>\n  <!-- <div ng-if='document.metadata.urls' lazy-image src='document.metadata.urls.Preview' size='contain'></div>\n -->\n  <div src='document.metadata.thumbnail_url || document.metadata.urls.Preview || document.snapshot' lazy-image></div>\n</div>"),$templateCache.put("/static/templates/partials/document.metadata.embedded.html","<span class='oneline'><em ng-if='document.metadata.title' embedit='document.metadata.title' language='language' firstline='true'></em>\n<em ng-if='!document.metadata.title && document.title' embedit='document.title' language='language' firstline='true'></em>\n\n<span ng-if='document.metadata.author_name'>\n  <span translate='by'></span>\n  <a ng-href='{{document.metadata.author_url}}' target='_blank'>{{document.metadata.author_name}}</a>\n</span>\n</span>"),$templateCache.put("/static/templates/partials/document.metadata.html","<div class='metadata {{document.type}}'>\n  <div ng-if='!document.metadata.details.title'>\n    <button class='btn btn-line' ng-if='document._type == \"doc\"||document._type == \"voc\"' ng-click='alignTo(document._index, $event)'>\n      <span class='icon icon-type-{{document.type||document._type}}'></span><span class='type {{document.type}}'></span>\n    </button>\n    <span ng-if='document.type!=\"link\"' class='title' embedit='document.metadata.title' language='language'></span>\n\n    <a ng-if='document.type==\"link\"' target='_blank' ng-href='{{document.metadata.url}}'><span class='title' embedit='document.metadata.title' language='language'></span></a>\n    \n    <div ng-if='document.metadata.abstract'  class='abstract'>\n      <span embedit='document.metadata.abstract' language='language'></span>\n      <span ng-if='document._type == \"voc\"'>\n        <a ui-sref='story({postId:document.slug})'>\n          <span translate='more'></span>\n          <span class=\"icon icon-arrow-right-circle\"></span>\n        </a>\n      </span>\n    </div>\n    <div>\n      <div ng-if='document.metadata.type==\"link\" && document.metadata.thumbnail_url' class='snapshot' lazy-img='{{document.metadata.thumbnail_url}}'></div>\n      \n      <div ng-if='document.metadata.caption' class='caption' embedit='document.metadata.caption' language='language'></div>\n      <div ng-if='!document.metadata.caption && document.metadata.description' class='caption' embedit='document.metadata.description' language='language'></div>\n    </div>\n    <div style='clear:both' ng-if='document.metadata.copyright' embedit='document.metadata.copyright' language='language' firstline='true'></div>\n  </div>\n  \n  <!-- having details -->\n  <div ng-if='document.metadata.details.title'>\n    <button class='btn btn-line' ng-if='document._type == \"doc\"||document._type == \"voc\"' ng-click='alignTo(document._index, $event)'>\n      <span class='icon icon-type-{{document.type||document._type}}'></span>\n    </button>\n    <span class='title' embedit='document.metadata.details.title || document.metadata.title' language='language'></span>\n    <div class='caption' embedit='document.metadata.details.caption' language='language'></div>\n    <div class='copyright' ng-if='document.metadata.details.copyright' embedit='document.metadata.details.copyright' language='language' firstline='true'></div>\n  </div>\n\n   \n  <!-- author part -->\n  <div>\n    <span ng-if='document.metadata.author_name'>\n      <span translate='author'></span>\n      <a ng-href='{{document.metadata.author_url}}' target='_blank'>{{document.metadata.author_name}}</a>\n    </span>\n    <span ng-if='document.metadata.provider_name'>\n      <span translate='source'></span>:\n      <a ng-href='{{document.metadata.provider_url}}' target='_blank'>{{document.metadata.provider_name}}</a>\n    </span>\n  </div>\n  \n  <a ng-if='user.is_staff' target='_blank' ng-href='/admin/miller/document/{{document.document_id || document.id}}/change/'>modify (admin)</a>\n  <!-- <button ng-if='document.type != \"link\"' ng-click='fullsize(document.slug, document._type )' >preview</button> -->\n  \n</div>"),$templateCache.put("/static/templates/partials/document.metadata.linear.html","<div class='metadata {{document.type}}'>\n  <em ng-if='document.metadata.title' embedit='document.metadata.title' language='language' firstline='true'></em>\n  <em ng-if='!document.metadata.title && document.title' embedit='document.title' language='language' firstline='true'></em>\n\n  <span ng-if='document.metadata.author_name'>\n    <span translate='by'></span>\n    <a ng-href='{{document.metadata.author_url}}' target='_blank'>{{document.metadata.author_name}}</a>\n  </span>\n  <span ng-if='document.metadata.provider_name'>\n    (<span translate='source'></span>:\n    <a ng-href='{{document.metadata.url || document.metadata.provider_url}}' target='_blank'>{{document.metadata.provider_name}}</a>)\n  </span>\n\n<span ng-if='document.metadata.copyright' embedit='document.metadata.copyright' language='language' firstline='true'></span>\n<span ng-if='user.is_staff' >&mdash; <a target='_blank' ng-href='/admin/miller/document/{{document.document_id || document.id}}/change/'>modify (admin)</a></span>\n</div>"),$templateCache.put("/static/templates/partials/document.photo.html","<div class='image-wrapper'>\n  <!-- <div ng-if='document.metadata.urls' lazy-image src='document.metadata.urls.Preview' size='contain'></div>\n -->\n  <img src='images/spinner.gif' lazy-img='{{document.metadata.media_url || document.metadata.urls.Preview}}' />\n</div>"),$templateCache.put("/static/templates/partials/document.placeholder.html","<div ng-init='document=resolved' ng-include='\"templates/partials/document.html\"|prefixTemplate' ></div>"),$templateCache.put("/static/templates/partials/document.rich.html","<div class='iframe-wrapper' ng-init='__isIntoViewport=false' ng-class='{\"with-thumbnail\": document.metadata.thumbnail_url}'>\n  <a class='toggle-preview' href ng-click='__isIntoViewport = !__isIntoViewport'><span class='icon icon-eye'></span></a>\n  <div class='iframe-viewport' ng-class='{\"active\":__isIntoViewport}'>\n    <div ng-if=\"document.metadata.thumbnail_url\" style='height: 100%;width: 100%'>\n      <div class='cover' style='height: 100%;width: 100%; background-color:#151515;background-size: cover'  src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.thumbnail_url}}'></div>\n    </div>\n    <div ng-if='__isIntoViewport' style='height: 100%; position: absolute; top:0; left:0;width: 100%' stretch='true' embedit='document.metadata.html' language='language'></div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/hold.html","<div>\n  <span embedit='resource.metadata.title' language='language'></span>\n  <span ng-if='resource.metadata.abstract' embedit='resource.metadata.abstract' language='language'></span>\n  <span ng-if='resource.metadata.description' embedit='resource.metadata.description' language='language'></span>\n</div>"),$templateCache.put("/static/templates/partials/oembed-search-results.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.url == selectedDocument.url}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n    <div class='tile'>\n      <div class='title' embedit='document.metadata.title' languagle='language'></div>\n      <div class='copyright' embedit='document.copyright'></div>\n    </div>\n  </div>\n  <div class='excerpt' embedit='document.title'></div>\n</div>"),$templateCache.put("/static/templates/partials/placeholder.html","<div class='placeholder' ng-if='type==\"doc\"' ng-include='\"templates/partials/document.placeholder.html\"|prefixTemplate'></div>\n<span class='placeholder' ng-if='type==\"voc\"' ng-include='\"templates/partials/term.placeholder.html\"|prefixTemplate'></span>"),$templateCache.put("/static/templates/partials/report.html","<div class=\"review stream {{review.status}}\">\n  <div class=\"row\">\n    <div class='col-xs-4 col-sm-4 col-md-3'>\n      <table class=\"table\">\n        <tr>\n          <th><span>type</span></th>\n          <td><span>{{review.category}}</span></td>\n        </tr>\n        <tr>\n          <th><span>status</span></th>\n          <td><span class='status'>{{review.status}}</span></td>\n        </tr>\n        <tr>\n          <th><span>score</span></th>\n          <td><span>{{review.score}}</span></td>\n        </tr>\n      </table>\n    </div>\n    <div class='col-xs-8 col-sm-6 col-md-5'>\n      <div class='reviewed'>\n        <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n\n        <h2 class=\"title\">\n          <a ui-sref=\"story({postId: review.story.slug})\"><span embedit='review.story.metadata.title' language='language'></span></a>\n        </h2>  \n      \n        <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      </div>\n    </div>\n\n    <div class='col-sm-2 col-md-4'>\n      <div class='center'  style='    margin-top: 35px;'>\n        <div class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='report({id: review.id})' translate='button.viewreport'></button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/review.html","<div class=\"review stream {{review.status}}\">\n  <div class=\"row\">\n    <div class='col-xs-4 col-sm-4 col-md-3'>\n      <table class=\"table\">\n        <tr>\n          <th><span>type</span></th>\n          <td><span>{{review.category}}</span></td>\n        </tr>\n        <tr>\n          <th><span>status</span></th>\n          <td><span class='status'>{{review.status}}</span></td>\n        </tr>\n        <tr>\n          <th><span>due date</span></th>\n          <td><span>{{review.due_date|date:'mediumDate'}}</span></td>\n        </tr>\n        <tr ng-if='review.category != \"editing\"'>\n          <th><span>score</span></th>\n          <td><span>{{review.score}}</span></td>\n        </tr>\n      </table>\n    </div>\n    <div class='col-xs-8 col-sm-6 col-md-5'>\n      <div class='reviewed'>\n        <div class=\"date\">{{review.story.date|date:'mediumDate'}}</div>\n\n        <h2 class=\"title\">\n          <a ui-sref=\"review.story({id: review.id})\"><span embedit='review.story.metadata.title' language='language'></span></a>\n        </h2>  \n      \n        <blockquote ng-if='review.story.metadata.abstract' embedit='review.story.metadata.abstract' language='language'></blockquote>\n      </div>\n    </div>\n\n    <div class='col-sm-2 col-md-4'>\n      <div ng-if='review.status == \"initial\" || review.status == \"draft\"' class='center'  style='    margin-top: 35px;'>\n        <div class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='review({id: review.id})' translate='button.completereview'></button>\n        </div>\n      </div>\n      <div ng-if='review.status != \"initial\" && review.status != \"draft\"' class='center'  style='    margin-top: 35px;'>\n        <div class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='review({id: review.id})' translate='button.viewreport'></button>\n        </div>\n      </div>\n      <div class='center'  style='    margin: 20px 0 15px 0;'>\n        <div class='btn-line-group primary'>\n          <button class='btn-line' ui-sref='review.story({id: review.id})' translate='button.viewforreview'></button>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/story.html","<div ng-if='!story.isCollection' class=\"story item\">\n  <div class=\"row\">\n    <div class=\"col-md-4\" ng-if='story.covers.length'>\n      <div  ng-repeat='document in story.covers' class='fluid-container relative'>\n        <div class='image-wrapper cover' lazy-img='{{document|coverage}}'></div>\n        <div class='embedded-metadata' ng-include='\"templates/partials/document.metadata.embedded.html\"|prefixTemplate'></div>\n      </div>\n    </div>\n    <div class=\"col-md-8\" ng-class='{\"col-md-12\":!story.covers.length}'>\n    <div ng-if='!$first' class=\"divider\"></div>\n    <div class=\"tags\" ng-if=\"story.tags.length && !story.matches\">\n      <span class='tag' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n    <div class=\"tags\" ng-if=\"story.tags.length && story.matches\">\n      <span class='tag' ng-click='setLocationFilter(\"tags\",tag.slug)' ng-repeat='tag in story.tags|filter:\"public\"' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n    </div>\n\n    <div class=\"date\">{{story.date|date:\"yyyy'.'MM'.'dd\"}}</div>\n\n    \n\n\n    <h3 class=\"title\"><a ui-sref=\"story({postId: story.slug})\"><span embedit='story.metadata.title' language='language'></span> {{story.status != 'public'? '['+story.status+']': ''}}</a></h3>  \n    <div class='authors' ng-if=\"story.authors.length\">\n      <span translate=\"written.by\"></span> <span ng-repeat='author in story.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n    </div>\n    <blockquote ng-if='story.excerpt' class=\"reduced\">{{story.excerpt}}.\n      <a href ui-sref=\"story({postId: story.id})\">\n        <span class='icon-arrow-right-circle'></span>\n      </a>\n    </blockquote>\n    \n    <blockquote ng-if='!story.excerpt && !story.matches' class=\"reduced\" embedit='story.metadata.abstract' language='language'></blockquote>\n\n    <blockquote class=\"reduced matches\" ng-if=\"story.matches.highlights\">\n      <div embedit='story.matches.highlights'></div>  \n    </blockquote>\n\n    <p>\n      \n      <!-- <span class='creator' ng-if=\"!story.authors.length\">\n        created by <span ng-init='author=story.owner;$last=true' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </span> -->\n      \n      <a ng-if='user.is_staff' target='_blank' ng-href='/admin/miller/story/{{story.id}}/change/'>modify (admin)</a>\n    \n    </p>\n    </div>\n  </div>\n</div>\n\n<div ng-if='story.isCollection' ng-include='\"templates/partials/collection.html\"|prefixTemplate'></div>"),$templateCache.put("/static/templates/partials/story.socialshare.html",'<div class="share" >\n  <span translate=\'share\'></span>\n  <a socialshare socialshare-provider="twitter" socialshare-text="{{OG.title}}" socialshare-via="{{settings.twitter.username}}" socialshare-hashtags="{{settings.twitter.socialtags}}" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-social-twitter\'></span></a>\n\n  <a socialshare socialshare-provider="facebook" socialshare-text="{{OG.title}}" socialshare-title="{{OG.title}}" socialshare-description="{{OG.description}}"  socialshare-hashtags="{{settings.socialtags}}" socialshare-media="{{OG.image}}" socialshare-via="{{settings.facebook}}" socialshare-type="feed" socialshare-url="{{absoluteUrl}}"><span class=\'icon icon-social-facebook\'></span></a>\n</div>'),$templateCache.put("/static/templates/partials/table-of-contents.html","\n<div id='inner-table-of-contents-toggler' >\n  <button class='btn-transparent' ng-click='toggleTableOfContents()'><span class='icon-action-undo'></span></button>\n  <div class='save' ng-if='state == \"writing\" || state == \"draft\"' ng-click='save()'>\n    <button class='btn-transparent btn-line'><span  class='icon-disc'></span></button>\n    <div class='sans-serif' style='text-transform: uppercase; font-size:10px; text-align:center; line-height:20px' translate='save'></div>\n  </div>\n  <!-- <div class='edit' ng-if='state == \"post\"' ng-click='save()'>\n    <button class='btn-transparent btn-line'><span  class='icon-disc'></span></button>\n    <div class='sans-serif' style='text-transform: uppercase; font-size:10px; text-align:center; line-height:20px' translate='save'></div>\n  </div> -->\n</div>\n\n<h2>table of contents</h2>\n\n\n<ul>\n  <li ng-repeat=\"heading in ToC\" class='heading heading-{{heading.level}}'>\n  <a ng-click='setHash(heading.slug)'> {{heading.text}}</a></li>\n\n</ul>"),$templateCache.put("/static/templates/partials/table-of-documents.html","<!-- <h2>table of documents</h2>\n -->\n\n<!-- <div>\n  <div ng-repeat=\"document in documents\">\n    {{language}}\n    <span embedit='document.metadata.title' language='language'></span>\n  </div>\n</div> -->"),$templateCache.put("/static/templates/partials/tag.html","<span ng-if='tag.category != \"keyword\" && tag.category != \"blog\"' class='tag' ng-class='tag.category'><a ui-sref='publications.{{tag.slug}}'>{{tag.name}}</a></span><span ng-if='tag.category == \"keyword\"' class='tag' ng-class='tag.category'><a href ui-sref='publications.tags({slug: tag.slug})'>{{tag.name}}</a></span><span ng-if='tag.category == \"blog\"' class='tag' ng-class='tag.category'><a href ui-sref='blog.{{tag.slug}}'>{{tag.name}}</a></span>{{$last?' ': ', '}}"),$templateCache.put("/static/templates/partials/tag.input.html","<span ng-class='data.category'>\n  <span class='type'>{{data.category}}/</span>\n  <span>{{data.name}}</span>\n\t<a class=\"remove-button\" ng-click=\"$removeTag()\" ><span class='icon-close'></span></a>\n</span>"),$templateCache.put("/static/templates/partials/term.html","<div ng-class='{\"active\": selectedDocument.id == term.id}' class='doc term oembedded' ng-click='selectDocument(term)'>\n  <!-- this element has fixed height. -->\n  <!-- {{term}} -->\n  <div class='wrapper'>\n    <div class='lazy-box'>\n      \n      <div ng-if='!term.covers.length' class='title' embedit='term.metadata.title' language=\"language\" ></div>\n      <div ng-if='!term.covers.length' class='copyright' embedit='term.metadata.abstract' language=\"language\" ></div>\n      <!-- {{term.covers}} -->\n      <div class='cover' ng-repeat='cover in term.covers' lazy-img=\"{{ cover.metadata.thumbnail_url || cover.metadata.urls.Preview }}\"></div>\n    </div>\n    <div class='tile'>\n      <div class=\"tags\" ng-if=\"term.tags.length\">\n        <span class=\"tag\" ng-repeat='tag in term.tags|filter:{ category: \"writing\", status:\"public\" }' ng-include='\"templates/partials/tag.html\"|prefixTemplate'></span>\n      </div>\n      <div class='title' embedit='term.metadata.title' language=\"language\"></div>\n      <div class='abstract' embedit='term.metadata.abstract' language=\"language\"></div>\n      <div class='authors' ng-if=\"term.authors.length\">\n        by <span ng-repeat='author in term.authors' ng-include='\"templates/partials/author.html\"|prefixTemplate'></span>\n      </div>\n      \n    </div>\n  </div>\n  <div class='excerpt' embedit='term.metadata.title' language=\"language\"></div>\n</div>"),$templateCache.put("/static/templates/partials/term.placeholder.html","<a ui-sref='story({postId: resolved.id})'>{{resolved.title}}</a>\n"),$templateCache.put("/static/templates/partials/embeds/Flickr.html","<div style='margin: 0; background-color:#f0f0f0; padding: 15px 0' class='row'>\n  <div class='col-sm-5'>\n    <div class='image-wrapper' style='height: 150px'>\n      <div lazy-img='{{embed.media_url}}' class='cover' style='height: 150px'/>\n    </div>\n  </div>\n  <div class='col-sm-7'>\n    <div class='caption title' embedit='embed.title'></div>\n    <div class='copyright'><a ng-href='embed.author_url' target='_blank'>{{embed.author_name}}</a></div>\n    <span translate='remote.url'></span>: <a ng-href='{{embed.url}}' target='_blank' translate='remote.url.placeholder'></a>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/embeds/Ina.fr.html","<div class='caption title' embedit='embed.title'></div>\n<div class='caption reference' embedit='embed.description'></div>\n<img lazy-img src='{{embed.thumbnail_url}}' />\n\n"),$templateCache.put("/static/templates/partials/embeds/YouTube.html","\n<div class='caption title' markdown='embed.title'></div>\n<div class='copyright'><a ng-href='embed.author_url'>{{embed.author_name}}</a></div>\n\n\n<div lazy-image src='embed.thumbnail_url'></div>\n\n"),$templateCache.put("/static/templates/partials/embeds/cvce.html","\n<div class='caption title' markdown='embed.title.fr'></div>\n<div class='caption reference' markdown='embed.reference.fr'></div>\n<div class='copyright'>{{embed.copyrights}}</div>\n\n\n <div ng-if='embed.urls.Preview'>\n  <div lazy-image src='embed.urls.Preview'></div>\n </div>\n\n"),$templateCache.put("/static/templates/partials/embeds/document.html","<div class='oembedded doc doc-{{document.type}}' ng-class='{\"active\": document.id == selectedDocument.id}' ng-click='selectDocument(document)'>\n\n  <!-- <div class='divider'>&nbsp;</div> -->\n  \n  <div class='wrapper'>\n    <div ng-if='document.metadata'>\n      <div src='document.metadata.thumbnail_url || document.metadata.urls.Preview || document.snapshot || document.metadata.url' lazy-image></div>\n      <!-- <div ng-if='document.metadata.thumbnail_url' lazy-image src='document.metadata.thumbnail_url'></div>\n\n      <div ng-if='!document.metadata.thumbnail_url && document.metadata.urls.Preview' lazy-image src='document.metadata.urls.Preview'></div>\n\n      <div ng-if='!document.metadata.thumbnail_url && !document.metadata.urls.Preview' class='lazy-box'></div>\n -->\n      <div class='tile'>\n        <div class='title' embedit='document.metadata.title' language='language'></div>\n        <div class='copyright' embedit='document.metadata.copyright'></div>\n      </div>\n    </div>\n    <div ng-if='!document.metadata'>\n      <div ng-if='document.urls.Preview' lazy-image src='document.urls.Preview'></div>\n      <div ng-if='document.src' lazy-image src='document.src'></div>\n      <!-- {{document}} -->\n      <div class='tile'>\n        <div class='title' embedit='document.title'></div>\n        <div class='copyright' embedit='document.copyright'></div>\n      </div>\n    </div>\n  </div>\n\n  <div class='excerpt'><span class='type'>{{document.type}}</span> <span embedit='document.title'></span></div>\n</div>"),$templateCache.put("/static/templates/partials/directives/footnote.html",'<span class="footnote">\n  <!-- <a ng-click="toggleFootnote()">{{caption}}</a> -->\n  <div class="footnote-contents" ng-show="isOpened"></div>\n</span>'),$templateCache.put("/static/templates/partials/directives/mde.html","<div ng-show='isReady' class='mde'>\n  <div class='toolbox'> \n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"strong\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleBold\")'>B</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"em\") != -1?\"active\": \"\"}}' style='font-style:italic' ng-click='action(\"toggleItalic\")'>I</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-1\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading1\")'>H1</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-2\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading2\")'>H2</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"header-3\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleHeading3\")'>H3</button>\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"quote\") != -1?\"active\": \"\"}}' ng-click='action(\"toggleBlockquote\")'>Q</button>\n\n      <button style='width:70px' class='sans-serif btn {{isPreviewEnabled? \"active\": \"\"}}' ng-click='action(\"togglePreview\")'>preview</button>\n\n      <button ng-disabled='isPreviewEnabled' class='btn {{activeStates.indexOf(\"link\") != -1|| activeStates.indexOf(\"url\") != -1? \"active\": \"\"}}' ng-click='showReferenceModal()'><span class='icon-plus'></span></button>\n      <!-- {{activeStates}} -->\n  </div>\n  <div class='wand' >\n    <button class='btn' ng-disabled='isPreviewEnabled' ng-click='showReferenceModal()'><span class='icon-plus'></span></button>    \n  </div>\n\n\t<textarea class='mde-textarea' placeholder=\"write something...\"></textarea>\n</div>"),$templateCache.put("/static/templates/partials/directives/rich-oembed.html","<div class='rich-oembed-iframe-wrapper {{oembed.type}}' ng-class='{\"with-thumbnail\": with-thumbnail}'>\n  <div ng-click='toggleEnable()' class=\"shadow\">\n    <div class='toggler' ng-if='oembed.type == \"video\"' ><span class='icon icon-control-play'></span></div>\n  </div>\n  <div class='rich-oembed-iframe-viewport' ng-class='{\"active\":iframeEnabled}'>\n    <div ng-if=\"cover\" style='height: 100%; width: 100%' >\n      <div class='image-wrapper cover'  src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{ cover }}'></div>\n    </div>\n    <div ng-if='iframeEnabled' style='height: 100%; position: absolute; top:0; left:0;width: 100%' stretch='true' autoplay='{{autoplay}}' embedit='oembed.html' language='language'></div>\n  </div>\n  <div class='actions'>\n    <a ng-if='oembed.type != \"video\" || iframeEnabled'  class=\"action\" ng-click=toggleEnable()>\n      <span class='icon' ng-class='{\"icon-control-play\": !iframeEnabled, \"icon-close\": iframeEnabled}'></span>\n    </a>\n    <a class='action' ng-if='fullscreen' ng-click=\"toggleFullscreen()\">\n      <span class='icon icon-size-fullscreen'></span>\n    </a>\n\n  </div> \n</div>"),$templateCache.put("/static/templates/partials/directives/sliding-steps.html","<div class='sliding-steps-direction top' ng-class='{\"active\":isMoreTop}'>\n  <div class='btn-line-group'>\n    <button class=\"btn btn-line\" ng-click='prev()'>\n      <span class=\"icon icon-arrow-up-circle\"></span>\n      <span translate='button.previous'></span> \n    </button>\n  </div>\n</div>\n\n<div class=\"sliding-steps-wrapper\" ng-class='{\"more-top\":isMoreTop, \"more-bottom\":isMoreBottom}'>\n  <div class='sliding-steps'>\n    <div id='step-{{item._index}}' class='step {{item._type}}' ng-class='{active: item.isFocused}' ng-repeat=\"item in items\" ng-init='document=item' ng-if='item._type != \"block-doc\"'>\n      <div class=\"thumbnail\" ng-class='item.type' ng-if='item._type==\"doc\" && item.type != \"link\"' >\n        <div class=\"action fullscreen\" ng-if='document.type!=\"rich\" && document.type!=\"video\"' ng-click='fullsize(document.slug, document._type)'><span class=\"icon icon-size-fullscreen\"></span></div>  \n        \n        <div class=\"thumbnail-image\" ng-if='document.type==\"photo\"' src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.urls.Preview ||  document.metadata.thumbnail_url || document.metadata.url}}'></div>\n        \n\n        <!-- <div class=\"thumbnail-image\" ng-if='document.type==\"rich\" || document.type==\"video\" || document.type==\"link\"' src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.thumbnail_url}}' ></div>\n         -->\n        <div class=\"thumbnail-image\" ng-if='document.type==\"image\"' src='{{\"images/spinner.gif\"|prefixTemplate}}' lazy-img='{{document.metadata.thumbnail_url || document.metadata.urls.Preview || document.snapshot}}'></div>\n        \n        <div class=\"thumbnail-embed\" ng-if='document.type == \"rich\" || document.type== \"video\"' rich-oembed autoplay='true' fullscreen='fullsize(document.slug, document._type)' enabled='item.isFocused' cover='document.snapshot || document.metadata.urls.Preview || document.metadata.thumbnail_url' oembed='document.metadata'></div>\n\n      </div>\n\n      \n\n\n      <div ng-if=\"item._type=='footnote'\" class=\"metadata footnote-wrapper\">\n        <button class='btn btn-line' ng-click='alignTo(item._index, $event)'>\n        <span>{{item.caption}}</span>\n        </button>\n        <span footnote='item.id' caption='item.caption' is-opened='true'></span>\n      </div>\n      <!-- <div ng-if=\"item.type=='image'\">\n        {{item.metadata}}\n      </div> -->\n      <div ng-if='item.metadata' ng-include='\"templates/partials/document.metadata.html\"|prefixTemplate'></div>\n    </div>\n  </div>\n</div>\n\n<div class='sliding-steps-direction bottom' ng-class='{\"active\":isMoreBottom}'>\n  <div class='btn-line-group'>\n    <button class=\"btn btn-line\" ng-click='next()'>\n      <span class=\"icon icon-arrow-down-circle\"></span>\n      <span translate='button.next'></span> \n    </button>\n  </div>\n</div>\n\n<div id='sliding-steps-line'></div>"),$templateCache.put("/static/templates/partials/modals/covers.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1051; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\" translate=\"modal.covers.title\"></h4></div>\n      \n      <div class=\"modal-body\">\n        <div class='section padded' style='padding-bottom: 0'>\n          <label>\n            <span translate='search'></span>{{isSomethingSelected}}\n            <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n          </label>\n          <input placeholder='....' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 200 }\" ng-change='suggest(query)'>\n        </div>\n\n        <ul class=\"nav nav-tabs\" style='margin-bottom: 20px; padding-left:15px;' role=\"tablist\">\n          <li role='presentation' ng-class='{\"active\": _tab.name == tab.name}' ng-repeat='_tab in tabs'>\n            <a ng-click='setTab(_tab.name)' translate='tab.{{_tab.name}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\"></a>\n          </li>\n        </ul>\n\n        <div>\n          <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n          <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n        </div>\n      </div>\n      <!-- eof body -->\n      <div class=\"modal-footer\">\n        <span class='btn-line-group' ng-class=\"{'primary':isSomethingSelected}\"><button type=\"button\" class=\"btn-line \" ng-class=\"{'active':isSomethingSelected}\" ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n      <!-- eof footer -->\n    </div>\n  </div>\n</div>"),$templateCache.put("/static/templates/partials/modals/fullsize.html","<div ng-class='fullsized.type' class=\"modal fullsize\"  tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div ng-click='$hide()' class='close'>\n  <span class='icon-close'></span>\n  </div>\n  <div ng-class='fullsized.type' class='oversize' style=''>\n    <div class=\"wrapper\">\n      <div class=\"header\">\n        <div class=\"inner\">\n          <h2 embedit='fullsized.metadata.title'></h2>\n          <div ng-init='document=fullsized' ng-include='\"templates/partials/document.metadata.linear.html\"|prefixTemplate''></div>\n        </div>\n      </div>\n      <div class=\"main\">\n        <div class=\"box sidebar\"></div>\n        <div class=\"box content\" ng-if='fullsized.type == \"photo\" || fullsized.type == \"image\" || fullsized.type == \"rich\" || fullsized.type == \"video\"'>\n          <div class='embedded' ng-if='fullsized.metadata.urls.Publishable || fullsized.attachment'>\n            <div class='image' lazy-image size='contain' src='fullsized.metadata.urls.Publishable || fullsized.attachment'></div>\n          </div>\n          <div class='embedded' ng-if='!fullsized.metadata.urls.Publishable && fullsized.metadata.html' stretch='true' embedit='fullsized.metadata.html'></div>\n          <div class='embedded' ng-if='!fullsized.metadata.urls.Publishable && fullsized.metadata.url && !fullsized.metadata.html'>\n            <div class='image' lazy-image size='contain' src='fullsized.metadata.url'></div>\n          </div>\n        </div>\n        <div class=\"box content\" ng-if='fullsized.type == \"text\"'>\n          <div class='embedded' stretch='true' embedit='fullsized.metadata.caption'></div>\n        </div>\n        \n        <div class=\"box sidebar\"></div>\n      </div>\n      <div class=\"footer\">\n        <div class='inner' >\n          <div ng-if='fullsized.metadata.copyright' class='text copyright' embedit='fullsized.metadata.copyright' language=\"language\" firstline='true'></div>\n        </div>\n      </div>\n    </div>\n  </div>\n</div>"),
$templateCache.put("/static/templates/partials/modals/mde-enrich.html","<div class=\"modal\" tabindex=\"-1\" role=\"dialog\" aria-hidden=\"true\" style=\"z-index: 1050; display: block;\">\n  <div class=\"modal-dialog\">\n    <div class=\"modal-content\">\n      <div class=\"modal-header\" ng-show=\"title\">\n      <button type=\"button\" class=\"close\" aria-label=\"Close\" ng-click=\"$hide()\">\n      <span aria-hidden=\"true\" class='icon-close'></span>\n      </button>\n      <h4 class=\"modal-title\">add resource</h4></div>\n      \n      <div class=\"modal-body\">\n\n        \n        <!-- <input type='text' class=\"form-control\" placeholder=\"search ...\"> -->\n        <ul class=\"nav nav-tabs\" style='padding-left:15px; margin-bottom:0' role=\"tablist\">\n          <li role='presentation' ng-class='{\"active\": _tab.name == tab.name}' ng-repeat='_tab in tabs'>\n            <a ng-click='setTab(_tab.name)' translate='tab.{{_tab.name}}' aria-controls=\"home\" role=\"tab\" data-toggle=\"tab\"></a>\n          </li>\n        </ul>\n\n        \n          <div ng-show=\"tab.name == 'favourite'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !lookups.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 450 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='document in tab.items' ng-include='\"templates/partials/embeds/document.html\"|prefixTemplate'></li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'glossary'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !glossary.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'><li ng-repeat='term in tab.items' ng-include='\"templates/partials/term.html\"|prefixTemplate'></li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'CVCE'\" class=\"tab-content\">\n            <div class='section padded' ng-class='{\"last\": !suggestResults.length}'>\n              <label>\n                <span translate='search'></span>\n                <span style='color: #b7b7b7' translate='results.amount' translate-values='{count: tab.count}'></span>\n              </label>\n              <input placeholder='...' class='form-control' type='text' ng-model='query' ng-model-options=\"{ debounce: 250 }\" ng-change='suggest(query)'>\n            </div>\n            <div class='section last'>\n              <ul class='list-of-documents'>\n                <li ng-repeat='document in tab.items' ng-include='\"templates/partials/oembed-search-results.html\"|prefixTemplate'>\n                </li>\n              </ul>\n              <div class='more-wrapper'>\n                <div ng-if='tab.items.length > 0 && tab.items.length < tab.count' class=\"btn-line-group primary\">\n                  <button class='btn-line' ng-click='more()'>\n                    <span ng-if='!tab.isLoadingNextItems'>\n                      <span translate='button.more'></span>\n                      <span translate='missing' translate-values=\"{count: tab.missing}\"></span>\n                    </span>\n                    <span ng-if='tab.isLoadingNextItems' translate='button.loading'></span>\n                  </button>\n                </div>\n                <!-- when count equals item length, we are at the end -->\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'url'\" class=\"tab-content\">\n            <div class='section padded'>\n              <label translate='url'></label>\n              <span style='color: #b7b7b7' translate='{{suggestMessage}}'></span>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea monospace\" rows=\"3\" msd-elastic ng-model='url' ng-change='previewUrl(url)' type='text' placeholder='http://'></textarea>\n              </div>\n              \n              \n\n              <div class='preview' ng-show='embed.provider_name' ng-class='embed.type'>\n                <!-- <div ng-if='embed.provider_name==\"CVCE\"' ng-include='\"templates/partials/embeds/cvce.html\"|prefixTemplate'></div> -->\n                <!-- <div ng-if='embed.provider_name==\"YouTube\"' ng-include='\"templates/partials/embeds/YouTube.html\"|prefixTemplate'></div> -->\n                <div ng-if='embed.provider_name==\"Flickr\"' ng-include='\"templates/partials/embeds/Flickr.html\"|prefixTemplate'></div>\n                <div ng-if='embed.provider_name==\"Ina.fr\"' ng-include='\"templates/partials/embeds/Ina.fr.html\"|prefixTemplate'></div>\n\n                <div ng-if='embed.type == \"link\"'>\n                  <p translate='enrich.url.noembedfound'></p>\n                  <div embedit='embed.description'></div>\n                </div>\n                <div ng-if='embed.type == \"rich\" || embed.type == \"video\"'>\n                  <div ng-if='embed.html' style='height: 200px; width: 100%' embedit='embed.html' stretch=\"true\"></div>\n                  <div ng-if='!embed.title' translate='enrich.type.notitle'></div>\n                </div>\n              </div>\n            </div>\n            <div class='section padded'>\n              <label>\n                <div translate='enrich.url.iframe.description'></div>\n                <span ng-if='!url' translate='enrich.url.embedRequiresUrl'></span><span ng-if='url && !isUrlValid' translate='enrich.url.notvalid'></span>\n              </label>\n              <div class='elastic-textarea-wrapper' ng-class='{\"disabled\": !isUrlValid}'>\n                <textarea class=\"elastic-textarea monospace limited\" ng-change='tab.onEmbedChange()' ng-disabled='!isUrlValid' rows=\"3\" msd-elastic  ng-model='embed.html' type='text' placeholder=''></textarea>\n              </div>\n            </div>\n            <div class='section padded'>\n              <label translate='title'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='embed.title' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded last'>\n              <label translate='bibtex reference'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea bibtex\" rows=\"3\" msd-elastic ng-model='reference' type='text' placeholder='@{}'></textarea>\n              </div>\n              <div class='sans-serif description' translate='bibtex.howto'></div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'upload'\" class=\"tab-content\">\n            <div class='section padded'>\n              <div class='drop-box-form-wrapper'>\n                <form name=\"createForm\" novalidate class=\"simple-form\">\n                  <div ng-show='!uploadablefile.size'>\n                    <div ngf-drop ngf-select ng-model=\"uploadable\" class=\"drop-box sans-serif\" \n                         ngf-drag-over-class=\"'dragover'\" ngf-multiple=\"false\" ngf-allow-dir=\"true\"\n                         accept=\"image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document\" \n                         ngf-pattern=\"'image/*,application/pdf,application/vnd.openxmlformats-officedocument.wordprocessingml.document'\"><span translate=\"drop.to.upload\"></span>\n                    </div>\n                  </div>\n                  <div class=\"uploadable\" ng-show='uploadablefile.size'>  \n                    <div ng-if='!uploadablefile.document'>\n                      <span>{{uploadablefile.name}}</span>\n                      <span>{{uploadablefile.type}}</span>\n                      <span>{{uploadablefile.size}}</span>\n                      <div class='btn-line-group'><a class='btn-line' ng-click='undo()' translate='button.undo'></a></div>\n                      \n                    </div>\n                    <div class=\"loading-bar\" style='width:{{uploadablefile.progressPercentage|| 0}}%'></div>\n                    \n                    <div class='doc-uploaded' ng-if='uploadablefile.document' ng-init='document=uploadablefile.document'>\n                      <div class=\"row\">\n                        <div class=\"col-sm-5\">\n                          <div class=\"cover\" style='height: 180px;' lazy-img='{{document.snapshot}}'></div>\n                        </div>\n                        <div class=\"col-sm-7\">\n                          <div class='title sans-serif' embedit='document.metadata.title'></div>\n                          <div class='copyright' embedit='document.metadata.copyright'></div>\n                        </div>\n                      </div>\n\n                    </div>\n                  </div>\n                </form>\n              </div>\n              <div ngf-no-file-drop><span translate='feature.unsupported.dragdrop'></span></div>\n            </div>\n            <!-- @todo -->\n            <div class='section padded' ng-show='!uploadablefile.document'>\n\n              <label translate='title'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='uploadablefile.title' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded' ng-show='!uploadablefile.document'>\n              <label translate='copyright'></label>\n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" rows=\"3\" msd-elastic ng-model='uploadablefile.copyright' type='text' placeholder='untitled'></textarea>\n              </div>\n            </div>\n            <div class='section padded last' ng-show='!uploadablefile.document'>\n              <label translate='bibtex reference'></label>\n              <div class='sans-serif description' translate='bibtex.howto'></div> \n              <div class='elastic-textarea-wrapper'>\n                <textarea class=\"elastic-textarea\" style='max-height: 200px;' rows=\"3\" msd-elastic ng-model='reference' type='text' placeholder='@{}'></textarea>\n              </div>\n              \n            </div>\n            <div class='section padded last center' ng-show='!uploadablefile.document'>\n              <div class='btn-line-group' ng-class='{\"primary\":uploadablefile.size}'>\n                <button class='btn-line' ng-click='upload()' translate='button.upload'></button>\n              </div>\n            </div>\n          </div>\n\n          <div ng-show=\"tab.name == 'iframe'\" class=\"tab-content\">\n            <!-- @todo -->\n          </div>\n\n          <div ng-show=\"tab.name == 'bibtex'\" class=\"tab-content\">\n            <span translate='bibtex.howto'></span>\n            <label translate='bibtex'></label>\n            <div class='elastic-textarea-wrapper'>\n              <textarea class=\"elastic-textarea\" style=\"font-family: monospace;\" rows=\"8\" msd-elastic ng-model='reference' type='text' placeholder='@BOOK {}'></textarea>\n            </div>\n          </div>\n          <div style='clear:both'></div>\n\n\n      </div>\n      <div class=\"modal-footer\">\n        <span class='btn-line-group' ng-class='{\"primary\": isSomethingSelected}'>\n          <button type=\"button\" class=\"btn-line\" ng-class='{\"active\": isSomethingSelected}' ng-click=\"addDocument(tab.name, contents, reference, url, embed)\" translate='button.add'></button>\n        </span>\n        <span class='btn-line-group'>\n        <button type=\"button\" class=\"btn-line\" ng-click=\"$hide()\">Close</button>\n        </span>\n      </div>\n    </div>\n  </div>\n</div>")}]);